
class Idb{constructor(e="kv_db",t="kv_store",r=1){this.idb_o=null,this.ready_o=null,this.idb_s=e,this.store_s=t,this.version_n=r,this.init__v()}init__v(){this.ready_o=new Promise(((e,t)=>{const r=window.indexedDB.open(this.idb_s,this.version_n);r.onupgradeneeded=e=>{this.idb_o=e.target.result,this.idb_o.createObjectStore(this.store_s)},r.onsuccess=t=>{this.idb_o=t.target.result,e(t.target.result)},r.onerror=e=>t(e.target.error)}))}store__o(e="readonly"){return this.idb_o.transaction([this.store_s],e).objectStore(this.store_s)}set__v(e,t){return this.ready_o.then((()=>new Promise(((r,o)=>{const _=this.store__o("readwrite").put(t,e);_.onsuccess=r,_.onerror=o}))))}update__v(e,t,r){return this.ready_o.then((()=>new Promise(((o,_)=>{const s=this.store__o("readwrite"),n=s.get(e);n.onsuccess=()=>{const a=n.result;a[t]=r;const i=s.put(a,e);i.onsuccess=o,i.onerror=_},n.onerror=_}))))}walk__v(e){return this.ready_o.then((()=>new Promise(((t,r)=>{const o=this.store__o().openCursor();o.onsuccess=r=>{let o=r.target.result;o?(e(o.key,o.value),o.continue()):t()},o.onerror=r}))))}get__(e){return this.ready_o.then((()=>new Promise(((t,r)=>{const o=this.store__o().get(e);o.onsuccess=e=>t(e.target.result),o.onerror=r}))))}key__b(e){return this.ready_o.then((()=>new Promise(((t,r)=>{const o=this.store__o().count(e);o.onsuccess=e=>t(e.target.result),o.onerror=r}))))}last__(){return this.ready_o.then((()=>new Promise(((e,t)=>{const r=this.store__o("readwrite").openCursor(null,"prev");r.onsuccess=t=>{t.target.result&&e(t.target.result.value)},r.onerror=t}))))}deleteAll__v(e){return this.ready_o.then((()=>new Promise(((t,r)=>{const o=this.store__o("readwrite"),_=store.openCursor();_.onsuccess=t=>{let r,_=t.target.result;_&&(r=_.value,e(r)&&o.delete(_.key),_.continue())},_.onerror=r}))))}delete__v(e){return this.ready_o.then((()=>new Promise(((t,r)=>{const o=this.store__o("readwrite").delete(e);o.onsuccess=t,o.onerror=r}))))}clear__v(){return this.ready_o.then((()=>new Promise(((e,t)=>{const r=this.store__o("readwrite").clear();r.onsuccess=e,r.onerror=t}))))}deleteIDB__v(){window.indexedDB.deleteDatabase(this.idb_s)}}const DATE_o={dataTimeNumeric__s(e=!0,t=(new Date).toISOString(),r="fr-FR"){let o=new Intl.DateTimeFormat(r,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format(new Date(t));return e&&(o=o.replaceAll("/","-").replaceAll(":","-").replaceAll(" ","_")),o}};UI_o={rangeVar__v(e,t){const r=e.value;e.dataset.tip=r,t&&DOM_o.rootVar__v(`--${t}`,r)}};const PAN_o={local_a:[],local_n:0,async index__n(){let e=0;return await PAN_o.idb_o.walk__v(((t,r)=>{JSON.parse(r);const o=r.order_n;o>e&&(e=o)})),e},order__n(){const e=+DOM_o.rootVar__s("--panorama_order_n")+1;return DOM_o.rootVar__v("--panorama_order_n",e),e},async show__v(){let e="",t=[];await PAN_o.idb_o.walk__v(((e,r)=>{t.push({key_s:e,value_o:JSON.parse(r)})})),t.sort(((e,t)=>e.value_o.order_n-t.value_o.order_n));for(let r of t){const t=r.value_o;let o,_;t.src_s?(o=t.src_s,_="<span data-ins=â‚‰><b data-local=1>Image locale</b><b>"+t.id_s+"</b></span>"):(o=`https://chercheurdart-2.netlify.app/assets/media/img/${r.key_s}.avif`,_=t.caption_s),e+=`<figure data-id="P${t.id_s}" data-display_b=${t.display_b} data-key_s="${r.key_s}"><img src="${o}" width="${t.width_s}" height="${t.height_s}" loading="lazy"><figcaption data-local>`+_+"</figcaption></figure>\n"}document.getElementById("DI_panorama_masonry").innerHTML=e,PAN_o.selectable__v()},select__v(e){if(e.ctrlKey)return;const t=e.target.closest("figure");t&&t.classList.toggle("selected")},async hide__v(){for(let e of Array.from(document.querySelectorAll("figure.selected"))){e.dataset.display_b=!1;const t=e.dataset.key_s;let r=await PAN_o.idb_o.get__(t);if(r){const e=JSON.parse(r);e.display_b=!e.display_b,PAN_o.idb_o.set__v(t,JSON.stringify(e)),PAN_o.show__v()}}},async group__v(){let e,t;for(let r of Array.from(document.querySelectorAll("figure.selected"))){if(!e){e=r.parentNode,t=r;continue}const o=e.removeChild(r);e.insertBefore(o,t.nextSibling),t=o}let r=[];for(let e of Array.from(document.querySelectorAll("#DI_panorama_masonry > figure"))){const t=e.dataset.key_s,o=await PAN_o.idb_o.get__(t),_=JSON.parse(o),s=PAN_o.order__n();_.order_n=s,r.push({key_s:t,value_s:JSON.stringify(_)}),PAN_o.idb_o.delete__v(t)}for(let e of r)PAN_o.idb_o.set__v(e.key_s,e.value_s)},remove__v(){for(let e of Array.from(document.querySelectorAll("figure.selected")))PAN_o.idb_o.delete__v(e.dataset.key_s),e.parentNode.removeChild(e)},async add__v(e){const t=e.target.closest("figure"),r=t.querySelector("img");let o=r.src;o=o.substring("https://chercheurdart-2.netlify.app/assets/media/img/".length,o.lastIndexOf("."));const _=t.id,s=document.querySelector("#G"+_.substring(2)+" figcaption");PAN_o.idb_o.set__v(o,JSON.stringify({id_s:_,order_n:PAN_o.order__n(),display_b:!0,caption_s:s.innerHTML,width_s:r.width,height_s:r.height})),PAN_o.show__v()},async local__v(){const e=await window.showOpenFilePicker({multiple:!0,types:[{description:"Image JPEG",accept:{"image/jpeg":[".jpg",".jpeg"]}}]});let t=[],r=PAN_o.local_n++,o="";for(let _ of e){const e=_.name.slice(0,_.name.lastIndexOf(".")),s=e.replaceAll("--","~"),n=`<figure data-id="P_${s}" data-display_b=true data-key_s="${e}"><img id="img_local_${r}" loading="lazy"><a href="#"></a><figcaption>${s}</figcaption></figure>\n`;t.push({id_s:e,local_n:r,file_o:_,caption_s:n}),o+=n}const _=document.getElementById("DI_panorama_masonry");let s=_.innerHTML;_.innerHTML=s+o;for(let e of t){const{id_s:t,local_n:r,caption_s:o,file_o:_}=e,s=document.querySelector(`#img_local_${r}`);if(s){const e=new FileReader;e.addEventListener("load",(()=>{s.src=e.result,PAN_o.idb_o.set__v(DATE_o.dataTimeNumeric__s(),JSON.stringify({id_s:t,order_n:PAN_o.order__n(),display_b:!0,caption_s:o,width_s:0,height_s:0,src_s:s.src}))}),!1);const r=await _.getFile();await e.readAsDataURL(r),s.parentNode.addEventListener("click",PAN_o.select__v)}}PAN_o.selectable__v()},rangeEvent__v(e){UI_o.rangeVar__v(e.target,"panorama_col_n")},selectable__v(){for(let e of Array.from(document.querySelectorAll("#DI_panorama_masonry > figure")))e.addEventListener("click",PAN_o.select__v)},listen__v(){for(let e of["hide","remove","group","local"]){const t=document.getElementById(`LA_panorama_${e}`);t&&t.addEventListener("click",PAN_o[`${e}__v`])}for(let e of Array.from(document.querySelectorAll('figure > label[data-legend="panorama"]')))e.addEventListener("click",PAN_o.add__v);DOM_o.rootVar__v("--panorama_n",PAN_o.index__n());for(let e of["col_n"])for(let t of["click","keydown"])DOM_o.listener__v(`IN_panorama_${e}`,PAN_o.rangeEvent__v,t);DOM_o.rootVar__v("--panorama_col_n","2")},init__v(){PAN_o.idb_o=new Idb("chercheurdart_idb","chercheurdart_store"),PAN_o.listen__v(),PAN_o.show__v()}};PAN_o.init__v();