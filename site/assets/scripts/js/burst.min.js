
const FUL_o={listener__v:()=>{const _=document.getElementById("goto_screen_full");_&&_.addEventListener("click",FUL_o.toggle__v)},toggle__v(){document.fullscreenElement&&document.exitFullscreen()||document.querySelector("body")?.requestFullscreen()}};UI_o={rangeVar__v(_,e){const t=_.value;_.dataset.tip=t,e&&DOM_o.rootVar__v(`--${e}`,t)},showSection__v(_){document.getElementById(_).checked=!0}};const DRAG_o={init__v(_){DRAG_o.drag_e=_,DRAG_o.atX_n=0,DRAG_o.atY_n=0,DRAG_o.toX_n=0,DRAG_o.toY_n=0,DRAG_o.gapX_n=0,DRAG_o.gapY_n=0},listener__v(_,e="remove"){for(let t of _)DRAG_o.drag_e[`${e}EventListener`](`mouse${t}`,DRAG_o[`${t}__v`],!1)},enable__v(){DRAG_o.disable_b=!1,DRAG_o.listener__v(["down"],"add")},disable__v(){DRAG_o.disable_b=!0,DRAG_o.listener__v(["down"],"remove")},down__v(_){_.preventDefault(),DRAG_o.disable_b||(DRAG_o.gapX_n=_.clientX-DRAG_o.atX_n,DRAG_o.gapY_n=_.clientY-DRAG_o.atY_n,DRAG_o.listener__v(["move","up"],"add"))},move__v(_){DRAG_o.disable_b||(DRAG_o.toX_n=_.clientX-DRAG_o.gapX_n,DRAG_o.toY_n=_.clientY-DRAG_o.gapY_n,DRAG_o.atX_n=DRAG_o.toX_n,DRAG_o.atY_n=DRAG_o.toY_n,requestAnimationFrame(DRAG_o.frame__v))},up__v(_){DRAG_o.disable_b||DRAG_o.listener__v(["move","up"])},frame__v(){DRAG_o.drag_e.style.transform=`translate3d(${DRAG_o.toX_n}px, ${DRAG_o.toY_n}px, 0) scale( var(--wheel_zoom_n) )`}},BUR_o={vScale_n:2,hue_n:0,atAngle_n:0,download_s:"",fullsize_n:1,freeze_b:!1,status_o:null,equal_a:null,atEqual_o:null,idb_o:null,trace_o:{},hue_o:{rangeY_n:1,shift_n:0},scale_o:{map_n:1,hue_n:1,sat_n:1,lum_n:1},thresh_o:{hi_n:100,lo_n:0},slot_o:{map:360,hue:360,sat:101,lum:101},slideshow_o:{play_b:!1,progress_n:0},eventKey_a:["ArrowUp","ArrowDown","+","-","f","d","p","a","s","r","q","v","z","e"," "],map_o:{slot_a:[]},message__v(_){switch(_.task_s){case"PUT_map":BUR_o.map_o.slot_a=_.slot_a,document.getElementById("burst_map_all_n").innerHTML=_.slot_a.length,document.getElementById("burst_map_all_ratio_n").innerHTML=new Intl.NumberFormat("fr-FR").format(Number.parseFloat(100*_.ratio_n).toFixed(3));break;case"PUT_rate":"map"===_.hsl_s&&(_.slot_a=BUR_o.map_o.slot_a),BUR_o.put_rate__v(_);break;case"PUT_equal":BUR_o.equal_a=_.equal_a;break;case"PUT_canvas_img":BUR_o.put_canvas_img__v(_);break;case"PUT_hue":BUR_o.put_hue__v(_);break;case"PUT_status":BUR_o.status_o=_.status_o;break;case"PUT_error":console.log(`ERROR: ${_.error_s}`)}},async saveFile__o(_,e){try{const t=e.replaceAll("~","--"),o=await window.showSaveFilePicker({suggestedName:t,types:[{accept:{"image/jpg":[".jpg"]}}]}),s=await o.createWritable();return await s.write(_),await s.close(),o}catch(_){console.error(_.name,_.message)}},put_rate__v(_){const{hsl_s:e,rate_n:t,slot_a:o,slot_n:s,capacity_n:a,equal_a:n}=_;let r;if("map"===e){if(BUR_o.atAngle_n>=o.length)return;r=o[BUR_o.atAngle_n].hue_n}else r=o[0],o.length>1&&(r+=`<b class=range-separator>&#8703;</b>${o[1]}`),document.getElementById("LA_burst_playback_progress").innerHTML=r,BUR_o.atEqual_o=n;BUR_o.trace_o[`${e}_e`].innerHTML=r;const l=t/a*100;BUR_o.trace_o[`${e}_ratio_e`].innerHTML=new Intl.NumberFormat("fr-FR").format(Number.parseFloat(l).toFixed(3)),BUR_o.freeze_b&&"hue"===e&&(BUR_o.slotHue__v(o),BUR_o.satLum__v())},slotHue__v(_){DOM_o.rootVar__v("--burst_img_slot_fromHue_n",_[0]),DOM_o.rootVar__v("--burst_img_slot_toHue_n",_[1])},put_hue__v(_){const e=_.hue_a;let t;if(e&&(BUR_o.slotHue__v(e),t=e[0],e[1]>e[0]+1&&(t+=`<b class=range-separator>&#8703;</b>${e[1]}`),BUR_o.slideshow_o.play_b)){const _=100/BUR_o.slot__n("hue"),e=document.getElementById("progress_burst_playback_progress");BUR_o.slideshow_o.progress_n+=_,e.value=BUR_o.slideshow_o.progress_n,document.getElementById("LA_burst_playback_progress").innerHTML=t}_?.stop_b&&(BUR_o.slideshow_o.play_b=!1)},async put_canvas_img__v(_){document.getElementById("dialog_burst_download").close(),BUR_o.saveFile__o(_.blob_o,BUR_o.download_s)},get_rate__v(_,e){const t=BUR_o.slot__n(e),o=BUR_o.angle__n(_,e,t);BUR_o.atAngle_n=o,BUR_o.worker_o.post__v({task_s:"GET_rate",stat_s:"burst",hsl_s:e,angle_n:o,slot_n:t})},async get_img__v(){const _=document.getElementById("CA_burst_hue_img");_.width=BUR_o.imgWidth_n,_.height=BUR_o.imgHeight_n;const e=_.transferControlToOffscreen(),t=.5*BUR_o.imgWidth_n,o=.5*BUR_o.imgHeight_n;BUR_o.worker_o.port_o.postMessage({task_s:"GET_img",stat_s:"burst",rect_s:`${t} ${o} ${BUR_o.imgWidth_n} ${BUR_o.imgHeight_n}`,scale_n:1,url_s:BUR_o.src_s,canvas_e:e,storeBitmap_b:!1,pixel_n:window.devicePixelRatio},[e])},hsl__s:()=>document?.querySelector('input[name="burst_nav"]:checked')?.id.slice(-3),locate__a(_,e){const t=.5*document.getElementById(`CA_burst_${e}`).width;return[_.offsetX-t,_.offsetY-t]},angle__n(_,e,t){document.getElementById(`CA_burst_${e}`),_.offsetX,_.offsetY;let o=_.offsetX,s=_.offsetY,a=0;if("map"===e){for(let _ of BUR_o.map_o.slot_a){if(o>=_.from_n&&o<_.from_n+_.width_n)return a;++a}return a}const n=.5*document.getElementById("CA_burst_hue").width;return o=_.offsetX-n,s=_.offsetY-n,a=~~(180*Math.atan2(s,o)/Math.PI),a=~~((a+450)%360/360*t),360===t&&(a=(a+BUR_o.hue_o.shift_n)%360),a},slot__n(_){let e=BUR_o.slot_o[_];if(360===e){if("map"===_)return e;let t=document.querySelector('li:has(input[name="burst_hue_slot"]:checked)');t&&(e=360/+t.dataset.slot_n)}return e},satLum__v(_){let e="none";document.querySelector('#UL_burst_hue_slot li[data-slot_n="1"] input:checked')&&(e="flex"),DOM_o.rootVar__v("--burst_satlum_s",e)},drawMap__v(){BUR_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"burst",hsl_s:"map",scale_n:BUR_o.scale_o.map_n})},draw__v(){for(let _ of["hue_back","hue_front"])BUR_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"burst",hsl_s:_,back_hue_n:+DOM_o.rootVar__s("--burst_hue_back"),rangeY_n:+BUR_o.hue_o.rangeY_n,shift_n:BUR_o.hue_o.shift_n,thresh_o:BUR_o.thresh_o})},opacity__n:()=>~~(+document.getElementById("IN_burst_hue_img_bg_opacity").value/100*255),pick__v(_,e,t="hue"){void 0===_&&(_=BUR_o.opacity__n()),void 0===e&&(e=BUR_o.atAngle_n),"map"===t&&(e=BUR_o.map_o.slot_a[BUR_o.atAngle_n].hue_n);const o=document.getElementById("CA_burst_hue_img");BUR_o.worker_o.post__v({task_s:"PUT_slot",stat_s:"burst",hsl_s:t,angle_n:e,range_n:360===e?0:BUR_o.slot__n(t),opacity_n:_,stack_b:BUR_o.stack_b,dim_a:[o.width,o.height]}),BUR_o.stack_b=!1},trace__v(_,e){let t,o;BUR_o.freeze_b=!BUR_o.freeze_b,BUR_o.freeze_b?(t="hsla( 210 11% 43%  /1)",o="cell"):(t="hsla( 210 11% 55%      /1)",o="var(--burst_trace_pointer_s)"),DOM_o.rootVar__v("--burst_trace_color",t),DOM_o.rootVar__v("--burst_trace_pointer",o);let s=document.querySelector('li:has(input[name="burst_hue_slot"]:checked)');if(s&&1==+s.dataset.slot_n)for(let _ of["sat","lum"])BUR_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"burst",hsl_s:_,back_hue_n:+BUR_o.trace_o.hue_e.innerHTML,shift_n:BUR_o.hue_o.shift_n,thresh_o:BUR_o.thresh_o});BUR_o.stack_b=_.ctrlKey,BUR_o.pick__v(void 0,void 0,e)},range__v(_,e){const t=_.id.includes("scale")?"burst_scale":"";UI_o.rangeVar__v(_,t),e&&e(_.id,_.value)},eventKey__v(_){if(!BUR_o.eventKey_a.includes(_.key))return;let e;switch(_.preventDefault(),_.key){case" ":BUR_o.eventImg_slideshow__v(_);break;case"ArrowUp":document.getElementById("IN_burst_hue_img_position").checked?document.getElementById("CA_burst_hue_img").classList.contains("fullsize")||BUR_o.eventSizeFull__v():document.getElementById("IN_burst_hue_img_position").checked=!0;break;case"ArrowDown":document.getElementById("CA_burst_hue_img").classList.contains("fullsize")?BUR_o.eventSizeTiny__v():document.getElementById("IN_burst_hue_img_position").checked&&(document.getElementById("IN_burst_hue_img_position").checked=!1);break;case"+":e=document.getElementById("IN_burst_dock_scale"),+e.value<+e.max&&(e.value=+e.value+ +e.step,BUR_o.eventRange__v({target:e}));break;case"-":e=document.getElementById("IN_burst_dock_scale"),+e.value>+e.min&&(e.value=+e.value-+e.step,BUR_o.eventRange__v({target:e}));break;case"z":_.ctrlKey&&BUR_o.eventImg_reset__v();break;case"e":_.ctrlKey&&BUR_o.eventImg_download__v(!1);break;case"f":FUL_o.toggle__v();break;case"d":case"p":case"a":case"r":case"s":case"q":case"v":const t={d:"dock_nav",p:"settings",a:"sequencer",s:"map",r:"hue",q:"equal",v:"hue_img"};let o="IN_";"d"!==_.key&&(o+="burst_"),o+=t[_.key],document.getElementById(o).checked=!document.getElementById(o).checked}},async eventRange__v(_){BUR_o.range__v(_.target,((e,t)=>{const o=BUR_o.hsl__s();switch(!0){case e.includes("scale"):if(BUR_o.scale_o[`${o}_n`]=+t,"map"===o)BUR_o.drawMap__v();else BUR_o.worker_o.post__v({task_s:"PUT_scale",stat_s:"burst",hsl_s:o,scale_n:BUR_o.scale_o[`${o}_n`],burst_b:!0}),DOM_o.rootVar__v("--burst_equal","none");break;case e.includes("thresh"):let s,a=+_.target.value;if(e.endsWith("hi")?(s="hi",a=100-a):s="lo",BUR_o.thresh_o[`${s}_n`]=a,BUR_o.thresh_o.hi_n<=BUR_o.thresh_o.lo_n)return DIA_o.open__v({LA:"Attention",PA:"Les seuils haut et bas s'entrecroisent",option_a:["accept"]}),await,void DIA_o.confirm__b();BUR_o.draw__v();break;case e.includes("opacity"):BUR_o.pick__v()}}))},eventSlot__v(_){const e=_.target.closest("li");e&&(BUR_o.hue_o.rangeY_n=+e.dataset.slot_n,BUR_o.draw__v(),BUR_o.satLum__v())},eventShift__v(_){_.preventDefault();const e=_.target.closest("label");if(e){const _=e.id.split("_")[2];let t=+document.getElementById(`output_burst_${_}`).value;t<+DOM_o.rootVar__s(`--burst_${_}_back`)&&(t=(t+360)%360),DOM_o.rootVar__v(`--burst_${_}_back`,t),DOM_o.rootVar__v(`--burst_${_}_trace`,-360*BUR_o.vScale_n),BUR_o.hue_o.shift_n=t,BUR_o.draw__v(),DOM_o.rootVar__v("--burst_img_hue",t)}},eventHsl__v(_){const[,,e]=_.target.id.split("_"),{offsetX:t,offsetY:o}=_,s=+o;DOM_o.rootVar__v(`--burst_${e}_trace`,-(360*BUR_o.vScale_n-s));const a=(~~(s/BUR_o.vScale_n)+BUR_o.hue_o.shift_n)%360;document.getElementById(`output_burst_${e}`).value=a},eventTrace__v(_){const e=BUR_o.hsl__s();BUR_o.freeze_b&&"hue"===e||(BUR_o.get_rate__v(_,e),"click"===_.type&&_.altKey&&BUR_o.eventEqual__v(_,e)),"click"!==_.type||"map"!==e&&"hue"!==e||BUR_o.trace__v(_,e)},eventEqual__v(_,e="hue"){if(BUR_o.atEqual_o){let{startX_n:_,startY_n:e}=BUR_o.atEqual_o;_-=.5*BUR_o.canvasWidth_n,e-=.5*BUR_o.canvasWidth_n;const t=2*Math.sqrt(_*_+e*e);let o=t<.1?"none":"block";DOM_o.rootVar__v("--burst_equal",o),DOM_o.rootVar__v("--burst_equal_scale",t/BUR_o.canvasWidth_n)}},eventImg_reset__v(){BUR_o.pick__v(255,360)},eventImg_download__v(_=!0){let e,t,o="transparent"!==DOM_o.rootVar__s("--burst_img_background");if(document.querySelector("#IN_burst_hue_img_position:checked"))t=!0,e="img";else for(let _ of["hue","sat","lum"])if(document.querySelector(`#IN_burst_${_}:checked`)){e=_;break}const s=DATE_o.dataTimeNumeric__s(),a=BUR_o.work_s+`_${s}`;let n;if(BUR_o.download_s=`${a}-${e}.jpg`,o){const _=window.getComputedStyle(document.getElementById("CA_burst_hue_img")).backgroundColor;n=_.substring("rgb(".length,_.length-1).split(", ")}_&&BUR_o.pick__v(),BUR_o.worker_o.post__v({task_s:"GET_canvas_img",stat_s:"burst",hsl_s:e,img_b:t,rgb_a:n});const r=document.getElementById("dialog_burst_download");document.getElementById("LA_burst_download").innerHTML=BUR_o.download_s,r.showModal()},eventImg_slideshow__v(_){let e,t,o,s,a,n;" "===_?.key?e="progress":(e=_.target.id,e=e.substring(e.lastIndexOf("_")+1));let r=document.getElementById("IN_burst_playback_step").checked;switch(e){case"start":if(BUR_o.slideshow_o.play_b)return;if(BUR_o.slideshow_o.play_b=!0,BUR_o.slideshow_o.progress_n=0,t=BUR_o.opacity__n(),n=document.getElementById("IN_burst_playback_backward").checked,o=+document.getElementById("IN_burst_playback_interval").value,r)o=0;else if(s=+document.getElementById("IN_burst_playback_shift").value,s&&!document.getElementById("IN_burst_playback_steady").checked){let _=o*s*.01;a=document.getElementById("IN_burst_playback_slower").checked?o+_:o-_}DOM_o.rootVar__v("--burst_playback_pause","wait");break;case"progress":if(!BUR_o.slideshow_o.play_b)return;o=r?0:6e5}BUR_o.worker_o.post__v({task_s:"PUT_slides",stat_s:"burst",id_s:e,interval_n:o,shift_n:s,limit_n:a,backward_b:n,step_b:r,opacity_n:t})},eventImg_background__v(_){const e=_.target.id;switch(!0){case e.includes("transparent"):DOM_o.rootVar__v("--burst_img_background","transparent");break;case e.includes("black"):DOM_o.rootVar__v("--burst_img_background","hsl( var(--burst_img_bg_hue) 0% 0% /1)");break;case e.includes("white"):DOM_o.rootVar__v("--burst_img_background","hsl( var(--burst_img_bg_hue) 100% 100% /1)");break;case e.includes("color"):DOM_o.rootVar__v("--burst_img_background","hsl( var(--burst_img_bg_hue) calc(var(--burst_img_bg_sat)  *1% ) calc(var(--burst_img_bg_lum)  *1%) /1)")}},eventInterval_range__v(_){const e=_.target;UI_o.rangeVar__v(e);let t=e.id;const o=t.slice(t.lastIndexOf("_")+1);DOM_o.rootVar__v(`--IN_burst_playback_${o}`,e.value)},eventImg_range__v(_){const e=_.target;UI_o.rangeVar__v(e);let t=e.id;const o=t.slice(t.lastIndexOf("_")+1);DOM_o.rootVar__v(`--burst_img_bg_${o}`,e.value),BUR_o.pick__v()},event_burstScale__v(_){const e=_.target.id,t=e.slice(e.lastIndexOf("_")+1),o=BUR_o.scale_o[`${t}_n`],s=document.getElementById("IN_burst_dock_scale");s.value=o,UI_o.rangeVar__v(s)},zoomable__v(){document.getElementById("CA_burst_hue_img").addEventListener("click",BUR_o.eventSizeFull__v)},eventZoom__v(){const _=document.getElementById("IN_toolset_zoom").checked?"Tiny":"Full";BUR_o[`eventSize${_}__v`]()},eventSizeFull__v(){const _=document.getElementById("CA_burst_hue_img");_.classList.contains("fullsize")||(_.classList.toggle("fullsize"),BUR_o.fullsize_n=+DOM_o.rootVar__s("--burst_hue_img_scale"),DOM_o.rootVar__v("--burst_hue_img_scale",1),DRAG_o.init__v(_),DRAG_o.enable__v(),DOM_o.rootVar__v("--burst_zoom_out_s","flex"),document.getElementById("IN_toolset_zoom").checked=!1)},eventSizeTiny__v(){const _=document.getElementById("CA_burst_hue_img");_.classList.contains("fullsize")&&(_.classList.toggle("fullsize"),DOM_o.rootVar__v("--burst_hue_img_scale",BUR_o.fullsize_n),DRAG_o.disable__v(),DOM_o.rootVar__v("--burst_zoom_out_s","none"))},listener__v(){for(let _ of["map","hue","sat","lum"]){for(let e of["click","mousemove"])document.getElementById(`CA_burst_${_}`)?.addEventListener(e,BUR_o.eventTrace__v);BUR_o.trace_o[`${_}_e`]=document.getElementById(`burst_${_}_n`),BUR_o.trace_o[`${_}_ratio_e`]=document.getElementById(`burst_${_}_ratio_n`)}for(let _ of["hue"])DOM_o.listener__v(`DI_burst_${_}_slot`,BUR_o.eventSlot__v),DOM_o.listener__v(`CA_burst_${_}_back`,BUR_o.eventHsl__v),DOM_o.listener__v(`CA_burst_${_}_back`,BUR_o.eventHsl__v,"mousemove"),DOM_o.listener__v(`LA_burst_${_}_trace`,BUR_o.eventShift__v);for(let _ of["reset","download"])document.querySelector(`[for=IN_burst_hue_img_${_}]`)?.addEventListener("click",BUR_o[`eventImg_${_}__v`]);for(let _ of["start","stop","reset"])DOM_o.listener__v(`LA_burst_playback_${_}`,BUR_o.eventImg_slideshow__v,"click",{passive:!0});DOM_o.listener__v("progress_burst_playback_progress",BUR_o.eventImg_slideshow__v,"click",{passive:!0}),document.body.addEventListener("keydown",BUR_o.eventKey__v,{passive:!1});let _=document.getElementById("IN_toolset_zoom");_&&_.addEventListener("change",BUR_o.eventZoom__v);for(let _ of["click","keydown"]){for(let e of["dock_scale","thresh_hi","thresh_lo","hue_img_bg_opacity"])DOM_o.listener__v(`IN_burst_${e}`,BUR_o.eventRange__v,_,{passive:!0});for(let e of["interval","shift"])DOM_o.listener__v(`IN_burst_playback_${e}`,BUR_o.eventInterval_range__v,_,{passive:!0});for(let e of["transparent","black","white","color"])document.querySelector(`[for=IN_burst_hue_img_bg_${e}]`)?.addEventListener(_,BUR_o.eventImg_background__v);for(let e of["hue","sat","lum"])DOM_o.listener__v(`IN_burst_hue_pick_${e}`,BUR_o.eventImg_range__v,_,{passive:!0});onresize=()=>BUR_o.scale__v()}for(let _ of["hue","sat","lum"])DOM_o.listener__v(`IN_burst_${_}`,BUR_o.event_burstScale__v);document.getElementById("goto_screen_full")&&FUL_o.listener__v(),BUR_o.zoomable__v()},screen__v(){DOM_o.rootVar__v("--burst_window_width",window.innerWidth);const _=+screen.availWidth,e=+screen.availHeight;let t=_>e?e:_;for(canvas_s of(t-=64,BUR_o.canvasWidth_n=t,DOM_o.rootVar__v("--burst_screen_dim",t),["map","hue","sat","lum"])){let _=document.getElementById(`CA_burst_${canvas_s}`);_&&"map"!==canvas_s&&(_.width=t,_.height=t)}},scale__v(){let _=BUR_o.imgHeight_n/window.innerHeight;_>.85&&(_=1/_*.85),DOM_o.rootVar__v("--burst_hue_img_scale",_),DOM_o.rootVar__v("--burst_hue_img_height",document.getElementById("aside_burst_hue_img").offsetHeight)},async src__v(){const _=JSON.parse(sessionStorage.getItem("burst"));BUR_o.src_s=_.src_s,BUR_o.imgWidth_n=_.width_s,BUR_o.imgHeight_n=_.height_s},async init__v(){await BUR_o.src__v(),BUR_o.screen__v(),BUR_o.worker_o=STAT_o.worker__o("burst",["map","hue","sat","lum","hue_back","hue_front"],"LogScale Painter ColorBurst",BUR_o.message__v);const _=BUR_o.hsl__s();BUR_o.worker_o.post__v({task_s:"PUT_scale",stat_s:"burst",hsl_s:_,scale_n:BUR_o.scale_o.hue_n,burst_b:!1}),BUR_o.drawMap__v(),BUR_o.draw__v(),BUR_o.worker_o.post__v({task_s:"GET_equal",stat_s:"burst",hsl_s:"hue"}),BUR_o.listener__v(),BUR_o.get_img__v(),BUR_o.scale__v()}};BUR_o.init__v();