
const DATE_o={dataTimeNumeric__s(_=!0,e=(new Date).toISOString(),t="fr-FR"){let o=new Intl.DateTimeFormat(t,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format(new Date(e));return _&&(o=o.replaceAll("/","-").replaceAll(":","-").replaceAll(" ","_")),o}},FUL_o={listener__v:()=>{const _=document.getElementById("goto_full_screen");_&&_.addEventListener("click",(()=>document.fullscreenElement&&document.exitFullscreen()||document.querySelector("body")?.requestFullscreen()))}};UI_o={rangeVar__v(_,e){const t=_.value;_.dataset.tip=t,e&&DOM_o.rootVar__v(`--${e}`,t)}};const BUR_o={vScale_n:2,hue_n:0,freeze_b:!1,status_o:null,trace_o:{},hue_o:{rangeY_n:1,shift_n:0},scale_o:{hue_n:1,sat_n:1,lum_n:1},thresh_o:{hi_n:100,lo_n:0},slot_o:{hue:360,sat:101,lum:101},level_a:null,atLevel_o:null,atAngle_n:0,download_s:"",slideshow_o:{speed_a:[0,400,1e3,2e3],play_b:!1},message__v(_){switch(_.task_s){case"PUT_rate":BUR_o.put_rate__v(_);break;case"PUT_level":BUR_o.level_a=_.level_a;break;case"PUT_canvas_img":BUR_o.put_canvas_img__v(_);break;case"PUT_hue":BUR_o.put_hue__v(_);break;case"PUT_status":BUR_o.status_o=_.status_o;break;case"PUT_error":console.log(`ERROR: ${_.error_s}`)}},async saveFile__o(_,e){try{const t=e.replaceAll("~","--"),o=await window.showSaveFilePicker({suggestedName:t,types:[{accept:{"image/jpg":[".jpg"]}}]}),s=await o.createWritable();return await s.write(_),await s.close(),o}catch(_){console.error(_.name,_.message)}},put_rate__v(_){const{hsl_s:e,rate_n:t,slot_a:o,capacity_n:s,level_a:r}=_;BUR_o.atLevel_o=r;let a=o[0];o.length>1&&(a+=`<b class=range-separator>&#8703;</b>${o[1]}`),document.getElementById("{C_o.LABEL_ID_s}}_burst_img_control_bgcolor").innerHTML=a,BUR_o.trace_o[`${e}_e`].innerHTML=a;const n=t/s*100;BUR_o.trace_o[`${e}_ratio_e`].innerHTML=new Intl.NumberFormat("fr-FR").format(Number.parseFloat(n).toFixed(3)),BUR_o.freeze_b&&"hue"===e&&(BUR_o.slotHue__v(o),BUR_o.satLum__v())},slotHue__v(_){DOM_o.rootVar__v("--burst_img_slot_fromHue_n",_[0]),DOM_o.rootVar__v("--burst_img_slot_toHue_n",_[1])},put_hue__v(_){const e=_.hue_a;let t;e?(BUR_o.slotHue__v(e),t=`${e[0]}<b class=range-separator>&#8703;</b>${e[1]}`):(t="complet",BUR_o.slideshow_o.play_b=!1),document.getElementById("{C_o.LABEL_ID_s}}_burst_img_control_bgcolor").innerHTML=t},async put_canvas_img__v(_){const{blob_o:e}=_;BUR_o.saveFile__o(e,BUR_o.download_s)},get_rate__v(_,e){const t=BUR_o.slot__n(e),o=BUR_o.angle__n(_,t);BUR_o.atAngle_n=o,BUR_o.worker_o.post__v({task_s:"GET_rate",stat_s:"burst",hsl_s:e,angle_n:o,slot_n:t})},getImage(){const _=document.getElementById("CA_burst_hue_img");_.width=BUR_o.imgWidth_n,_.height=BUR_o.imgHeight_n;const e=_.transferControlToOffscreen(),t=.5*BUR_o.imgWidth_n,o=.5*BUR_o.imgHeight_n;BUR_o.work_s=document.body.dataset.work_s,BUR_o.worker_o.port_o.postMessage({task_s:"GET_img",stat_s:"burst",rect_s:`${t} ${o} ${BUR_o.imgWidth_n} ${BUR_o.imgHeight_n}`,scale_n:1,url_s:LOC_o.localKey_s||`/assets/media/img/${BUR_o.work_s}/full/max/0/color.jpeg`,canvas_e:e,storeBitmap_b:!1,pixel_n:window.devicePixelRatio},[e])},hsl__s:()=>document?.querySelector('input[name="burst_nav"]:checked')?.id.slice(-3),locate__a(_,e){const t=.5*document.getElementById(`CA_burst_${e}`).width;return[_.offsetX-t,_.offsetY-t]},angle__n(_,e){const t=.5*document.getElementById("CA_burst_hue").width,o=_.offsetX-t,s=_.offsetY-t;let r=~~(180*Math.atan2(s,o)/Math.PI);return r=~~((r+450)%360/360*e),360===e&&(r=(r+BUR_o.hue_o.shift_n)%360),r},slot__n(_){let e=BUR_o.slot_o[_];if(360===e){let _=document.querySelector('li:has(input[name="burst_hue_slot"]:checked)');_&&(e=360/+_.dataset.slot_n)}return e},satLum__v(_){let e="none";document.querySelector('#UL_burst_hue_slot li[data-slot_n="1"] input:checked')&&(e="flex"),DOM_o.rootVar__v("--burst_satlum_s",e)},draw__v(){for(let _ of["hue_back","hue_front"])BUR_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"burst",hsl_s:_,back_hue_n:+DOM_o.rootVar__s("--burst_hue_back"),rangeY_n:+BUR_o.hue_o.rangeY_n,shift_n:BUR_o.hue_o.shift_n,thresh_o:BUR_o.thresh_o})},pick__v(_,e,t="hue"){if(void 0===_){_=~~(+document.getElementById("IN_burst_hue_img_bg_opacity").value/100*255)}void 0===e&&(e=BUR_o.atAngle_n);const o=document.getElementById("CA_burst_hue_img");BUR_o.worker_o.post__v({task_s:"PUT_slot",stat_s:"burst",hsl_s:t,angle_n:e,range_n:360===e?0:BUR_o.slot__n(t),opacity_n:_,dim_a:[o.width,o.height]})},trace__v(_,e){let t,o;BUR_o.freeze_b=!BUR_o.freeze_b,BUR_o.freeze_b?(t="hsla( 190 28% 37.75% /1)",o="cell"):(t="hsla( 190 28% 62.25% /.6)",o="var(--burst_trace_pointer_s)"),DOM_o.rootVar__v("--burst_trace_color",t),DOM_o.rootVar__v("--burst_trace_pointer",o);let s=document.querySelector('li:has(input[name="burst_hue_slot"]:checked)');if(s&&1==+s.dataset.slot_n)for(let _ of["sat","lum"])BUR_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"burst",hsl_s:_,back_hue_n:+BUR_o.trace_o.hue_e.innerHTML,shift_n:BUR_o.hue_o.shift_n,thresh_o:BUR_o.thresh_o});BUR_o.pick__v()},range__v(_,e){const t=_.id.includes("scale")?"burst_scale":"";UI_o.rangeVar__v(_,t),e&&e(_.id,_.value)},eventRange__v(_){BUR_o.range__v(_.target,((e,t)=>{const o=BUR_o.hsl__s();switch(!0){case e.includes("scale"):BUR_o.scale_o[`${o}_n`]=+t,BUR_o.worker_o.post__v({task_s:"PUT_scale",stat_s:"burst",hsl_s:o,scale_n:BUR_o.scale_o[`${o}_n`],burst_b:!0}),DOM_o.rootVar__v("--burst_level","none");break;case e.includes("thresh"):let s,r=+_.target.value;if(e.endsWith("hi")?(s="hi",r=100-r):s="lo",BUR_o.thresh_o[`${s}_n`]=r,BUR_o.thresh_o.hi_n<=BUR_o.thresh_o.lo_n)return void alert("Les seuils haut et bas se croisent");BUR_o.draw__v();break;case e.includes("opacity"):BUR_o.pick__v()}}))},eventSlot__v(_){const e=_.target.closest("li");e&&(BUR_o.hue_o.rangeY_n=+e.dataset.slot_n,BUR_o.draw__v(),BUR_o.satLum__v())},eventShift__v(_){_.preventDefault();const e=_.target.closest("label");if(e){const _=e.id.split("_")[2];let t=+document.getElementById(`output_burst_${_}`).value;t<+DOM_o.rootVar__s(`--burst_${_}_back`)&&(t=(t+360)%360),DOM_o.rootVar__v(`--burst_${_}_back`,t),DOM_o.rootVar__v(`--burst_${_}_trace`,-360*BUR_o.vScale_n),BUR_o.hue_o.shift_n=t,BUR_o.draw__v(),DOM_o.rootVar__v("--burst_img_hue",t)}},eventHsl__v(_){const[,,e]=_.target.id.split("_"),{offsetX:t,offsetY:o}=_,s=+o;DOM_o.rootVar__v(`--burst_${e}_trace`,-(360*BUR_o.vScale_n-s));const r=(~~(s/BUR_o.vScale_n)+BUR_o.hue_o.shift_n)%360;document.getElementById(`output_burst_${e}`).value=r},eventTrace__v(_){const e=BUR_o.hsl__s();BUR_o.freeze_b&&"hue"===e||(BUR_o.get_rate__v(_,e),"click"===_.type&&_.ctrlKey&&BUR_o.eventLevel__v(_,e)),"click"===_.type&&"hue"===e&&BUR_o.trace__v(_,e)},eventLevel__v(_,e="hue"){if(BUR_o.atLevel_o){let{startX_n:_,startY_n:e}=BUR_o.atLevel_o;_-=.5*BUR_o.canvasWidth_n,e-=.5*BUR_o.canvasWidth_n;const t=2*Math.sqrt(_*_+e*e);let o=t<.1?"none":"block";DOM_o.rootVar__v("--burst_level",o),DOM_o.rootVar__v("--burst_level_scale",t/BUR_o.canvasWidth_n)}},eventImg_reset__v(){BUR_o.pick__v(255,360)},eventImg_download__v(){const _=DATE_o.dataTimeNumeric__s(),e=BUR_o.work_s+`_${_}`;BUR_o.download_s=`${e}.jpg`,BUR_o.pick__v(),BUR_o.worker_o.post__v({task_s:"GET_canvas_img",stat_s:"burst"})},eventImg_slideshow__v(_){let e,t=0;BUR_o.slideshow_o.play_b||(t=BUR_o.slideshow_o.speed_a[+_.target.closest("li").dataset.speed_n],e=~~(+document.getElementById("IN_burst_hue_img_bg_opacity").value/100*255)),BUR_o.worker_o.post__v({task_s:"PUT_slideshow",stat_s:"burst",speed_n:t,opacity_n:e}),BUR_o.slideshow_o.play_b=!BUR_o.slideshow_o.play_b},eventImg_background__v(_){const e=_.target.htmlFor;switch(!0){case e.includes("black"):DOM_o.rootVar__v("--burst_img_background","hsl( var(--burst_img_bg_hue) 0% 0% /1)");break;case e.includes("white"):DOM_o.rootVar__v("--burst_img_background","hsl( var(--burst_img_bg_hue) 100% 100% /1)");break;case e.includes("color"):DOM_o.rootVar__v("--burst_img_background","hsl( var(--burst_img_bg_hue) calc(var(--burst_img_bg_sat)  *1% ) calc(var(--burst_img_bg_lum)  *1%) /1)");break;case e.includes("picker"):DOM_o.rootVar__v("--burst_img_picker",!0)}},eventImg_range__v(_){const e=_.target,t=e.value;e.dataset.tip=t;let o=e.id;const s=o.slice(o.lastIndexOf("_")+1);DOM_o.rootVar__v(`--burst_img_bg_${s}`,t),BUR_o.pick__v()},event_colorBurst__v(_){const e=_.target.id,t=e.slice(e.lastIndexOf("_")+1),o=document.getElementById("IN_burst_dock_scale"),s=BUR_o.scale_o[`${t}_n`];o.value=s,o.dataset.tip=s,DOM_o.rootVar__v("--burst_scale",s)},listener__v(){for(let _ of["hue","sat","lum"]){for(let e of["click","mousemove"])document.getElementById(`CA_burst_${_}`)?.addEventListener(e,BUR_o.eventTrace__v);BUR_o.trace_o[`${_}_e`]=document.getElementById(`burst_${_}_n`),BUR_o.trace_o[`${_}_ratio_e`]=document.getElementById(`burst_${_}_ratio_n`)}for(let _ of["hue"])DOM_o.listener__v(`DI_burst_${_}_slot`,BUR_o.eventSlot__v),DOM_o.listener__v(`CA_burst_${_}_back`,BUR_o.eventHsl__v),DOM_o.listener__v(`CA_burst_${_}_back`,BUR_o.eventHsl__v,"mousemove"),DOM_o.listener__v(`LA_burst_${_}_trace`,BUR_o.eventShift__v);for(let _ of["reset","download"])document.querySelector(`[for=IN_burst_hue_img_${_}]`)?.addEventListener("click",BUR_o[`eventImg_${_}__v`]);document.getElementById("UL_burst_hue_img_slideshow")?.addEventListener("click",BUR_o.eventImg_slideshow__v);for(let _ of["click","keydown"]){for(let e of["dock_scale","thresh_hi","thresh_lo","hue_img_bg_opacity"])DOM_o.listener__v(`IN_burst_${e}`,BUR_o.eventRange__v,_,{passive:!0});for(let e of["black","white","color"])document.querySelector(`[for=IN_burst_hue_img_bg_${e}]`)?.addEventListener(_,BUR_o.eventImg_background__v);for(let e of["hue","sat","lum"])DOM_o.listener__v(`IN_burst_hue_pick_${e}`,BUR_o.eventImg_range__v,_,{passive:!0});onresize=()=>BUR_o.placeImage__v()}for(let _ of["hue","sat","lum"])DOM_o.listener__v(`IN_burst_${_}`,BUR_o.event_colorBurst__v);for(node_s of["full_screen","page_top","burst_level"])DOM_o.beforeNode__e(document.getElementById("DI_burst_layer_dock"),`goto_${node_s}`);document.getElementById(`goto_${node_s}`)&&FUL_o.listener__v()},screen__v(){const _=+screen.availWidth,e=+screen.availHeight;let t=_>e?e:_;for(canvas_s of(t-=64,BUR_o.canvasWidth_n=t,DOM_o.rootVar__v("--burst_screen_dim",t),["hue","sat","lum"])){let _=document.getElementById(`CA_burst_${canvas_s}`);_&&(_.width=t,_.height=t)}},placeImage__v(){let _=BUR_o.imgHeight_n/window.innerHeight;_>.85&&(_=1/_*.85),DOM_o.rootVar__v("--burst_hue_img_scale",_),DOM_o.rootVar__v("--burst_hue_img_height",document.getElementById("aside_burst_hue_img").offsetHeight)},async imgDim__v(){let _,e;const t=await LOC_o.search__("JSON");if(t){_=t.width_s,e=t.height_s,document.getElementById("{C_o.LABEL_ID_s}}_burst_img_control_bgcolor").innerHTML;const o=document.querySelector("h1+p");o&&(o.innerHTML=key_s)}else[_,e]=document.body.dataset.wh_s.split("_");BUR_o.imgWidth_n=+_,BUR_o.imgHeight_n=+e},async init__v(){await BUR_o.imgDim__v(),BUR_o.screen__v(),BUR_o.worker_o=STAT_o.worker__o("burst",["hue","sat","lum","hue_back","hue_front"],"LogScale Painter ColorBurst",BUR_o.message__v),BUR_o.worker_o.post__v({task_s:"PUT_scale",stat_s:"burst",hsl_s:"hue",scale_n:BUR_o.scale_o.hue_n,burst_b:!1}),BUR_o.draw__v(),BUR_o.worker_o.post__v({task_s:"GET_level",stat_s:"burst",hsl_s:"hue"}),BUR_o.listener__v(),BUR_o.getImage(),BUR_o.placeImage__v()}};BUR_o.init__v();