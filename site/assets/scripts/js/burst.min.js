
class Idb{constructor(e="kv_db",_="kv_store",t=1){this.idb_o=null,this.ready_o=null,this.idb_s=e,this.store_s=_,this.version_n=t,this.init__v()}init__v(){this.ready_o=new Promise(((e,_)=>{const t=window.indexedDB.open(this.idb_s,this.version_n);t.onupgradeneeded=e=>{this.idb_o=e.target.result,this.idb_o.createObjectStore(this.store_s)},t.onsuccess=_=>{this.idb_o=_.target.result,e(_.target.result)},t.onerror=e=>_(e.target.error)}))}store__o(e="readonly"){return this.idb_o.transaction([this.store_s],e).objectStore(this.store_s)}set__v(e,_){return this.ready_o.then((()=>new Promise(((t,o)=>{const s=this.store__o("readwrite").put(_,e);s.onsuccess=t,s.onerror=o}))))}update__v(e,_,t){return this.ready_o.then((()=>new Promise(((o,s)=>{const r=this.store__o("readwrite"),n=r.get(e);n.onsuccess=()=>{const a=n.result;a[_]=t;const l=r.put(a,e);l.onsuccess=o,l.onerror=s},n.onerror=s}))))}walk__v(e){return this.ready_o.then((()=>new Promise(((_,t)=>{const o=this.store__o().openCursor();o.onsuccess=t=>{let o=t.target.result;o?(e(o.key,o.value),o.continue()):_()},o.onerror=t}))))}get__(e){return this.ready_o.then((()=>new Promise(((_,t)=>{const o=this.store__o().get(e);o.onsuccess=e=>_(e.target.result),o.onerror=t}))))}key__b(e){return this.ready_o.then((()=>new Promise(((_,t)=>{const o=this.store__o().count(e);o.onsuccess=e=>_(e.target.result),o.onerror=t}))))}last__(){return this.ready_o.then((()=>new Promise(((e,_)=>{const t=this.store__o("readwrite").openCursor(null,"prev");t.onsuccess=_=>{_.target.result&&e(_.target.result.value)},t.onerror=_}))))}deleteAll__v(e){return this.ready_o.then((()=>new Promise(((_,t)=>{const o=this.store__o("readwrite"),s=store.openCursor();s.onsuccess=_=>{let t,s=_.target.result;s&&(t=s.value,e(t)&&o.delete(s.key),s.continue())},s.onerror=t}))))}delete__v(e){return this.ready_o.then((()=>new Promise(((_,t)=>{const o=this.store__o("readwrite").delete(e);o.onsuccess=_,o.onerror=t}))))}clear__v(){return this.ready_o.then((()=>new Promise(((e,_)=>{const t=this.store__o("readwrite").clear();t.onsuccess=e,t.onerror=_}))))}deleteIDB__v(){window.indexedDB.deleteDatabase(this.idb_s)}}const DATE_o={dataTimeNumeric__s(e=!0,_=(new Date).toISOString(),t="fr-FR"){let o=new Intl.DateTimeFormat(t,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format(new Date(_));return e&&(o=o.replaceAll("/","-").replaceAll(":","-").replaceAll(" ","_")),o}},FUL_o={listener__v:()=>{const e=document.getElementById("goto_full_screen");e&&e.addEventListener("click",(()=>document.fullscreenElement&&document.exitFullscreen()||document.querySelector("body")?.requestFullscreen()))}};UI_o={rangeVar__v(e,_){const t=e.value;e.dataset.tip=t,_&&DOM_o.rootVar__v(`--${_}`,t)}};const BUR_o={vScale_n:2,hue_n:0,freeze_b:!1,status_o:null,trace_o:{},hue_o:{rangeY_n:60,shift_n:0},scale_o:{hue_n:.5,sat_n:.5,lum_n:.5},thresh_o:{hi_n:100,lo_n:0},slot_o:{hue:360,sat:101,lum:101},level_a:null,atLevel_o:null,atAngle_n:0,download_s:"",message__v(e){switch(e.task_s){case"PUT_rate":BUR_o.put_rate__v(e);break;case"PUT_level":BUR_o.level_a=e.level_a;break;case"PUT_canvas_img":BUR_o.put_canvas_img__v(e);break;case"PUT_status":BUR_o.status_o=e.status_o;break;case"PUT_error":console.log(`ERROR: ${e.error_s}`)}},async saveFile__o(e,_){try{const t=_.replaceAll("~","--"),o=await window.showSaveFilePicker({suggestedName:t,types:[{accept:{"image/jpg":[".jpg"]}}]}),s=await o.createWritable();return await s.write(e),await s.close(),o}catch(e){console.error(e.name,e.message)}},put_rate__v(e){const{hsl_s:_,rate_n:t,slot_a:o,capacity_n:s,level_a:r}=e;BUR_o.atLevel_o=r;let n=o[0];o.length>1&&(n+=`<b class=range-separator>&#8703;</b>${o[1]}`),BUR_o.trace_o[`${_}_e`].innerHTML=n;const a=t/s*100;BUR_o.trace_o[`${_}_ratio_e`].innerHTML=new Intl.NumberFormat("fr-FR").format(Number.parseFloat(a).toFixed(3))},async put_canvas_img__v(e){const{blob_o:_}=e;BUR_o.saveFile__o(_,BUR_o.download_s)},get_rate__v(e,_){const t=BUR_o.slot__n(_),o=BUR_o.angle__n(e,t);BUR_o.atAngle_n=o,BUR_o.worker_o.post__v({task_s:"GET_rate",stat_s:"burst",hsl_s:_,angle_n:o,slot_n:t})},get_img(){let e=BUR_o.work_s;const[_,t]=document.querySelector("body").dataset.wh_s.split("_"),o=document.getElementById("CA_burst_hue_img");o.width=+_,o.height=+t;const s=o.transferControlToOffscreen(),r=.5*+_,n=.5*+t;BUR_o.worker_o.port_o.postMessage({task_s:"GET_img",stat_s:"burst",rect_s:`${r} ${n} ${_} ${t}`,scale_n:1,url_s:`/assets/media/img/${e}/full/max/0/color.jpeg`,canvas_e:s,storeBitmap_b:!1,pixel_n:window.devicePixelRatio},[s])},hsl__s:()=>document?.querySelector('input[name="burst_nav"]:checked')?.id.slice(-3),locate__a(e,_){const t=.5*document.getElementById(`CA_burst_${_}`).width;return[e.offsetX-t,e.offsetY-t]},angle__n(e,_){const t=.5*document.getElementById("CA_burst_hue").width,o=e.offsetX-t,s=e.offsetY-t;let r=~~(180*Math.atan2(s,o)/Math.PI);return r=~~((r+450)%360/360*_),360===_&&(r=(r+BUR_o.hue_o.shift_n)%360),r},slot__n(e){let _=BUR_o.slot_o[e];if(360===_){let e=document.querySelector('li:has(input[name="burst_hue_slot"]:checked)');e&&(_=360/+e.dataset.slot_n)}return _},draw__v(){for(let e of["hue_back","hue_front"])BUR_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"burst",hsl_s:e,back_hue_n:+DOM_o.rootVar__s("--burst_hue_back"),rangeY_n:+BUR_o.hue_o.rangeY_n,shift_n:BUR_o.hue_o.shift_n,thresh_o:BUR_o.thresh_o})},pick__v(e,_,t="hue"){if(void 0===e){e=~~(+document.getElementById("IN_burst_hue_img_bg_opacity").value/100*255)}void 0===_&&(_=BUR_o.atAngle_n);const o=document.getElementById("CA_burst_hue_img");BUR_o.worker_o.post__v({task_s:"PUT_slot",stat_s:"burst",hsl_s:t,angle_n:_,range_n:360===_?0:BUR_o.slot__n(t),opacity_n:e,dim_a:[o.width,o.height]})},trace__v(e,_){let t,o;BUR_o.freeze_b=!BUR_o.freeze_b,BUR_o.freeze_b?(t="hsla( 190 28% 37.75% /1)",o="cell"):(t="hsla( 190 28% 62.25% /.6)",o="var(--burst_trace_pointer_s)"),DOM_o.rootVar__v("--burst_trace_color",t),DOM_o.rootVar__v("--burst_trace_pointer",o);let s=document.querySelector('li:has(input[name="burst_hue_slot"]:checked)');if(s&&1==+s.dataset.slot_n)for(let e of["sat","lum"])BUR_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"burst",hsl_s:e,back_hue_n:+BUR_o.trace_o.hue_e.innerHTML,shift_n:BUR_o.hue_o.shift_n,thresh_o:BUR_o.thresh_o});BUR_o.pick__v()},range__v(e,_){const t=e.id.includes("scale")?"burst_scale":"";UI_o.rangeVar__v(e,t),_&&_(e.id,e.value)},eventRange__v(e){BUR_o.range__v(e.target,((_,t)=>{const o=BUR_o.hsl__s();switch(!0){case _.includes("scale"):BUR_o.scale_o[`${o}_n`]=+t,BUR_o.worker_o.post__v({task_s:"PUT_scale",stat_s:"burst",hsl_s:o,scale_n:BUR_o.scale_o[`${o}_n`],burst_b:!0}),DOM_o.rootVar__v("--burst_level","none");break;case _.includes("thresh"):let s,r=+e.target.value;if(_.endsWith("hi")?(s="hi",r=100-r):s="lo",BUR_o.thresh_o[`${s}_n`]=r,BUR_o.thresh_o.hi_n<=BUR_o.thresh_o.lo_n)return void alert("Les seuils haut et bas se croisent");BUR_o.draw__v()}}))},eventSlot__v(e){const _=e.target.closest("li");_&&(BUR_o.hue_o.rangeY_n=+_.dataset.slot_n,BUR_o.draw__v())},eventShift__v(e){e.preventDefault();const _=e.target.closest("label");if(_){const e=_.id.split("_")[2];let t=+document.getElementById(`output_burst_${e}`).value;t<+DOM_o.rootVar__s(`--burst_${e}_back`)&&(t=(t+360)%360),DOM_o.rootVar__v(`--burst_${e}_back`,t),DOM_o.rootVar__v(`--burst_${e}_trace`,-360*BUR_o.vScale_n),BUR_o.hue_o.shift_n=t,BUR_o.draw__v(),DOM_o.rootVar__v("--burst_img_hue",t)}},eventHsl__v(e){const[,,_]=e.target.id.split("_"),{offsetX:t,offsetY:o}=e,s=+o;DOM_o.rootVar__v(`--burst_${_}_trace`,-(360*BUR_o.vScale_n-s));const r=(~~(s/BUR_o.vScale_n)+BUR_o.hue_o.shift_n)%360;document.getElementById(`output_burst_${_}`).value=r},eventTrace__v(e){const _=BUR_o.hsl__s();BUR_o.freeze_b&&"hue"===_||(BUR_o.get_rate__v(e,_),"click"===e.type&&e.ctrlKey&&BUR_o.eventLevel__v(e,_)),"click"===e.type&&"hue"===_&&BUR_o.trace__v(e,_)},eventLevel__v(e,_){if(BUR_o.atLevel_o){let{startX_n:e,startY_n:_}=BUR_o.atLevel_o;e-=.5*BUR_o.canvasWidth_n,_-=.5*BUR_o.canvasWidth_n;const t=2*Math.sqrt(e*e+_*_);let o=t<.1?"none":"block";DOM_o.rootVar__v("--burst_level",o),DOM_o.rootVar__v("--burst_level_scale",t/BUR_o.canvasWidth_n)}},eventImg_reset__v(){BUR_o.pick__v(255,360)},eventImg_download__v(){const e=DATE_o.dataTimeNumeric__s(),_=BUR_o.work_s+`_${e}`;BUR_o.download_s=`${_}.jpg`,BUR_o.pick__v(),BUR_o.worker_o.post__v({task_s:"GET_canvas_img",stat_s:"burst"})},eventImg_background__v(e){const _=e.target.htmlFor;switch(!0){case _.includes("black"):DOM_o.rootVar__v("--burst_img_backgroud","hsl( var(--burst_img_bg_hue) 0% 0% /1)");break;case _.includes("white"):DOM_o.rootVar__v("--burst_img_backgroud","hsl( var(--burst_img_bg_hue) 100% 100% /1)");break;case _.includes("color"):DOM_o.rootVar__v("--burst_img_backgroud","hsl( var(--burst_img_bg_hue) calc(var(--burst_img_bg_sat)  *1% ) calc(var(--burst_img_bg_lum)  *1%) /1)");break;case _.includes("picker"):DOM_o.rootVar__v("--burst_img_picker",!0)}},eventImg_range__v(e){const _=e.target,t=_.value;_.dataset.tip=t;let o=_.id;const s=o.slice(o.lastIndexOf("_")+1);DOM_o.rootVar__v(`--burst_img_bg_${s}`,t)},listener__v(){for(let e of["hue","sat","lum"]){for(let _ of["click","mousemove"])document.getElementById(`CA_burst_${e}`)?.addEventListener(_,BUR_o.eventTrace__v);BUR_o.trace_o[`${e}_e`]=document.getElementById(`burst_${e}_n`),BUR_o.trace_o[`${e}_ratio_e`]=document.getElementById(`burst_${e}_ratio_n`)}for(let e of["hue"])DOM_o.listener__v(`DI_burst_${e}_slot`,BUR_o.eventSlot__v),DOM_o.listener__v(`CA_burst_${e}_back`,BUR_o.eventHsl__v),DOM_o.listener__v(`CA_burst_${e}_back`,BUR_o.eventHsl__v,"mousemove"),DOM_o.listener__v(`LA_burst_${e}_trace`,BUR_o.eventShift__v);for(let e of["reset","download"])document.querySelector(`[for=IN_burst_hue_img_${e}]`)?.addEventListener("click",BUR_o[`eventImg_${e}__v`]);for(let e of["click","keydown"]){for(let _ of["view_scale","thresh_hi","thresh_lo","hue_img_bg_opacity"])DOM_o.listener__v(`IN_burst_${_}`,BUR_o.eventRange__v,e,{passive:!0});for(let _ of["black","white","color"])document.querySelector(`[for=IN_burst_hue_img_bg_${_}]`)?.addEventListener(e,BUR_o.eventImg_background__v);for(let _ of["hue","sat","lum"])DOM_o.listener__v(`IN_burst_hue_pick_${_}`,BUR_o.eventImg_range__v,e,{passive:!0})}for(node_s of["full_screen","page_top","burst_level"])DOM_o.beforeNode__e(document.getElementById("DI_burst_layer_view"),`goto_${node_s}`);document.getElementById(`goto_${node_s}`)&&FUL_o.listener__v()},screen__v(){const e=+screen.availWidth,_=+screen.availHeight;let t=e>_?_:e;for(canvas_s of(t-=64,BUR_o.canvasWidth_n=t,DOM_o.rootVar__v("--burst_screen_dim",t),["hue","sat","lum"])){let e=document.getElementById(`CA_burst_${canvas_s}`);e&&(e.width=t,e.height=t)}},init__v(){const e=document.querySelector("body");BUR_o.work_s=e.dataset.work_s;const[_,t]=e.dataset.wh_s.split("_");BUR_o.imgWidth_n=+_,BUR_o.imgHeight_n=+t,BUR_o.screen__v(),BUR_o.worker_o=STAT_o.worker__o("burst",["hue","sat","lum","hue_back","hue_front"],"LogScale Painter ColorBurst",BUR_o.message__v),BUR_o.worker_o.post__v({task_s:"PUT_scale",stat_s:"burst",hsl_s:"hue",scale_n:BUR_o.scale_o.hue_n,burst_b:!1}),BUR_o.draw__v(),BUR_o.worker_o.post__v({task_s:"GET_level",stat_s:"burst",hsl_s:"hue"}),BUR_o.idb_o=new Idb("chercheurdart_idb","chercheurdart_store"),BUR_o.listener__v(),BUR_o.get_img()}};BUR_o.init__v();