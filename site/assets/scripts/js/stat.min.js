



//=== WorkerClient.js
class WorkerClient
{
  constructor
  (
    worker_o    //: { url_s, client_s, handleMessage__v }
  )
  {
    this
      .url_s =
        worker_o
          .url_s

    this
      .client_s =
        worker_o
          .client_s

    this
      .handleMessage__v =
        worker_o
          .handleMessage__v

    this
      .port_o = null

    this
      .init__v()
}



  init__v
  ()
  {
    const shared_o =
      new SharedWorker ( this.url_s )

    this
      .port_o =
        shared_o
          .port

    this
      .port_o
        .onerror =
          this
            .error__v
  
    this
      .port_o
        .onmessage =
          msg_o =>      //: can't use this.message__v directly
            this
              .message__v
              (
                 msg_o
                   .data
              )
  }



  error__v
  (
    error_o
  )
  {
    console
      .log`ERROR: ${error_o.message}`
  }



  message__v
  (
    payload_o    //: data: { client_s, task_s, ... }
  )
  {
    if
    (                    //: filter msg for clients
      ! payload_o
        .client_s    //: CLIENT_ALL_s
      ||
      (
        payload_o
          .client_s
        ===
        this
          .client_s
      )
    )
    {
      this
        .handleMessage__v( payload_o )
    }

  }



  post__v      //!!! can't use this method for offscreenCanvas transfer
  (
    payload_o
  )
  {
    this
      .port_o
        .postMessage( payload_o )
  }
}
//=== stat.js
const STAT_o =
{
  worker_o: null,



  //=== FUNCTIONS ===
  elementDim__n
  (
    selector_s,
    dim_s='width'    //: 'width' (default) || 'height'
  )
  {
    return (
      +( window            //: number cast
        .getComputedStyle
        (
          document
            .querySelector( selector_s )
        )
        [ dim_s ]
          .slice
          (
            0,
            -2     //: skip ending 'px'
          )
        )
      )

  }
  ,



  canvas__e    //!!! 4. from section
  (
    section_s,
    id_s
  )
  {
    const section_e =
      document
        .querySelector( `#${section_s}` )
  
    const canvas_e =
      document
        .createElement( 'canvas' )
  
    canvas_e
      .id =
        `canvas_${section_s}_${id_s}`

    let dim_n =
      ~~'2048'  //: number cast
      *
      window
        .devicePixelRatio
  
    canvas_e
      .width =
        dim_n
  
    canvas_e
      .height =
        dim_n
  
    const div_e =
      section_e
        .querySelector( `#DI_${section_s}` )
  
    div_e
      .insertBefore
      (
        canvas_e,
        div_e
          .querySelector( `script` )
      )
  
    return canvas_e
  }
  ,



  //=== WORK ===
  message__v    //!!! 2. from stat_w.js
  (
    payload_o
  )
  {
    switch
    (
      payload_o
        .task_s
    )
    {
      //-- case 'PUT_scan':      //: { task_s, msg_s }
      //-- 
      //--   break
    
      default:
        break
    }
  }
  ,
  

  
  worker__o    //!!! 4. from section
  (
    section_s,
    message__v,
    script_s
  )
  {
    const worker_o =
      new WorkerClient
      (
        {
          url_s: '/assets/scripts/js/stat_w.min.js',
          client_s:  section_s,
          handleMessage__v: message__v
        }
      )

    switch
    (
      section_s
    )
    {
      case 'burst':
        for
        (
          let id_s
          of
          [
            'hue',
            'sat',
            'lum'
          ]
        )
        {
          const canvas_e =
            STAT_o
              .canvas__e
              (
                section_s,
                id_s
              )
          
          const offCanvas_e =
            canvas_e
              .transferControlToOffscreen()
          
          worker_o            //! using port postMessage directly
            .port_o           //! to avoid error:
              .postMessage    //! 'OffscreenCanvas could not be cloned because it was not transferred'
              (
                {
                  client_s:   section_s,
                  id_s:       id_s,
                  script_s:   script_s,
                  task_s:     'PUT_canvas',
                  pixel_n:    window.devicePixelRatio,
                  canvas_e:   offCanvas_e
                },
                [ offCanvas_e ]
              )

          }
            
        break;
    
      default:
        break;
    }

    return worker_o
  }
  ,



  adopt__v    //!!! 3. from listener__v
  (
    stat_s
  )
  {
    if        //: iframe still there: not yet adopted
    (
      document
        .getElementById( `IF_${stat_s}` )
    )
    {
      IND_o
        .adopt__v
        (
          stat_s,                //!!! section id=stat_s
          `IF_${stat_s}`,
          (
            iframe_e,    //: not used
            adopted_e
          ) =>
          {
            const script_e =
              adopted_e
                .querySelector( `#script_${stat_s}` )
  
            if
            (
              script_e
            )
            {
              script_e
                .src =
                script_e
                  .dataset
                    .src
            }
          }
        )
    }
  }
  ,


  scanner__v
  ()
  {
    const img_e =
      document
        .querySelector( `img[src$="/full/max/0/color.jpeg"]` )    //: TODO change to jpeg

    ;console.log( img_e )

    if
    (
      img_e
    )
    {


      return  //.........
      STAT_o
        .worker_o
          .post__v
          (
            { 
              client_s: 'stat',
              task_s: 'GET_scan',
              work_s: work_s
            }
          )
    }
  }
  ,



  listener__v
  ()
  {
    for
    (
      let stat_s
      of
      [
        'burst',
        'aster',
        'paint',
      ]
    )
    {
      const listen_e =
        document
          .getElementById( `LA_${stat_s}` )
          
      listen_e
      &&
      listen_e
        .addEventListener
        (
          'click',
          () =>
            STAT_o
              .adopt__v( stat_s ),
          {
            once: true
          }
        )
    }
  }
  ,



  init__v    //!!! 1. from index.js
  (
    work_s
  )
  {
    STAT_o
      .worker_o =
        new WorkerClient
        (
          {
            url_s: '/assets/scripts/js/stat_w.min.js',
            client_s:  'stat',
            handleMessage__v: STAT_o.message__v
          }
        )

    STAT_o
      .worker_o
        .post__v
        (
          { 
            client_s: 'stat',
            task_s: 'GET_scan',
            work_s: work_s
          }
        )

    //XX STAT_o
    //XX   .scanner__v()
  }
  ,
}


STAT_o
  .listener__v()
