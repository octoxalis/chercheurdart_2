
const DATE_o={dataTimeNumeric__s(e=!0,t=(new Date).toISOString(),_="fr-FR"){let o=new Intl.DateTimeFormat(_,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format(new Date(t));return e&&(o=o.replaceAll("/","-").replaceAll(":","-").replaceAll(" ","_")),o}};UI_o={rangeVar__v(e,t){const _=e.value;e.dataset.tip=_,t&&DOM_o.rootVar__v(`--${t}`,_)}};const DRAG_o={init__v(e){DRAG_o.drag_e=e,DRAG_o.atX_n=0,DRAG_o.atY_n=0,DRAG_o.toX_n=0,DRAG_o.toY_n=0,DRAG_o.gapX_n=0,DRAG_o.gapY_n=0},listen__v(e,t="remove"){for(let _ of e)DRAG_o.drag_e[`${t}EventListener`](`mouse${_}`,DRAG_o[`${_}__v`],!1)},enable__v(){DRAG_o.disable_b=!1,DRAG_o.listen__v(["down"],"add")},disable__v(){DRAG_o.disable_b=!0,DRAG_o.listen__v(["down"],"remove")},down__v(e){e.preventDefault(),DRAG_o.disable_b||(DRAG_o.gapX_n=e.clientX-DRAG_o.atX_n,DRAG_o.gapY_n=e.clientY-DRAG_o.atY_n,DRAG_o.listen__v(["move","up"],"add"))},move__v(e){DRAG_o.disable_b||(DRAG_o.toX_n=e.clientX-DRAG_o.gapX_n,DRAG_o.toY_n=e.clientY-DRAG_o.gapY_n,DRAG_o.atX_n=DRAG_o.toX_n,DRAG_o.atY_n=DRAG_o.toY_n,requestAnimationFrame(DRAG_o.frame__v))},up__v(e){DRAG_o.disable_b||DRAG_o.listen__v(["move","up"])},frame__v(){DRAG_o.drag_e.style.transform=`translate3d(${DRAG_o.toX_n}px, ${DRAG_o.toY_n}px, 0)`}},EXP_o={local_a:[],local_n:0,full_e:null,order__n(){const e=+DOM_o.rootVar__s("--expo_order_n")+1;return DOM_o.rootVar__v("--expo_order_n",e),e},async collect__a(){let e=[];return await LOC_o.idb_o.walk__v(((t,_)=>{e.push({key_s:t,value_o:JSON.parse(_)})})),e.sort(((e,t)=>e.value_o.order_n-t.value_o.order_n)),e},selectable__v(){for(let e of Array.from(document.querySelectorAll("#DI_expo_masonry > figure > figcaption")))e.addEventListener("click",EXP_o.select__v)},selected__(e=!0,t=!0,_=!1){let o="figure";t&&(o+=".selected");const a=Array.from(document.querySelectorAll(o));let n;switch(!0){case!a.length:n="Cette opération ne peut être appliquée sans sélection préalable";break;case!_&&(a.length>1||!a[0].querySelector("img").src.startsWith("data:image/jpeg;base64")):n="Cette opération ne peut être appliquée qu'à une seule image locale"}if(!n)return _?a:a[0];window.alert(n)},zoomable__v(){for(let e of Array.from(document.querySelectorAll("[data-fullsize_b]")))e.addEventListener("click",EXP_o.sizeEventFull__v)},async show__v(){let e="";for(let t of await EXP_o.collect__a()){const _=t.value_o;let o,a;_.src_s?(o=_.src_s,a=_.caption_b?_.caption_s:"<span data-ins=₉><b data-local=1>image locale</b><b>"+_.id_s+"</b></span>"):(o=`https://chercheurdart-2.netlify.app/assets/media/img/${t.key_s}.avif`,a=_.caption_s),e+=`<figure data-id="E${_.id_s}" data-display_b=${_.display_b} data-key_s="${t.key_s}"><img src="${o}" width="${_.width_s}" height="${_.height_s}" loading="lazy" data-fullsize_b=true><figcaption data-local>`+a+"</figcaption></figure>\n"}document.getElementById("DI_expo_masonry").innerHTML=e,EXP_o.selectable__v(),EXP_o.zoomable__v()},select__v(e){if(e.ctrlKey)return void e.preventDefault();const t=e.target.closest("figure");t&&t.classList.toggle("selected")},selectAll__v(e){let t=e.target.checked?"remove":"add";for(let e of Array.from(document.querySelectorAll("figure")))e.classList[t]("selected")},async hide__v(){for(let e of Array.from(document.querySelectorAll("figure.selected"))){e.dataset.display_b=!1;const t=e.dataset.key_s;let _=await LOC_o.idb_o.get__(t);if(_){const e=JSON.parse(_);e.display_b=!e.display_b,LOC_o.idb_o.set__v(t,JSON.stringify(e)),EXP_o.show__v()}}},async group__v(){let e,t;for(let _ of Array.from(document.querySelectorAll("figure.selected"))){if(!e){e=_.parentNode,t=_;continue}const o=e.removeChild(_);e.insertBefore(o,t.nextSibling),t=o}let _=[];for(let e of Array.from(document.querySelectorAll("#DI_expo_masonry > figure"))){const t=e.dataset.key_s,o=await LOC_o.idb_o.get__(t),a=JSON.parse(o),n=EXP_o.order__n();a.order_n=n,_.push({key_s:t,value_s:JSON.stringify(a)}),LOC_o.idb_o.delete__v(t)}for(let e of _)LOC_o.idb_o.set__v(e.key_s,e.value_s)},remove__v(){if(!window.confirm("Cette opération va remplacer les images de l'exposition courante qui sont sélectionnées<br>Souhaitez-vous continuer?"))return!1;for(let e of EXP_o.selected__(!1,!0,!0))LOC_o.idb_o.delete__v(e.dataset.key_s),e.parentNode.removeChild(e);return!0},async local__v(){const e=await window.showOpenFilePicker({multiple:!0,types:[{description:"Image JPEG",accept:{"image/jpeg":[".jpg",".jpeg"]}}]});let t=[],_=EXP_o.local_n++,o="";for(let a of e){const e=a.name.slice(0,a.name.lastIndexOf(".")),n=e.replaceAll("--","~"),l=`<figure data-id="E_${n}" data-display_b=true data-key_s="${e}"><img id="img_local_${_}" loading="lazy"><a href="#"></a><figcaption>${n}</figcaption></figure>\n`;t.push({id_s:e,local_n:_,file_o:a,caption_s:l}),o+=l}const a=document.getElementById("DI_expo_masonry");let n=a.innerHTML;a.innerHTML=n+o;for(let e of t){const{id_s:t,local_n:_,caption_s:o,file_o:a}=e,n=document.querySelector(`#img_local_${_}`);if(n){const e=new FileReader;e.addEventListener("load",(()=>{n.src=e.result,n.addEventListener("load",(()=>{LOC_o.idb_o.set__v(DATE_o.dataTimeNumeric__s(),JSON.stringify({id_s:t,order_n:EXP_o.order__n(),display_b:!0,caption_s:o,width_s:n.naturalWidth,height_s:n.naturalHeight,src_s:n.src}))}))}),!1);const _=await a.getFile();await e.readAsDataURL(_),n.parentNode.addEventListener("click",EXP_o.select__v),n.addEventListener("click",EXP_o.sizeEventFull__v)}}},caption__v(){if(EXP_o.selected__()){document.getElementById("dialog_expo_caption").showModal()}},burst__v(){const e=EXP_o.selected__();if(e){const t=e.dataset.key_s;location.href=`local--burst.html?k=${t}`}},async store__v(){const e=window.confirm("Voulez-vous sauvegarder uniquement les images sélectionnées?");let t=await EXP_o.selected__(!1,e,!0);if(t)try{const e=[];for(let _ of t){const t=_.dataset.key_s;e.push({key_s:t,value_s:await LOC_o.idb_o.get__(t)})}const _=JSON.stringify(e),o=await window.showSaveFilePicker({suggestedName:DATE_o.dataTimeNumeric__s()+"-expo.json",types:[{accept:{"application/json":[".json"]}}]}),a=await o.createWritable();await a.write(_),await a.close()}catch(e){console.log(`ERROR DETECTED @expo.js: ${e}`)}},async restore__v(){if(!EXP_o.remove__v())return;const e=await window.showOpenFilePicker({multiple:!1,types:[{description:"fichier JSON",accept:{"application/json":[".json"]}}]});if(!e)return;let t=e[0],_=new FileReader;_.onload=async()=>{const e=JSON.parse(_.result);for(let t of e)LOC_o.idb_o.set__v(t.key_s,t.value_s);EXP_o.show__v()},_.onerror=()=>{console.log(_.error)},_.readAsText(await t.getFile())},async captionEvent__v(e){const t=e.target.id,_=document.getElementById("dialog_expo_caption");switch(!0){case t.endsWith("cancel"):_.close();break;case t.endsWith("reset"):for(let e of document.querySelectorAll("input[id^=IN_expo_caption_][type=text]"))e.value="";break;case t.endsWith("accept"):const e=EXP_o.selected__();if(e){const t={};for(let e of Array.from(document.querySelectorAll("input[id^=IN_expo_caption_][type=text]"))){const _="IN_expo_caption_".length;t[`${e.id.substring(_)}`]=e.value||""}let o=`<span data-ins=₉><b>${t.artist_s}</b>`;const a=t.link_s;o+=a?`<b><a href="${a}">${t.subject_s}</a></b>`:`<b>${t.subject_s}</b>`,o+=`<b>${t.year_n}</b><b><i>${t.w_height_n}</i><i>${t.w_width_n}</i></b><b>${t.location_s}</b><b>${t.place_s}`,o+=t.place_s?" ∙ ":"",o+=`${t.country_s}</b></span>`;const n=e.dataset.key_s;let l=await LOC_o.idb_o.get__(n);if(l){const e=JSON.parse(l);e.caption_s=o,e.caption_b=!0,LOC_o.idb_o.set__v(n,JSON.stringify(e)),EXP_o.show__v(),_.close()}}}},rangeEvent__v(e){UI_o.rangeVar__v(e.target,"expo_wrap_n")},sizeEventFull__v(e){EXP_o.full_e||(EXP_o.full_e=e.target,"false"!==EXP_o.full_e.parentNode.dataset.display_b&&(EXP_o.full_e.classList.toggle("fullsize"),DRAG_o.init__v(EXP_o.full_e),DRAG_o.enable__v(),DOM_o.rootVar__v("--expo_zoom_out_s","flex")))},sizeEventTiny__v(){EXP_o.full_e.classList.toggle("fullsize"),DRAG_o.disable__v(),DOM_o.rootVar__v("--expo_zoom_out_s","none"),EXP_o.full_e.setAttribute("style",""),EXP_o.full_e=null},listen__v(){DOM_o.rootVar__v("--expo_wrap_n","5"),document.getElementById("LA_expo_zoom_out").addEventListener("click",EXP_o.sizeEventTiny__v),document.getElementById("IN_expo_selectAll").addEventListener("change",EXP_o.selectAll__v);for(let e of["hide","remove","group","local","caption","store","restore","burst"]){const t=document.getElementById(`LA_expo_${e}`);t&&t.addEventListener("click",EXP_o[`${e}__v`])}for(let e of["cancel","reset","accept"]){const t=document.getElementById(`IN_expo_caption_${e}`);t&&t.addEventListener("change",EXP_o.captionEvent__v)}for(let e of["wrap_n"])for(let t of["click","keydown"])DOM_o.listener__v(`IN_expo_${e}`,EXP_o.rangeEvent__v,t)},init__v(){EXP_o.listen__v(),EXP_o.show__v()}};EXP_o.init__v();