
const FUL_o={listener__v:()=>{const e=document.getElementById("goto_screen_full");e&&e.addEventListener("click",FUL_o.toggle__v)},toggle__v(){document.fullscreenElement&&document.exitFullscreen()||document.querySelector("body")?.requestFullscreen()}};UI_o={rangeVar__v(e,t){const _=e.value;e.dataset.tip=_,t&&DOM_o.rootVar__v(`--${t}`,_)},showSection__v(e){document.getElementById(e).checked=!0}};const DRAG_o={init__v(e){DRAG_o.drag_e=e,DRAG_o.atX_n=0,DRAG_o.atY_n=0,DRAG_o.toX_n=0,DRAG_o.toY_n=0,DRAG_o.gapX_n=0,DRAG_o.gapY_n=0},listener__v(e,t="remove"){for(let _ of e)DRAG_o.drag_e[`${t}EventListener`](`mouse${_}`,DRAG_o[`${_}__v`],!1)},enable__v(){DRAG_o.disable_b=!1,DRAG_o.listener__v(["down"],"add")},disable__v(){DRAG_o.disable_b=!0,DRAG_o.listener__v(["down"],"remove")},down__v(e){e.preventDefault(),DRAG_o.disable_b||(DRAG_o.gapX_n=e.clientX-DRAG_o.atX_n,DRAG_o.gapY_n=e.clientY-DRAG_o.atY_n,DRAG_o.listener__v(["move","up"],"add"))},move__v(e){DRAG_o.disable_b||(DRAG_o.toX_n=e.clientX-DRAG_o.gapX_n,DRAG_o.toY_n=e.clientY-DRAG_o.gapY_n,DRAG_o.atX_n=DRAG_o.toX_n,DRAG_o.atY_n=DRAG_o.toY_n,requestAnimationFrame(DRAG_o.frame__v))},up__v(e){DRAG_o.disable_b||DRAG_o.listener__v(["move","up"])},frame__v(){DRAG_o.drag_e.style.transform=`translate3d(${DRAG_o.toX_n}px, ${DRAG_o.toY_n}px, 0) scale( var(--wheel_zoom_n) )`}},EXP_o={add_a:[],add_n:0,full_e:null,eventKey_a:[,"3","+","-","f","d","i","x","m","g","c","s","o","b"],async collect__a(){let e=[];return await IDB_o.idb_o.walk__v(((t,_)=>{e.push({key_s:t,value_o:JSON.parse(_)})})),e.sort(((e,t)=>e.value_o.order_n-t.value_o.order_n)),e},async show__v(){let e="";for(let t of await EXP_o.collect__a()){const _=t.value_o,o=_.caption_s.startsWith("<span data-ins")?_.caption_s:"<span data-ins=₉><b data-add=1>image locale</b><b>"+_.id_s+"</b></span>";e+=`<figure data-id="E${_.id_s}" data-display_b=${_.display_b} data-key_s="${t.key_s}"><img src="${_.src_s}" width="${_.width_s}" height="${_.height_s}" loading="lazy" data-fullsize_b=true><figcaption data-add>`+o+"</figcaption></figure>\n"}document.getElementById("DI_masonry").innerHTML=e,EXP_o.selectable__v(),EXP_o.zoomable__v()},order__n(){const e=+DOM_o.rootVar__s("--expo_order_n")+1;return DOM_o.rootVar__v("--expo_order_n",e),e},zoomable__v(){for(let e of Array.from(document.querySelectorAll("[data-fullsize_b]")))e.addEventListener("click",EXP_o.eventSizeFull__v)},selectable__v(){for(let e of Array.from(document.querySelectorAll("#DI_masonry > figure > figcaption")))e.addEventListener("click",EXP_o.select__v)},select__v(e){if(e.ctrlKey)return void e.preventDefault();const t=e.target.closest("figure");t&&t.classList.toggle("selected")},selectAll__v(e){let t=e.target.checked?"remove":"add";for(let e of Array.from(document.querySelectorAll("figure")))e.classList[t]("selected")},async selected__(e=!0,t=!0,_=!1){let o="figure";t&&(o+=".selected");const a=Array.from(document.querySelectorAll(o));let n;switch(!0){case!a.length:n="Cette opération ne peut être appliquée sans sélection préalable";break;case!_&&a.length>1:n="Cette opération ne peut être appliquée qu'à une seule image importée"}return n?(DIA_o.open__v({LA:"Attention",PA:n,option_a:["accept"]}),void await DIA_o.confirm__b()):_?a:a[0]},async add__v(){const e=await window.showOpenFilePicker({multiple:!0,types:[{description:"Image JPEG",accept:{"image/jpeg":[".jpg",".JPG",".jpeg",".JPEG"]}}]});let t=[],_=EXP_o.add_n++,o="";for(let a of e){const e=a.name.slice(0,a.name.lastIndexOf(".")),n=e.replaceAll("--","~"),s="LOC:"+DATE_o.dataTimeNumeric__s(),r=`<figure data-id="E_${n}" data-display_b=true data-key_s="${s}"><img id="img_import_${_}" loading="lazy"><a href="#"></a><figcaption>${n}</figcaption></figure>\n`;t.push({id_s:e,key_s:s,add_n:_,file_o:a,caption_s:r}),o+=r}const a=document.getElementById("DI_masonry");let n=a.innerHTML;a.innerHTML=n+o;for(let e of t){const{id_s:t,key_s:_,add_n:o,file_o:a,caption_s:n}=e,s=document.querySelector(`#img_import_${o}`);if(s){const e=new FileReader;e.addEventListener("load",(()=>{s.src=e.result,s.addEventListener("load",(()=>{IDB_o.idb_o.set__v(_,JSON.stringify({id_s:t,order_n:EXP_o.order__n(),display_b:!0,caption_s:n,width_s:s.naturalWidth,height_s:s.naturalHeight,src_s:s.src}))}))}),!1);const o=await a.getFile();await e.readAsDataURL(o),s.parentNode.addEventListener("click",EXP_o.select__v),s.addEventListener("click",EXP_o.eventSizeFull__v)}}},async remove__v(){const e=await EXP_o.selected__(!1,!0,!0);if(!e||!e.length)return!0;DIA_o.open__v({LA:"Attention",PA:"Cette opération va remplacer les images de l'exposition courante qui sont sélectionnées.<br>Souhaitez-vous continuer?",option_a:["cancel","accept"]});if(!await DIA_o.confirm__b("confirm"))return!1;for(let t of e)IDB_o.idb_o.delete__v(t.dataset.key_s),t.parentNode.removeChild(t);return!0},async hide__v(){for(let e of Array.from(document.querySelectorAll("figure.selected"))){e.dataset.display_b=!1;const t=e.dataset.key_s;let _=await IDB_o.idb_o.get__(t);if(_){const e=JSON.parse(_);e.display_b=!e.display_b,IDB_o.idb_o.set__v(t,JSON.stringify(e)),EXP_o.show__v()}}},async group__v(){let e,t;for(let _ of Array.from(document.querySelectorAll("figure.selected"))){if(!e){e=_.parentNode,t=_;continue}const o=e.removeChild(_);e.insertBefore(o,t.nextSibling),t=o}let _=[];for(let e of Array.from(document.querySelectorAll("#DI_masonry > figure"))){const t=e.dataset.key_s,o=await IDB_o.idb_o.get__(t),a=JSON.parse(o),n=EXP_o.order__n();a.order_n=n,_.push({key_s:t,value_s:JSON.stringify(a)}),IDB_o.idb_o.delete__v(t)}for(let e of _)IDB_o.idb_o.set__v(e.key_s,e.value_s)},async caption__v(){if(await EXP_o.selected__()){document.getElementById("dialog_work_caption").showModal()}},async export__v(){DIA_o.open__v({LA:"Attention",PA:"Voulez-vous sauvegarder uniquement les images sélectionnées?",option_a:["cancel","accept"]});const e=await DIA_o.confirm__b("confirm");let t=await EXP_o.selected__(!1,e,!0);if(t)try{const e=[];for(let _ of t){const t=_.dataset.key_s;e.push({key_s:t,value_s:await IDB_o.idb_o.get__(t)})}const _=JSON.stringify(e),o=await window.showSaveFilePicker({suggestedName:DATE_o.dataTimeNumeric__s()+"-expo.json",types:[{accept:{"application/json":[".json"]}}]}),a=await o.createWritable();await a.write(_),await a.close()}catch(e){console.log(`ERROR DETECTED @expo.js: ${e}`)}},async import__v(){if(!await EXP_o.remove__v())return;const e=await window.showOpenFilePicker({multiple:!1,types:[{description:"fichier JSON",accept:{"application/json":[".json"]}}]});if(!e)return;let t=e[0],_=new FileReader;_.onload=async()=>{const e=JSON.parse(_.result);for(let t of e)IDB_o.idb_o.set__v(t.key_s,t.value_s);EXP_o.show__v()},_.onerror=()=>{console.log(_.error)},_.readAsText(await t.getFile())},async burst__v(){const e=await EXP_o.selected__();if(e){const t=e.querySelector("img");sessionStorage.setItem("burst",JSON.stringify({origin_s:"expo",src_s:t.src.startsWith("http")?t.src:e.dataset.key_s,width_s:+t.naturalWidth,height_s:+t.naturalHeight})),location.href="burst.html"}},async eventKey__v(e){if(document.querySelector("#dialog_work_caption[open]")||!EXP_o.eventKey_a.includes(e.key))return;let t;switch(e.preventDefault(),e.key){case"3":document.getElementById("IN_expo").checked=!0;break;case"+":t=document.getElementById("IN_masonry_wrap_n"),+t.value<+t.max&&(t.value=+t.value+ +t.step,EXP_o.eventRange__v({target:t}));break;case"-":t=document.getElementById("IN_masonry_wrap_n"),+t.value>+t.min&&(t.value=+t.value-+t.step,EXP_o.eventRange__v({target:t}));break;case"f":FUL_o.toggle__v();break;case"d":document.getElementById("IN_dock_nav").checked=!document.getElementById("IN_dock_nav").checked;break;case"s":e.ctrlKey&&EXP_o.export__v(!1);break;case"o":e.ctrlKey&&await EXP_o.import__v();break;case"i":EXP_o.add__v();break;case"x":EXP_o.remove__v();break;case"m":EXP_o.hide__v();break;case"g":EXP_o.group__v();break;case"c":EXP_o.caption__v();break;case"b":EXP_o.burst__v()}},async eventCaption__v(e){const t=e.target.id,_=document.getElementById("dialog_work_caption");switch(!0){case t.endsWith("reset"):for(let e of document.querySelectorAll("input[id^=IN_work_caption_][type=text]"))e.value="";break;case t.endsWith("accept"):const e=await EXP_o.selected__();if(e){const t={};for(let e of Array.from(document.querySelectorAll("input[id^=IN_work_caption_][type=text]"))){const _="IN_work_caption_".length;t[`${e.id.substring(_)}`]=e.value||""}let _=`<span data-ins=₉><b>${t.artist_s}</b>`;const o=t.link_s;_+=o?`<b><a href="${o}">${t.subject_s}</a></b>`:`<b>${t.subject_s}</b>`,_+=`<b>${t.year_n}</b><b><i>${t.w_height_n}</i><i>${t.w_width_n}</i></b><b>${t.location_s}</b><b>${t.place_s}`,_+=t.place_s?" ∙ ":"",_+=`${t.country_s}</b></span>`;const a=e.dataset.key_s;let n=await IDB_o.idb_o.get__(a);if(n){const e=JSON.parse(n);e.caption_s=_,e.caption_b=!0,IDB_o.idb_o.set__v(a,JSON.stringify(e)),EXP_o.show__v()}}}_.close()},eventRange__v(e){UI_o.rangeVar__v(e.target,"masonry_wrap_n")},eventSizeFull__v(e){if(EXP_o.full_e)return;const t=e.target;EXP_o.full_e=t,"false"!==t.parentNode.dataset.display_b&&(t.classList.toggle("fullsize"),document.getElementById("IN_toolset_zoom").checked=!0,IND_o.zoom__v())},listener__v(){DOM_o.rootVar__v("--masonry_wrap_n","5"),document.getElementById("IN_expo_selectAll").addEventListener("change",EXP_o.selectAll__v),document.body.addEventListener("keydown",EXP_o.eventKey__v,{passive:!1});for(let e of["add","remove","hide","group","caption","export","import"]){const t=document.getElementById(`LA_expo_${e}`);t&&t.addEventListener("click",EXP_o[`${e}__v`])}const e=document.getElementById("LA_toolset_burst");e&&e.addEventListener("click",EXP_o.burst__v);for(let e of["cancel","reset","accept"]){const t=document.getElementById(`IN_work_caption_${e}`);t&&t.addEventListener("change",EXP_o.eventCaption__v)}for(let e of["wrap_n"])for(let t of["click","keydown"])DOM_o.listener__v(`IN_masonry_${e}`,EXP_o.eventRange__v,t);document.getElementById("goto_screen_full")&&FUL_o.listener__v()},async init__v(){EXP_o.listener__v(),await EXP_o.show__v(),UI_o.showSection__v("IN_expo"),DOM_o.removeWait__v()}};EXP_o.init__v();