
const PAI_o={status_o:null,SCALE_H_n:1,SCALE_V_n:2,hue_o:{grade_n:50,gap_n:60},sat_o:{grade_n:50,gap_n:10},lum_o:{grade_n:50,gap_n:10},view_o:{perspective_n:1e3,distance_n:-100,rotation_n:0,scale_n:.5},layer_a:[],message__v:e=>{switch(e.task_s){case"PUT_status":PAI_o.status_o=e.status_o;break;case"PUT_error":console.log(`ERROR: ${e.error_s}`)}},layer__n:()=>Array.from(document.getElementById("UL_paint_layer_items").querySelectorAll("li")).length,layerIndex__s:e=>e.slice(e.lastIndexOf("_")+1),addLayer__n:(e="",_="")=>{const t=PAI_o.layer__n();if(t>=8)return void alert("Le nombre de plans maximum est atteint ");t>1&&PAI_o.displayOp__v(!0);let o=document.querySelector("body").dataset.work_s,n="Plan "+(t||"initial");_&&(n+=` &#8285; ${_}`);let a="",r="",l="";t&&(r=`input_${e||o}_${t}`,a=`<input id="${r}" data-layer_n=${t} type="checkbox">`,l=`for="${r}"`),DOM_o.appendNode__v(DOM_o.fragment__e(`<li data-layer_n=${t}>`+a+`<label ${l}>${n}</label></li>`),"UL_paint_layer_items");const[s,i]=document.querySelector("body").dataset.wh_s.split("_");DOM_o.fragment__e(`<canvas id=CA_paint_layer_${t} width=${s} height=${i} data-layer_n=${t} data-size_n=1 title=Plan ${t+1}><canvas>`,"DI_paint_layer_view");const d=document.getElementById(`CA_paint_layer_${t}`).transferControlToOffscreen();PAI_o.layer_a.push({hue_o:{grade_n:0,gap_n:0},sat_o:{grade_n:0,gap_n:0},lum_o:{grade_n:0,gap_n:0}});const c=.5*+s,p=.5*+i;return PAI_o.worker_o.port_o.postMessage({task_s:"GET_img",pixel_n:window.devicePixelRatio,rect_s:`${c} ${p} ${s} ${i}`,scale_n:1,url_s:`/assets/media/img/${o}/full/max/0/color.jpeg`,canvas_e:d,storeBitmap_b:!0},[d]),t},hideLayer__n:()=>{const e=PAI_o.selected__a();if(!e.length){if(!PAI_o.masked__n())return void window.alert("Aucun plan n'est sélectionné.");if(!window.confirm("Aucun plan n'est sélectionné.\nVoulez-vous démasquer le premier plan masqué?"))return;let e=document.querySelector('#UL_paint_layer_items > li[data-layer_b="0"]');if(e){const _=e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${_}"]`)))PAI_o.unmask__v(node_e);PAI_o.layer__n()>2&&PAI_o.displayOp__v(!0)}return layer_n}for(selected_e of(PAI_o.operable__a().length-e.length<3&&PAI_o.displayOp__v(!1),e)){const e=selected_e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${e}"]`)))PAI_o.mask__v(node_e)}},setop__v:e=>{const _=e.target.closest("input")?.id;if(_){const e=_.slice(_.lastIndexOf("_")+1);if(e&&"none"!==e){const _=PAI_o.operateOn__a();if(_.length<2)return window.alert("Deux plans doivent être sélectionnés pour effectuer cette opération.");let t=PAI_o.layerIndex__s(_[0].dataset.layer_n),o=PAI_o.layerIndex__s(_[1].dataset.layer_n),n="union"===e?"Union":"difference"===e?"Différence":"intersection"===e?"Intersection":"Complément";const a=PAI_o.addLayer__n(e,`${n} [ ${t} &#8728; ${o} ]`);a&&PAI_o[`${e}__v`](a,_)}}},selected__a:()=>Array.from(document.querySelectorAll('#UL_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"]) > input:checked')),operable__a:()=>Array.from(document.querySelectorAll('#UL_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"])')),operateOn__a:()=>PAI_o.selected__a().slice(-2),masked__n:()=>Array.from(document.getElementById("UL_paint_layer_items").querySelectorAll('li[data-layer_b="0"]'))?.length,mask__v:e=>{e.dataset.layer_b=0,e.checked&&(e.checked=!1)},unmask__v:e=>{e.removeAttribute("data-layer_b")},displayOp__v:e=>DOM_o.rootVar__v("--paint_setop_display",e?"block":"none"),none__v:(e,_)=>{console.log("none__v")},union__v:(e,_)=>{console.log("union__v")},difference__v:(e,_)=>{console.log("difference__v")},intersection__v:(e,_)=>{console.log("intersection__v")},complement__v:(e,_)=>{console.log("complement__v")},range__v:(e,_)=>{const t=e.value;e.dataset.tip=t;const[,,o,n]=e.id.split("_");_&&_(o,n,t)},rangeEvent__v:e=>{PAI_o.range__v(e.target,((e,_,t)=>{PAI_o[`${e}_o`][`${_}_n`]=+t,DOM_o.rootVar__v(`--paint_${_}`,+t)}))},huePoint__v:(e,_)=>{console.log("hue: "+_+" / "+e),PAI_o.worker_o.post__v({task_s:"PUT_point",stat_s:"paint",hsl_s:"hue",grade_n:PAI_o.hue_o.grade_n,atX_n:e,gap_n:PAI_o.hue_o.gap_n,atY_n:_})},satPoint__v:(e,_)=>{console.log("sat: "+_+" / "+e)},lumPoint__v:(e,_)=>{console.log("lum: "+_+" / "+e)},pointEvent__v:e=>{const{offsetX:_,offsetY:t}=e,[,,o]=e.target.id.split("_");PAI_o[`${o}Point__v`](~~(+_/PAI_o.SCALE_H_n),~~(+t/PAI_o.SCALE_V_n))},listener__v(){for(let e of["hue","sat","lum"]){for(let _ of["grade","gap"])for(let t of["click","keydown"])DOM_o.listener__v(`IN_paint_${e}_${_}`,PAI_o.rangeEvent__v,t);DOM_o.listener__v(`CA_paint_${e}_front`,PAI_o.pointEvent__v)}for(let e of["perspective","distance","rotate","scale"])for(let _ of["click","keydown"])DOM_o.listener__v(`IN_paint_view_${e}`,PAI_o.rangeEvent__v,_);for(let e of["add","hide"])DOM_o.listener__v(`LA_paint_layer_${e}`,PAI_o[`${e}Layer__n`]);DOM_o.listener__v("UL_paint_layer_setop",PAI_o.setop__v)},init__v(){const e=["hue_back","hue_front","sat_back","sat_front","lum_back","lum_front"];PAI_o.worker_o=STAT_o.worker__o("paint",e,"Painter",PAI_o.message__v),PAI_o.addLayer__n(),PAI_o.addLayer__n();for(let _ of e)PAI_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"paint",part_s:_,hue_n:+DOM_o.rootVar__s("--paint_sat_hue")});console.log(DOM_o.rootVar__s("--paint_sat_hue")),PAI_o.listener__v()}};PAI_o.init__v();