
const PAI_o={status_o:null,SCALE_H_n:1,SCALE_V_n:2,hue_o:{grade_n:0,gap_n:0},sat_o:{grade_n:0,gap_n:0},lum_o:{grade_n:0,gap_n:0},layer_o:{perspective_n:1e3,distance_n:-100,rotation_n:0,scale_n:.5},layer_a:[],message__v:e=>{switch(e.task_s){case"PUT_status":PAI_o.status_o=e.status_o;break;case"PUT_error":console.log(`ERROR: ${e.error_s}`)}},canvas__v:(e,_,t)=>{const n=~~(+_/PAI_o.SCALE_H_n),a=~~(+t/PAI_o.SCALE_V_n);console.log(e+": "+a+" / "+n)},canvas__e:(e,_)=>{const t=document.createElement("canvas");return _&&_(t),t},range__v:(e,_)=>{const t=e.value;e.dataset.tip=t;const[,,n,a]=e.id.split("_");_&&_(n,a,t)},layer__n:()=>Array.from(document.getElementById("DI_paint_layer_items").querySelectorAll("li")).length,layerIndex__s:e=>e.slice(e.lastIndexOf("_")+1),addLayer__n:(e="",_="")=>{const t=PAI_o.layer__n();if(t>=8)return void alert("Le nombre de plans maximum est atteint ");t>1&&PAI_o.displayOp__v(!0);let n=document.querySelector("body").dataset.work_s,a="Plan "+(t||"initial");_&&(a+=` &#8285; ${_}`);let o="",r="",l="";t&&(r=`input_${e||n}_${t}`,o=`<input id="${r}" data-layer_n=${t} type="checkbox">`,l=`for="${r}"`),DOM_o.appendNode__v(DOM_o.fragment__e(`<li data-layer_n=${t}>`+o+`<label ${l}>${a}</label></li>`),"DI_paint_layer_items");const[s,i]=document.querySelector("body").dataset.wh_s.split("_"),d=PAI_o.canvas__e(n,(e=>{e.id=`canvas_paint_layer_${t}`,e.dataset.layer_n=t,e.width=s,e.height=i,e.dataset.size_n=1,e.title=`Plan ${t+1}`}));DOM_o.beforeNode__v(d,"DI_paint_layer_position"),PAI_o.layer_a.push({hue_o:{grade_n:0,gap_n:0},sat_o:{grade_n:0,gap_n:0},lum_o:{grade_n:0,gap_n:0}});const c=.5*+s,y=.5*+i,p=d.transferControlToOffscreen();return PAI_o.worker_o.port_o.postMessage({task_s:"GET_img",pixel_n:window.devicePixelRatio,rect_s:`${c} ${y} ${s} ${i}`,scale_n:1,url_s:`/assets/media/img/${n}/full/max/0/color.jpeg`,canvas_e:p,storeBitmap_b:!0},[p]),t},hideLayer__v:()=>{const e=PAI_o.selected__a();if(e.length)for(selected_e of(PAI_o.operable__a().length-e.length<3&&PAI_o.displayOp__v(!1),e)){const e=selected_e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${e}"]`)))PAI_o.mask__v(node_e)}else{if(!PAI_o.masked__n())return void window.alert("Aucun plan n'est sélectionné.");if(!window.confirm("Aucun plan n'est sélectionné.\nVoulez-vous démasquer le premier plan masqué?"))return;let e=document.querySelector('#DI_paint_layer_items > li[data-layer_b="0"]');if(e){const _=e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${_}"]`)))PAI_o.unmask__v(node_e);PAI_o.layer__n()>2&&PAI_o.displayOp__v(!0)}}},selected__a:()=>Array.from(document.querySelectorAll('#DI_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"]) > input:checked')),operable__a:()=>Array.from(document.querySelectorAll('#DI_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"])')),operateOn__a:()=>PAI_o.selected__a().slice(-2),masked__n:()=>Array.from(document.getElementById("DI_paint_layer_items").querySelectorAll('li[data-layer_b="0"]'))?.length,mask__v:e=>{e.dataset.layer_b=0,e.checked&&(e.checked=!1)},unmask__v:e=>{e.removeAttribute("data-layer_b")},displayOp__v:e=>DOM_o.rootVar__v("--paint_setop_display",e?"block":"none"),none__v:(e,_)=>{console.log("none__v")},union__v:(e,_)=>{console.log("union__v")},difference__v:(e,_)=>{console.log("difference__v")},intersection__v:(e,_)=>{console.log("intersection__v")},complement__v:(e,_)=>{console.log("complement__v")},listener__v(){for(let e of["hue","sat","lum"]){for(let _ of["grade","gap"]){const t=document.getElementById(`IN_paint_${e}_${_}`);for(let e of["click","keydown"])t&&t.addEventListener(e,(e=>{PAI_o.range__v(e.target,((e,_,t)=>PAI_o[`${e}_o`][`${_}_n`]=+t))}))}const _=document.getElementById(`canvas_paint_${e}_front`);_&&_.addEventListener("click",(e=>{const{offsetX:_,offsetY:t}=e;PAI_o.canvas__v(e.target.id,_,t)}))}for(let e of["perspective","distance","rotate","scale"]){const _=document.getElementById(`IN_paint_layer_${e}`);for(let e of["click","keydown"])_&&_.addEventListener(e,(e=>{PAI_o.range__v(e.target,((e,_,t)=>{PAI_o[`${e}_o`][`${_}_n`]=+t,DOM_o.rootVar__v(`--paint_${_}`,+t)}))}))}const e=document.getElementById("LA_paint_layer_add");e&&e.addEventListener("click",PAI_o.addLayer__n);const _=document.getElementById("LA_paint_layer_hide");_&&_.addEventListener("click",(e=>{PAI_o.hideLayer__v()}));const t=document.getElementById("DI_paint_layer_setop");t&&t.addEventListener("click",(e=>{const _=e.target.closest("input")?.id;if(_){const e=_.slice(_.lastIndexOf("_")+1);if(e&&"none"!==e){const _=PAI_o.operateOn__a();if(_.length<2)return window.alert("Deux plans doivent être sélectionnés pour effectuer cette opération.");let t=PAI_o.layerIndex__s(_[0].dataset.layer_n),n=PAI_o.layerIndex__s(_[1].dataset.layer_n),a="union"===e?"Union":"difference"===e?"Différence":"intersection"===e?"Intersection":"Complément";const o=PAI_o.addLayer__n(e,`${a} [ ${t} &#8728; ${n} ]`);o&&PAI_o[`${e}__v`](o,_)}}}))},init__v(){const e=["hue_back","hue_front","sat_back","sat_front","lum_back","lum_front"];PAI_o.worker_o=STAT_o.worker__o("paint",e,"Painter",PAI_o.message__v),PAI_o.addLayer__n(),PAI_o.addLayer__n();for(let _ of e)PAI_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"paint",part_s:_});PAI_o.listener__v()}};PAI_o.init__v();