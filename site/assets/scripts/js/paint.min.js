
const PAI_o={status_o:null,SCALE_H_n:1,SCALE_V_n:2,hue_o:{rangeX_n:50,rangeY_n:60},sat_o:{rangeX_n:50,rangeY_n:10},lum_o:{rangeX_n:50,rangeY_n:10},view_o:{perspective_n:1e3,distance_n:-100,rotation_n:0,scale_n:.25},layer_a:[],message__v:e=>{switch(e.task_s){case"PUT_status":PAI_o.status_o=e.status_o;break;case"PUT_error":console.log(`ERROR: ${e.error_s}`)}},layer__n:()=>Array.from(document.getElementById("UL_paint_layer_items").querySelectorAll("li")).length,layerIndex__s:e=>e.slice(e.lastIndexOf("_")+1),addLayer__n:(e="",_="",t)=>{const a=PAI_o.layer__n();if(a>=8)return void alert("Le nombre de plans maximum est atteint ");a>1&&PAI_o.displayOp__v(!0);const n=typeof e===String?e:"";let o=document.querySelector("body").dataset.work_s,r="Plan "+(a||"initial");_&&(r+=` &#8285; ${_}`);let l="",i="",s="";if(a){i=`input_${n||o}_${a}`;let e="",r="";_&&(e=" checked",r=` data_layer_s="${t.join(" ")}"`),l=`<input id="${i}" data-layer_n="${a}"${r} type="checkbox"${e}>`,s=`for="${i}"`}DOM_o.appendNode__v(DOM_o.fragment__e(`<li data-layer_n=${a}>`+l+`<label ${s}>${r}</label></li>`),"UL_paint_layer_items");const[c,d]=document.querySelector("body").dataset.wh_s.split("_");let p=`<div id=DI_paint_layer_${a} data-layer_n=${a}><canvas id=CA_paint_layer_${a} width=${c} height=${d} data-layer_n=${a} data-size_n=1 title="Plan ${a||"initial"}"></canvas>`;a>0&&(p+=`<canvas id=CA_paint_layer_front_${a} width=${c} height=${d} data-layer_n=${a} data-size_n=1 title="Plan ${a}"></canvas>`),p+="</div>",DOM_o.fragment__e(p,"script_paint");const u=document.getElementById(`CA_paint_layer_${a}`).transferControlToOffscreen(),y=.5*+c,v=.5*+d;PAI_o.worker_o.port_o.postMessage({task_s:"GET_img",rect_s:`${y} ${v} ${c} ${d}`,scale_n:1,url_s:`/assets/media/img/${o}/full/max/0/color.jpeg`,canvas_e:u,storeBitmap_b:!0,layer_n:a,pixel_n:window.devicePixelRatio},[u]);const f=document.getElementById(`DI_paint_layer_${a}`);return f.lastChild.addEventListener("click",(e=>PAI_o.canvasPointer__v(e,a))),f.lastChild.addEventListener("wheel",(e=>PAI_o.zoomEvent__v(e,a))),PAI_o.layer_a.push({hue_o:{rangeX_n:0,rangeY_n:0},sat_o:{rangeX_n:0,rangeY_n:0},lum_o:{rangeX_n:0,rangeY_n:0},clipRect_a:[]}),a},drawClip__v:(e,_)=>{const t=_.width,a=_.height;let n=document.getElementById(`CA_paint_layer_clip_${e}`);if(!n){let o=`<canvas id=CA_paint_layer_clip_${e} width=${t} height=${a} data-layer_n=${e}></canvas>`;DOM_o.fragment__e(o,_.id),n=document.getElementById(`CA_paint_layer_clip_${e}`)}let o=n.getContext("2d");o.strokeStyle="hsla( 190 72% 50% / .212 )",o.lineWidth=4;const r=[null,0,0,0],l=[0,0,n.width,n.height];new Pointer(_,((e,_)=>{null===r[0]&&(r[0]=~~e,r[1]=~~_),r[2]&&o.clearRect(...l),r[2]=~~e-r[0],r[3]=~~_-r[1],o.strokeRect(...r)}),(()=>{let[e,t,a,n]=r;a<0&&(e+=a,a=-a),n<0&&(t+=n,n=-n),PAI_o.addClip__v(_,[e,t,a,n])}))},addClip__v:(e,_)=>{const t=e.dataset.layer_n;PAI_o.layer_a[t].clipRect_a.push(_),PAI_o.drawClipRect__v(e,t)},drawClipRect__v:(e,_)=>{let t=e.getContext("2d");t.clearRect(0,0,e.width,e.height);if(PAI_o.layer_a[_].clipRect_a.length)for(clip_a of(t.fillStyle="hsla( 190 72% 50% / .212 )",t.fillRect(0,0,e.width,e.height),PAI_o.layer_a[_].clipRect_a))t.clearRect(...clip_a)},hideLayer__n:()=>{const e=PAI_o.selectedItem__a();if(!e.length){if(!PAI_o.masked__n())return void window.alert("Aucun plan n'est sélectionné.");if(!window.confirm("Aucun plan n'est sélectionné.\nVoulez-vous démasquer le premier plan masqué?"))return;let e=document.querySelector('#UL_paint_layer_items > li[data-layer_b="0"]');if(e){const _=e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${_}"]`)))PAI_o.unmask__v(node_e);return PAI_o.layer__n()>2&&PAI_o.displayOp__v(!0),_}}for(selected_e of(PAI_o.operable__a().length-e.length<3&&PAI_o.displayOp__v(!1),e)){const e=selected_e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${e}"]`)))PAI_o.mask__v(node_e)}},setop__v:e=>{const _=e.target.closest("input")?.id;if(_){const t=_.slice(_.lastIndexOf("_")+1);if(t&&"none"!==t){if("deviation"===t)return void(e.target.dataset.tip=e.target.value);const _=PAI_o.selectedOperand__a();if(_.length<2)return window.alert("Pour effectuer cette opération, deux plans doivent être sélectionnés.");let a=_[0].dataset.layer_n,n=PAI_o.layerIndex__s(a),o=_[1].dataset.layer_n,r=PAI_o.layerIndex__s(o),l="union"===t?"Union":"difference"===t?"Différence":"intersection"===t?"Intersection":"Complément";PAI_o.addLayer__n(t,`${l} [ ${n} &#8728; ${r} ]`,[a,o])}}},selectedCanvas__a:()=>Array.from(document.querySelectorAll('div:not([data-layer_n="0"]):not([data-layer_b="0"]).raised')),selectedItem__a:()=>Array.from(document.querySelectorAll('#UL_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"]) > input:checked')),operable__a:()=>Array.from(document.querySelectorAll('#UL_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"])')),selectedOperand__a:(e=2)=>PAI_o.selectedItem__a().slice(-e),masked__n:()=>Array.from(document.getElementById("UL_paint_layer_items").querySelectorAll('li[data-layer_b="0"]'))?.length,mask__v:e=>{e.dataset.layer_b=0,e.checked&&(e.checked=!1)},unmask__v:e=>{e.removeAttribute("data-layer_b")},displayOp__v:e=>DOM_o.rootVar__v("--paint_setop_display",e?"block":"none"),range__v:(e,_)=>{const t=e.value;e.dataset.tip=t;const[,,a,n]=e.id.split("_");_&&_(a,n,t)},rangeEvent__v:e=>{PAI_o.range__v(e.target,((e,_,t)=>{PAI_o[`${e}_o`][`${_}_n`]=+t,DOM_o.rootVar__v(`--paint_${_}`,+t)}))},zoomEvent__v:(e,_)=>{e.preventDefault();let t=PAI_o.view_o.scale_n;t+=-.001*e.deltaY,t=Math.min(Math.max(.125,t),1),PAI_o.view_o.scale_n=t,e.altKey?DOM_o.rootVar__v("--paint_scale",t):(DOM_o.rootVar__v("--paint_scale",1),DOM_o.rootVar__v(`--paint_layer_scale_${_}`,t))},hslPoint__v:e=>{let _=PAI_o.selectedCanvas__a();if(!_.length&&(_=PAI_o.selectedOperand__a(3),!_.length))return void window.alert("Aucun plan n'est sélectionné.");_[_.length-1].dataset.layer_n;const t=document.querySelector('input[name="layer_set"]:checked')?.id?.split("_")?.[4];let a=[];for(let e of _){const _=e.dataset.layer_n;a.push({layer_n:_,clipRect_a:PAI_o.layer_a[_].clipRect_a})}let n=0;"none"!==t&&(n=document.getElementById("IN_paint_layer_set_deviation").value,a.length>3&&(a=a.slice(-3),window.alert("Plus de trois plans ont été sélectionés.\nSeuls les deux plans supérieurs sont pris en compte.")));const{offsetX:o,offsetY:r}=e,[,,l]=e.target.id.split("_"),i=~~(+o/PAI_o.SCALE_H_n),s=~~(+r/PAI_o.SCALE_V_n);PAI_o.worker_o.post__v({task_s:"PUT_hsl",stat_s:"paint",operand_a:a,operation_s:t,deviation_n:n,hsl_s:l,rangeX_n:PAI_o[`${l}_o`].rangeX_n,atX_n:i,rangeY_n:PAI_o[`${l}_o`].rangeY_n,atY_n:s});const c="hue"===l?360:100;DOM_o.rootVar__v(`--paint_${l}_trace`,-2*(c-s)),document.getElementById(`output_paint_${l}`).value=s},backColor__v:e=>{e.preventDefault();const _=e.target.closest("label");if(_){const e=_.id.split("_")[2],t=document.querySelector(`label[id$="${e}_trace"] > output`).value;DOM_o.rootVar__v(`--paint_back_${e}`,+t),"hue"===e&&PAI_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"paint",part_s:"sat_front",hue_n:+DOM_o.rootVar__s("--paint_back_hue")})}},findClip__n:(e,_)=>{const{offsetX:t,offsetY:a}=e;if(!_.length)return-1;let n=-1;for(let e of _)if(++n,t>e[0]&&t<e[0]+e[2]&&a>e[1]&&a<e[1]+e[3])return n;return-1},canvasPointer__v:(e,_)=>{const t=e.target;if(_&&e.ctrlKey){const a=PAI_o.findClip__n(e,PAI_o.layer_a[_].clipRect_a);return a>-1?(PAI_o.layer_a[_].clipRect_a.splice(a,1),void PAI_o.drawClipRect__v(t,_)):void PAI_o.drawClip__v(_,t)}t.closest("div").classList.toggle("raised")},listener__v(){for(let e of["hue","sat","lum"]){for(let _ of["rangeX_n","rangeY_n"])for(let t of["click","keydown"])DOM_o.listener__v(`IN_paint_${e}_${_}`,PAI_o.rangeEvent__v,t);DOM_o.listener__v(`CA_paint_${e}_front`,PAI_o.hslPoint__v),DOM_o.listener__v(`LA_paint_${e}_trace`,PAI_o.backColor__v)}for(let e of["IN_paint_settings","DI_paint_settings","DI_paint_layer_view"])DOM_o.beforeNode__e(document.getElementById(e),"goto_page_top");for(let e of["perspective","distance","rotate","scale"])for(let _ of["click","keydown"])DOM_o.listener__v(`IN_paint_view_${e}`,PAI_o.rangeEvent__v,_);for(let e of["add","hide"])DOM_o.listener__v(`LA_paint_layer_${e}`,PAI_o[`${e}Layer__n`]);DOM_o.listener__v("UL_paint_layer_setop",PAI_o.setop__v)},init__v(){const e=["hue_back","hue_front","sat_back","sat_front","lum_back","lum_front"];PAI_o.worker_o=STAT_o.worker__o("paint",e,"Painter",PAI_o.message__v),PAI_o.addLayer__n(),PAI_o.addLayer__n();for(let _ of e)if(PAI_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"paint",part_s:_,hue_n:+DOM_o.rootVar__s("--paint_back_hue")}),_.endsWith("_back")){const e=_.slice(0,-"_back".length),t="hue"===e?360:100;DOM_o.rootVar__v(`--paint_${e}_trace`,-2*(t-document.getElementById(`output_paint_${e}`).value))}PAI_o.listener__v()}};PAI_o.init__v();