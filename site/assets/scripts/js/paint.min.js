
const PAI_o={status_o:null,hScale_n:1,vScale_n:2,hue_o:{rangeX_n:50,rangeY_n:60},sat_o:{rangeX_n:50,rangeY_n:10},lum_o:{rangeX_n:50,rangeY_n:10},dock_o:{perspective_n:1e3,distance_n:-100,rotation_n:0,scale_n:.25},layer_a:[],message__v:e=>{switch(e.task_s){case"PUT_status":PAI_o.status_o=e.status_o;break;case"PUT_error":console.log(`ERROR: ${e.error_s}`)}},layer__n:()=>Array.from(document.getElementById("UL_paint_layer_items").querySelectorAll("li")).length,layerIndex__s:e=>e.slice(e.lastIndexOf("_")+1),addLayer__n:(e="",_="",t)=>{const a=PAI_o.layer__n();if(a>=8)return void alert("Le nombre de plans maximum est atteint ");a>1&&PAI_o.displayOp__v(!0);const n=typeof e===String?e:"";let o=document.querySelector("body").dataset.work_s,r="Plan "+(a||"initial");_&&(r+=` &#8285; ${_}`);let l="",s="",i="";if(a){s=`input_${n||o}_${a}`;let e="",r="";_&&(e=" checked",r=` data_layer_s="${t.join(" ")}"`),l=`<input id="${s}" data-layer_n="${a}"${r} type="checkbox"${e}>`,i=`for="${s}"`}DOM_o.appendNode__v(DOM_o.fragment__e(`<li data-layer_n=${a}>`+l+`<label ${i}>${r}</label></li>`),"UL_paint_layer_items");const[c,d]=document.querySelector("body").dataset.wh_s.split("_");let p=`<div id=DI_paint_layer_${a} data-layer_n=${a}><canvas id=CA_paint_layer_${a} width=${c} height=${d} data-layer_n=${a} data-size_n=1 data-fullsize_b=true title="Plan ${a||"initial"}"></canvas>`;a>0&&(p+=`<canvas id=CA_paint_layer_front_${a} width=${c} height=${d} data-layer_n=${a} data-size_n=1 title="Plan ${a}"></canvas>`),p+="</div>",DOM_o.fragment__e(p,"script_paint");const u=document.getElementById(`CA_paint_layer_${a}`).transferControlToOffscreen(),y=.5*+c,v=.5*+d;PAI_o.worker_o.port_o.postMessage({task_s:"GET_img",rect_s:`${y} ${v} ${c} ${d}`,scale_n:1,url_s:`/assets/media/img/${o}/full/max/0/color.jpeg`,canvas_e:u,storeBitmap_b:!0,layer_n:a,pixel_n:window.devicePixelRatio},[u]);const f=document.getElementById(`DI_paint_layer_${a}`);return f.lastChild.addEventListener("click",(e=>PAI_o.canvasEvent__v(e,a))),f.lastChild.addEventListener("wheel",(e=>PAI_o.zoomEvent__v(e,a)),{passive:!0}),PAI_o.layer_a.push({hue_o:{rangeX_n:0,rangeY_n:0},sat_o:{rangeX_n:0,rangeY_n:0},lum_o:{rangeX_n:0,rangeY_n:0},clipRect_a:[]}),a},drawClip__v:(e,_)=>{const t=e.width,a=e.height;let n=document.getElementById(`CA_paint_layer_clip_${_}`);if(!n){let o=`<canvas id=CA_paint_layer_clip_${_} width=${t} height=${a} data-layer_n=${_}></canvas>`;DOM_o.fragment__e(o,e.id),n=document.getElementById(`CA_paint_layer_clip_${_}`)}let o=n.getContext("2d");o.strokeStyle="hsla( 210 50% 79% /.7 )",o.lineWidth=8;const r=[null,0,0,0],l=[0,0,n.width,n.height];e.classList.add("cursor_resize"),new Pointer(e,((e,_)=>{null===r[0]&&(r[0]=~~e,r[1]=~~_),r[2]&&o.clearRect(...l),r[2]=~~e-r[0],r[3]=~~_-r[1],o.strokeRect(...r)}),(()=>{let[t,a,n,s]=r;n<0&&(t+=n,n=-n),s<0&&(a+=s,s=-s),PAI_o.layer_a[_].clipRect_a.push(r),PAI_o.drawClipRect__v(e,_),o.clearRect(...l),e.classList.remove("cursor_resize")}))},drawClipRect__v:(e,_)=>{let t=e.getContext("2d");t.clearRect(0,0,e.width,e.height);if(PAI_o.layer_a[_].clipRect_a.length)for(clip_a of(t.fillStyle="hsla( 210 50% 79% /.2 )",t.fillRect(0,0,e.width,e.height),PAI_o.layer_a[_].clipRect_a))t.clearRect(...clip_a)},findClip__n:(e,_)=>{const{offsetX:t,offsetY:a}=e,n=PAI_o.layer_a[_].clipRect_a;if(!n.length)return-1;let o=-1;for(let e of n)if(++o,t>e[0]&&t<e[0]+e[2]&&a>e[1]&&a<e[1]+e[3])return o;return-1},moveClip__v:(e,_,t)=>{const a=document.getElementById(`CA_paint_layer_clip_${_}`),n=[0,0,a.width,a.height],o=a.getContext("2d"),r=PAI_o.layer_a[_].clipRect_a[t];o.strokeRect(...r),e.classList.add("cursor_move"),new Pointer(e,((e,_)=>{o.clearRect(...n),r[0]=~~e,r[1]=~~_,o.strokeRect(...r)}),(()=>{PAI_o.drawClipRect__v(e,_),o.clearRect(...n),e.classList.remove("cursor_move")}))},hideLayer__n:()=>{const e=PAI_o.selectedItem__a();if(!e.length){if(!PAI_o.masked__n())return window.alert("Aucun plan n'est sélectionné."),-1;if(!window.confirm("Aucun plan n'est sélectionné.\nVoulez-vous démasquer le premier plan masqué?"))return-1;let e=document.querySelector('#UL_paint_layer_items > li[data-layer_b="0"]');if(e){const _=e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${_}"]`)))PAI_o.unmask__v(node_e);return PAI_o.layer__n()>2&&PAI_o.displayOp__v(!0),_}}for(selected_e of(PAI_o.operable__a().length-e.length<3&&PAI_o.displayOp__v(!1),e)){const e=selected_e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${e}"]`)))PAI_o.mask__v(node_e)}return-1},setop__v:e=>{const _=e.target.closest("input")?.id;if(_){const t=_.slice(_.lastIndexOf("_")+1);if(t&&"none"!==t){if("deviation"===t)return void(e.target.dataset.tip=e.target.value);const _=PAI_o.selectedOperand__a();if(_.length<2)return window.alert("Pour effectuer cette opération, deux plans doivent être sélectionnés.");let a=_[0].dataset.layer_n,n=PAI_o.layerIndex__s(a),o=_[1].dataset.layer_n,r=PAI_o.layerIndex__s(o),l="union"===t?"Union":"difference"===t?"Différence":"intersection"===t?"Intersection":"Complément";PAI_o.addLayer__n(t,`${l} [ ${n} &#8728; ${r} ]`,[a,o])}}},selectedCanvas__a:()=>Array.from(document.querySelectorAll('div:not([data-layer_n="0"]):not([data-layer_b="0"]).raised')),selectedItem__a:()=>Array.from(document.querySelectorAll('#UL_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"]) > input:checked')),operable__a:()=>Array.from(document.querySelectorAll('#UL_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"])')),selectedOperand__a:(e=2)=>PAI_o.selectedItem__a().slice(-e),masked__n:()=>Array.from(document.getElementById("UL_paint_layer_items").querySelectorAll('li[data-layer_b="0"]'))?.length,mask__v:e=>{e.dataset.layer_b=0,e.checked&&(e.checked=!1)},unmask__v:e=>{e.removeAttribute("data-layer_b")},displayOp__v:e=>DOM_o.rootVar__v("--paint_setop_display",e?"block":"none"),backColor__v:e=>{e.preventDefault();const _=e.target.closest("label");if(_){const e=_.id.split("_")[2],t=document.querySelector(`label[id$="${e}_trace"] > output`).value;DOM_o.rootVar__v(`--paint_${e}_back`,+t),"hue"===e&&PAI_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"paint",hsl_s:"sat_front",back_hue_n:+DOM_o.rootVar__s("--paint_hue_back")})}},eventHsl__v:e=>{let _=PAI_o.selectedCanvas__a();if(!_.length&&(_=PAI_o.selectedOperand__a(3),!_.length))return void window.alert("Aucun plan n'est sélectionné.");const t=document.querySelector('input[name="layer_set"]:checked')?.id?.split("_")?.[4];let a=[];for(let e of _){const _=e.dataset.layer_n;a.push({layer_n:_,clipRect_a:PAI_o.layer_a[_].clipRect_a})}let n=0;"none"!==t&&(n=document.getElementById("IN_paint_layer_set_deviation").value,a.length>3&&(a=a.slice(-3),window.alert("Plus de trois plans ont été sélectionés.\nSeuls les deux plans supérieurs sont pris en compte.")));const{offsetX:o,offsetY:r}=e,[,,l]=e.target.id.split("_"),s=~~(+o/PAI_o.hScale_n),i=~~(+r/PAI_o.vScale_n);PAI_o.worker_o.post__v({task_s:"PUT_hsl",stat_s:"paint",hsl_s:l,operand_a:a,operation_s:t,deviation_n:n,rangeX_n:PAI_o[`${l}_o`].rangeX_n,atX_n:s,rangeY_n:PAI_o[`${l}_o`].rangeY_n,atY_n:i});const c="hue"===l?360:100;DOM_o.rootVar__v(`--paint_${l}_trace`,-2*(c-i)),document.getElementById(`output_paint_${l}`).value=i},canvasEvent__v:(e,_)=>{const t=e.target,a=PAI_o.findClip__n(e,_);if(_){if(e.ctrlKey)return a>-1?(PAI_o.layer_a[_].clipRect_a.splice(a,1),void PAI_o.drawClipRect__v(t,_)):void PAI_o.drawClip__v(t,_);if(a>-1)return void PAI_o.moveClip__v(t,_,a)}t.closest("div").classList.toggle("raised")},zoomEvent__v:(e,_)=>{let t=PAI_o.dock_o.scale_n;t+=-.001*e.deltaY,t=Math.min(Math.max(.125,t),2),PAI_o.dock_o.scale_n=t,DOM_o.rootVar__v(e.altKey?"--paint_scale":`--paint_scale_layer_${_}`,t)},range__v:(e,_)=>{const t=e.value;e.dataset.tip=t;const[,,a,n]=e.id.split("_");_&&_(a,n,t)},rangeEvent__v:e=>{PAI_o.range__v(e.target,((e,_,t)=>{PAI_o[`${e}_o`][`${_}_n`]=+t,DOM_o.rootVar__v(`--paint_${_}`,+t)}))},listener__v(){for(let e of["hue","sat","lum"]){for(let _ of["rangeX_n","rangeY_n"])for(let t of["click","keydown"])DOM_o.listener__v(`IN_paint_${e}_${_}`,PAI_o.rangeEvent__v,t);DOM_o.listener__v(`CA_paint_${e}_front`,PAI_o.eventHsl__v),DOM_o.listener__v(`LA_paint_${e}_trace`,PAI_o.backColor__v)}for(let e of["IN_paint_settings","DI_paint_settings","DI_paint_dock"])DOM_o.beforeNode__e(document.getElementById(e),"goto_screen_top");for(let e of["perspective","distance","rotate","scale"])for(let _ of["click","keydown"])DOM_o.listener__v(`IN_paint_dock_${e}`,PAI_o.rangeEvent__v,_);for(let e of["add","hide"])DOM_o.listener__v(`LA_paint_layer_${e}`,PAI_o[`${e}Layer__n`]);DOM_o.listener__v("UL_paint_layer_setop",PAI_o.setop__v)},init__v(){const e=["hue_back","hue_front","sat_back","sat_front","lum_back","lum_front"];PAI_o.worker_o=STAT_o.worker__o("paint",e,"Painter",PAI_o.message__v),PAI_o.addLayer__n(),PAI_o.addLayer__n();for(let _ of e)if(PAI_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"paint",hsl_s:_,back_hue_n:+DOM_o.rootVar__s("--paint_hue_back")}),_.endsWith("_back")){const e=_.slice(0,-"_back".length),t="hue"===e?360:100;DOM_o.rootVar__v(`--paint_${e}_trace`,-2*(t-document.getElementById(`output_paint_${e}`).value))}PAI_o.listener__v()}};PAI_o.init__v();