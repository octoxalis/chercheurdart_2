
const PAI_o={status_o:null,SCALE_H_n:1,SCALE_V_n:2,hue_o:{rangeX_n:50,rangeY_n:60},sat_o:{rangeX_n:50,rangeY_n:10},lum_o:{rangeX_n:50,rangeY_n:10},view_o:{perspective_n:1e3,distance_n:-100,rotation_n:0,scale_n:.25},layer_a:[],message__v:e=>{switch(e.task_s){case"PUT_status":PAI_o.status_o=e.status_o;break;case"PUT_error":console.log(`ERROR: ${e.error_s}`)}},layer__n:()=>Array.from(document.getElementById("UL_paint_layer_items").querySelectorAll("li")).length,layerIndex__s:e=>e.slice(e.lastIndexOf("_")+1),addLayer__n:(e="",_="")=>{const t=PAI_o.layer__n();if(t>=8)return void alert("Le nombre de plans maximum est atteint ");t>1&&PAI_o.displayOp__v(!0);let a=document.querySelector("body").dataset.work_s,n="Plan "+(t||"initial");_&&(n+=` &#8285; ${_}`);let o="",r="",l="";t&&(r=`input_${e||a}_${t}`,o=`<input id="${r}" data-layer_n=${t} type="checkbox">`,l=`for="${r}"`),DOM_o.appendNode__v(DOM_o.fragment__e(`<li data-layer_n=${t}>`+o+`<label ${l}>${n}</label></li>`),"UL_paint_layer_items");const[i,s]=document.querySelector("body").dataset.wh_s.split("_");let c=`<div id=DI_paint_layer_${t} data-layer_n=${t}><canvas id=CA_paint_layer_${t} width=${i} height=${s} data-layer_n=${t} data-size_n=1 title="Plan ${t}"></canvas>`;t>0&&(c+=`<canvas id=CA_paint_layer_front_${t} width=${i} height=${s} data-layer_n=${t} data-size_n=1 title="Plan ${t}"></canvas>`),c+="</div>",DOM_o.fragment__e(c,"DI_paint_layer_view");const d=document.getElementById(`CA_paint_layer_${t}`).transferControlToOffscreen(),p={task_s:"GET_img",rect_s:`${.5*+i} ${.5*+s} ${i} ${s}`,scale_n:1,url_s:`/assets/media/img/${a}/full/max/0/color.jpeg`,canvas_e:d,storeBitmap_b:!0,layer_n:t,pixel_n:window.devicePixelRatio},y=[d];if(t>0){document.getElementById(`CA_paint_layer_front_${t}`)}return PAI_o.worker_o.port_o.postMessage(p,y),document.getElementById(`DI_paint_layer_${t}`).lastChild.addEventListener("click",(e=>{t&&e.ctrlKey?PAI_o.drawClip__v(e.target):e.target.closest("div").classList.toggle("raised")})),PAI_o.layer_a.push({hue_o:{rangeX_n:0,rangeY_n:0},sat_o:{rangeX_n:0,rangeY_n:0},lum_o:{rangeX_n:0,rangeY_n:0},clipRect_a:[]}),t},drawClip__v:e=>{const _=e.dataset.layer_n,t=e.width,a=e.height;let n=document.getElementById(`CA_paint_layer_clip_${_}`);if(!n){let o=`<canvas id=CA_paint_layer_clip_${_} width=${t} height=${a} data-layer_n=${_}></canvas>`;DOM_o.fragment__e(o,e.id),n=document.getElementById(`CA_paint_layer_clip_${_}`)}let o=n.getContext("2d");o.strokeStyle="hsla( 190 80% 50% / .5 )",o.lineWidth=4;const r=[null,0,0,0],l=[0,0,n.width,n.height];new Pointer(e,((e,_)=>{null===r[0]&&(r[0]=~~e,r[1]=~~_),r[2]&&o.clearRect(...l),r[2]=~~e-r[0],r[3]=~~_-r[1],o.strokeRect(...r)}),(()=>{let[_,t,a,n]=r;a<0&&(_+=a,a=-a),n<0&&(t+=n,n=-n),PAI_o.addClip__v(e,[_,t,a,n])}))},addClip__v:(e,_)=>{const t=e.dataset.layer_n;PAI_o.layer_a[t].clipRect_a.push(_);let a=e.getContext("2d");for(rect_a of(a.fillStyle="hsla( 190 80% 50% / .25 )",a.fillRect(0,0,e.width,e.height),PAI_o.layer_a[t].clipRect_a))a.clearRect(...rect_a)},hideLayer__n:()=>{const e=PAI_o.selectedItem__a();if(!e.length){if(!PAI_o.masked__n())return void window.alert("Aucun plan n'est sélectionné.");if(!window.confirm("Aucun plan n'est sélectionné.\nVoulez-vous démasquer le premier plan masqué?"))return;let e=document.querySelector('#UL_paint_layer_items > li[data-layer_b="0"]');if(e){const _=e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${_}"]`)))PAI_o.unmask__v(node_e);return PAI_o.layer__n()>2&&PAI_o.displayOp__v(!0),_}}for(selected_e of(PAI_o.operable__a().length-e.length<3&&PAI_o.displayOp__v(!1),e)){const e=selected_e.dataset.layer_n;for(node_e of Array.from(document.querySelectorAll(`[data-layer_n="${e}"]`)))PAI_o.mask__v(node_e)}},setop__v:e=>{const _=e.target.closest("input")?.id;if(_){const t=_.slice(_.lastIndexOf("_")+1);if(t&&"none"!==t){if("deviation"===t)return void(e.target.dataset.tip=e.target.value);const _=PAI_o.operateOn__a();if(_.length<2)return window.alert("Deux plans doivent être sélectionnés pour effectuer cette opération.");let a=PAI_o.layerIndex__s(_[0].dataset.layer_n),n=PAI_o.layerIndex__s(_[1].dataset.layer_n),o="union"===t?"Union":"difference"===t?"Différence":"intersection"===t?"Intersection":"Complément";const r=PAI_o.addLayer__n(t,`${o} [ ${a} &#8728; ${n} ]`);r&&PAI_o[`${t}__v`](r,_)}}},selectedLayer__a:()=>Array.from(document.querySelectorAll('div:not([data-layer_n="0"]):not([data-layer_b="0"]).raised')),selectedItem__a:()=>Array.from(document.querySelectorAll('#UL_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"]) > input:checked')),operable__a:()=>Array.from(document.querySelectorAll('#UL_paint_layer_items > li[data-layer_n]:not([data-layer_b="0"])')),operateOn__a:()=>PAI_o.selectedItem__a().slice(-2),masked__n:()=>Array.from(document.getElementById("UL_paint_layer_items").querySelectorAll('li[data-layer_b="0"]'))?.length,mask__v:e=>{e.dataset.layer_b=0,e.checked&&(e.checked=!1)},unmask__v:e=>{e.removeAttribute("data-layer_b")},displayOp__v:e=>DOM_o.rootVar__v("--paint_setop_display",e?"block":"none"),none__v:(e,_)=>{console.log("none__v")},union__v:(e,_)=>{console.log("union__v")},difference__v:(e,_)=>{console.log("difference__v")},intersection__v:(e,_)=>{console.log("intersection__v")},complement__v:(e,_)=>{console.log("complement__v")},range__v:(e,_)=>{const t=e.value;e.dataset.tip=t;const[,,a,n]=e.id.split("_");_&&_(a,n,t)},rangeEvent__v:e=>{PAI_o.range__v(e.target,((e,_,t)=>{PAI_o[`${e}_o`][`${_}_n`]=+t,DOM_o.rootVar__v(`--paint_${_}`,+t)}))},hslPoint__v:e=>{const _=PAI_o.selectedLayer__a();if(!_.length)return void window.alert("Aucune image n'est sélectionnée.");const t=_[_.length-1].dataset.layer_n,{offsetX:a,offsetY:n}=e,[,,o]=e.target.id.split("_"),r=~~(+a/PAI_o.SCALE_H_n),l=~~(+n/PAI_o.SCALE_V_n);PAI_o.worker_o.post__v({task_s:"PUT_hsl",stat_s:"paint",layer_n:t,clip_a:PAI_o.layer_a[t].clipRect_a,hsl_s:o,rangeX_n:PAI_o[`${o}_o`].rangeX_n,atX_n:r,rangeY_n:PAI_o[`${o}_o`].rangeY_n,atY_n:l});const i="hue"===o?360:100;DOM_o.rootVar__v(`--paint_${o}_trace`,-2*(i-l)),document.getElementById(`output_paint_${o}`).value=l},backColor__v:e=>{e.preventDefault();const _=e.target.closest("label");if(_){const e=_.id.split("_")[2],t=document.querySelector(`label[id$="${e}_trace"] > output`).value;DOM_o.rootVar__v(`--paint_back_${e}`,+t),"hue"===e&&PAI_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"paint",part_s:"sat_front",hue_n:+DOM_o.rootVar__s("--paint_back_hue")})}},listener__v(){for(let e of["hue","sat","lum"]){for(let _ of["rangeX_n","rangeY_n"])for(let t of["click","keydown"])DOM_o.listener__v(`IN_paint_${e}_${_}`,PAI_o.rangeEvent__v,t);DOM_o.listener__v(`CA_paint_${e}_front`,PAI_o.hslPoint__v),DOM_o.listener__v(`LA_paint_${e}_trace`,PAI_o.backColor__v)}for(let e of["perspective","distance","rotate","scale"])for(let _ of["click","keydown"])DOM_o.listener__v(`IN_paint_view_${e}`,PAI_o.rangeEvent__v,_);for(let e of["add","hide"])DOM_o.listener__v(`LA_paint_layer_${e}`,PAI_o[`${e}Layer__n`]);DOM_o.listener__v("UL_paint_layer_setop",PAI_o.setop__v)},init__v(){const e=["hue_back","hue_front","sat_back","sat_front","lum_back","lum_front"];PAI_o.worker_o=STAT_o.worker__o("paint",e,"Painter",PAI_o.message__v),PAI_o.addLayer__n(),PAI_o.addLayer__n();for(let _ of e)if(PAI_o.worker_o.post__v({task_s:"PUT_draw",stat_s:"paint",part_s:_,hue_n:+DOM_o.rootVar__s("--paint_back_hue")}),_.endsWith("_back")){const e=_.slice(0,-"_back".length),t="hue"===e?360:100;DOM_o.rootVar__v(`--paint_${e}_trace`,-2*(t-document.getElementById(`output_paint_${e}`).value))}PAI_o.listener__v()}};PAI_o.init__v();