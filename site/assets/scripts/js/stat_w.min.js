
class Idb{constructor(_="kv_db",t="kv_store",o=1){this.idb_o=null,this.ready_o=null,this.idb_s=_,this.store_s=t,this.version_n=o,this.init__v()}init__v(){this.ready_o=new Promise(((_,t)=>{const o=indexedDB.open(this.idb_s,this.version_n);o.onupgradeneeded=_=>{this.idb_o=_.target.result,this.idb_o.createObjectStore(this.store_s)},o.onsuccess=t=>{this.idb_o=t.target.result,_(t.target.result)},o.onerror=_=>t(_.target.error)}))}store__o(_="readonly"){return this.idb_o.transaction([this.store_s],_).objectStore(this.store_s)}set__v(_,t){return this.ready_o.then((()=>new Promise(((o,a)=>{const e=this.store__o("readwrite").put(t,_);e.onsuccess=o,e.onerror=a}))))}update__v(_,t,o){return this.ready_o.then((()=>new Promise(((a,e)=>{const s=this.store__o("readwrite"),n=s.get(_);n.onsuccess=()=>{const r=n.result;r[t]=o;const c=s.put(r,_);c.onsuccess=a,c.onerror=e},n.onerror=e}))))}walk__v(_){return this.ready_o.then((()=>new Promise(((t,o)=>{const a=this.store__o().openCursor();a.onsuccess=o=>{let a=o.target.result;a?(_(a.key,a.value),a.continue()):t()},a.onerror=o}))))}get__(_){return this.ready_o.then((()=>new Promise(((t,o)=>{const a=this.store__o().get(_);a.onsuccess=_=>t(_.target.result),a.onerror=o}))))}key__b(_){return this.ready_o.then((()=>new Promise(((t,o)=>{const a=this.store__o().count(_);a.onsuccess=_=>t(_.target.result),a.onerror=o}))))}last__(){return this.ready_o.then((()=>new Promise(((_,t)=>{const o=this.store__o("readwrite").openCursor(null,"prev");o.onsuccess=t=>{t.target.result&&_(t.target.result.value)},o.onerror=t}))))}deleteAll__v(_){return this.ready_o.then((()=>new Promise(((t,o)=>{const a=this.store__o("readwrite"),e=store.openCursor();e.onsuccess=t=>{let o,e=t.target.result;e&&(o=e.value,_(o)&&a.delete(e.key),e.continue())},e.onerror=o}))))}delete__v(_){return this.ready_o.then((()=>new Promise(((t,o)=>{const a=this.store__o("readwrite").delete(_);a.onsuccess=t,a.onerror=o}))))}clear__v(){return this.ready_o.then((()=>new Promise(((_,t)=>{const o=this.store__o("readwrite").clear();o.onsuccess=_,o.onerror=t}))))}deleteIDB__v(){indexedDB.deleteDatabase(this.idb_s)}}const RGB_H__n=(_,t,o)=>{const a=Math.max(_,t,o),e=Math.min(_,t,o);if(a===e)return 0;const s=a-e;return~~(60*(a===_?(t-o)/s+(t<o?6:0):a===t?(o-_)/s+2:(_-t)/s+4))},RGB_S__n=(_,t,o)=>{const a=Math.max(_,t,o),e=Math.min(_,t,o),s=a-e;if(!s)return 0;const n=e+a;return n>255?s/(510-s):s/n},RGB_L__n=(_,t,o)=>(Math.min(_,t,o)+Math.max(_,t,o))/510,STAT_W_o={port_o:null,pixel_n:1,status_o:{scan_b:!1},url_o:{},message_a:["GET_scan","GET_status","GET_rate","GET_level","GET_img","GET_canvas_img","PUT_canvas","PUT_draw","PUT_slot","PUT_hsl","PUT_scale","PUT_slideshow"],scan_a:null,SCAN_hue_n:0,SCAN_hue_rate_n:1,SCAN_hue_rank_n:2,SCAN_sat_n:3,SCAN_sat_rate_n:4,SCAN_sat_rank_n:5,SCAN_lum_n:6,SCAN_lum_rate_n:7,SCAN_lum_rank_n:8,stat_o:{},script_o:new Set,imgData_o:{},imgLayer_a:[],imgBitmap_a:new Map,slideShow_n:void 0,script__v(_){if(_){let t=[];for(let o of _.split(" "))STAT_W_o.script_o.has(o)||(STAT_W_o.script_o.add(o),t.push(`${o}.min.js`));t.length&&self.importScripts(...t)}},async bitmap__o(_){try{let{stat_s:t,rect_s:o,scale_n:a,url_s:e,storeBitmap_b:s}=_;if(STAT_W_o.imgBitmap_a.has(e))return STAT_W_o.imgBitmap_a.get(e);let[n,r,c,T]=o.split(" ");e.match(/\d{2}-\d{2}-\d{4}_\d{2}-\d{2}-\d{2}/)&&(e=STAT_W_o.url_o[e]);const l=await fetch(e),i=await l.blob();return bitmap_o=await createImageBitmap(i,n-c/a*.5,r-T/a*.5,c/a,T/a,{resizeWidth:c,resizeHeight:T,resizeQuality:"high"}),s&&STAT_W_o.imgBitmap_a.set(e,bitmap_o),bitmap_o}catch(_){return console.log(`ERROR DETECTED @bitmap__o(): ${_}`),null}},clearData__v(_,t,o){const a=t.data;for(let _=0;_<a.length;_+=4)a[_+3]=o;_.putImageData(t,0,0)},scale__n(_,t,o){const{width:a,height:e}=STAT_W_o.stat_o[`${_}_o`][`${t}_o`].canvas_o;STAT_W_o.stat_o[`${_}_o`][`${t}_o`].context_o.clearRect(0,0,a,e);const s=.5*a*(1-o);STAT_W_o.stat_o[`${_}_o`][`${t}_o`].context_o.setTransform(o,0,0,o,s,s)},slot__a(_,t){let o;if(360!==t&&101!==t){let a=360/t,e=_*a;o=[e,e+a-1]}else o=[_];return o},stopSlideshow__v(){clearInterval(STAT_W_o.slideShow_n),STAT_W_o.slideShow_n=void 0},get_status__v(){STAT_W_o.post__v({task_s:"PUT_status",status_o:STAT_W_o.status_o},[STAT_W_o.status_o])},async get_scan__v(_){if(!STAT_W_o.scan_a){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
const t=_.work_s;let o;if(t.match(/\d{2}-\d{2}-\d{4}_\d{2}-\d{2}-\d{2}/)){STAT_W_o.idb_o=new Idb("chercheurdart_idb","chercheurdart_store");const _=await STAT_W_o.idb_o.get__(t);o=JSON.parse(_).src_s,STAT_W_o.url_o[t]=o}else o=`/assets/media/img/${_.work_s}/full/max/0/color.jpeg`;const a=await fetch(o),e=await a.blob(),s=await createImageBitmap(e),n=new OffscreenCanvas(s.width,s.height).getContext("2d");n.drawImage(s,0,0);const r=n.getImageData(0,0,s.width,s.height);STAT_W_o.capacity_n=s.width*s.height,STAT_W_o.scan_a=new Array(1+STAT_W_o.SCAN_lum_rank_n);let c,T,l,i=360;for(STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n]=new Array(i),STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n]=new Array(i);--i>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n][i]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n][i]=0;for(i=101,STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n]=new Array(i),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n]=new Array(i);--i>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n][i]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n][i]=0;for(i=101,STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n]=new Array(i),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n]=new Array(i);--i>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n][i]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n][i]=0;for(let _=0;_<r.data.length;_+=4){c=r.data[_],T=r.data[_+1],l=r.data[_+2];let t=RGB_H__n(c,T,l);STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n][t].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n][t]+=1;let o=~~(100*RGB_S__n(c,T,l));STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n][o].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n][o]+=1;let a=~~(100*RGB_L__n(c,T,l));STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n][a].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n][a]+=1}const S=_=>{const t=_.length;let o=new Array(t);for(let a=0;a<t;++a)o[a]=[_[a],a];return o.sort(((_,t)=>t[0]-_[0])),o};STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n]),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n]),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n])}},get_rate__v(_){const{hsl_s:t,angle_n:o,slot_n:a}=_,e=STAT_W_o.slot__a(o,a),s=STAT_W_o.stat_o.burst_o[`${t}_o`].slot_a[o],n=s?s.rate_n:0;STAT_W_o.post__v({task_s:"PUT_rate",hsl_s:t,rate_n:n,slot_a:e,capacity_n:STAT_W_o.capacity_n,level_a:STAT_W_o.stat_o.burst_o[`${t}_o`].burst_c.level__a(o)},[STAT_W_o.stat_o.burst_o[`${t}_o`].burst_c.level__a(o)])},get_level__v(_){const{stat_s:t,hsl_s:o}=_;STAT_W_o.post__v({task_s:"PUT_level",stat_s:"burst",hsl_s:o,level_a:STAT_W_o.stat_o[`${t}_o`][`${o}_o`].burst_c.level__a()},[STAT_W_o.stat_o[`${t}_o`][`${o}_o`].burst_c.level__a()])},async get_img__v(_){try{const t=await STAT_W_o.bitmap__o(_);if(t){const o=_.canvas_e,a=o.getContext("2d");a.drawImage(t,0,0);const e=a.getImageData(0,0,o.width,o.height),s=_.stat_s;if("burst"===s)return void(STAT_W_o.imgData_o[s]={canvas_e:o,context_o:a,imgData_o:e});if(_.storeBitmap_b){const t={canvas_e:_.canvas_e,context_o:a,imgData_o:e};_.layer_n&&(t.layer_n=_.layer_n),STAT_W_o.imgLayer_a.push(t)}}}catch(_){console.log(`ERROR DETECTED @get_img__v(): ${_}`)}},async get_canvas_img__v(_){const{stat_s:t}=_,o=STAT_W_o.imgData_o[t].canvas_e;let a=await o.convertToBlob({type:"image/jpeg",quality:.95});STAT_W_o.post__v({task_s:"PUT_canvas_img",blob_o:a},[a])},put_canvas__v(_){STAT_W_o.pixel_n=_.pixel_n;const{stat_s:t,hsl_s:o}=_;STAT_W_o.stat_o[`${t}_o`]||(STAT_W_o.stat_o[`${t}_o`]={}),STAT_W_o.stat_o[`${t}_o`][`${o}_o`]={},STAT_W_o.stat_o[`${t}_o`][`${o}_o`].canvas_o=_.canvas_e;const a=_.canvas_e.getContext("2d");STAT_W_o.pixel_n=_.pixel_n,STAT_W_o.stat_o[`${t}_o`][`${o}_o`].context_o=a,STAT_W_o.stat_o[`${t}_o`][`${o}_o`].painter_c=new Painter(a)},put_draw__v(_){let t,{stat_s:o,hsl_s:a,back_hue_n:e,rangeY_n:s,shift_n:n,thresh_o:r}=_,[c,T]=a.split("_");switch(o){case"burst":const T=s;let l=0;if("hue"===c)l=360;else l=101;switch(t=STAT_W_o.stat_o[`${o}_o`][`${a}_o`].painter_c,a){case"hue_back":for(let _=0;_<360;++_){let o=_+n%360;t.fill__c([o,100,50]).rect__c(0,2*_,t.context_o.canvas.width,2,"fill")}break;case"hue_front":for(let _=0;_<360;++_){let o=(Math.floor(_/T)*T+n)%360;t.fill__c([o,100,50]).rect__c(0,2*_,t.context_o.canvas.width,2,"fill")}}STAT_W_o.stat_o[`${o}_o`][`${c}_o`].slot_a=[];const i=STAT_W_o.scan_a[STAT_W_o[`SCAN_${c}_rate_n`]].slice(0,n),S=STAT_W_o.scan_a[STAT_W_o[`SCAN_${c}_rate_n`]].slice(n).concat(i);let A=0,h=0,u=0,W=-1,d=-1;for(let _ of S){let t,s,r;switch(++W,++d,h=W,a){case"hue":t=(W+n)%360,s=100,r=50;break;case"sat":t=e,s=W,r=50;break;case"lum":t=e,s=0,r=W;break;case"hue_front":if(T>1&&d<T-1&&(A+=_,W<360))continue;A>u&&(u=A),A&&(_=A),t=(Math.floor(h/T)*T+n)%360,s=100,r=50,A=0,d=-1}STAT_W_o.stat_o[`${o}_o`][`${c}_o`].slot_a.push(_?{rate_n:_,hsl_a:[t,s,r]}:null)}if("hue_back"===a)return;const g=STAT_W_o.stat_o[`${o}_o`][`${c}_o`].canvas_o.width,m={rate_a:STAT_W_o.stat_o[`${o}_o`][`${c}_o`].slot_a,capacity_n:"hue_front"===a?STAT_W_o.stat_o[`${o}_o`][`${c}_o`].slot_a.length:l,canvas_o:STAT_W_o.stat_o[`${o}_o`][`${c}_o`].canvas_o,center_n:.5*g,maxRate_n:u||STAT_W_o.scan_a[STAT_W_o[`SCAN_${c}_rank_n`]][0][0],maxpos_n:g,thresh_o:r};STAT_W_o.stat_o[`${o}_o`][`${c}_o`].burst_c=new ColorBurst(m);break;case"paint":switch(t=STAT_W_o.stat_o[`${o}_o`][`${a}_o`].painter_c,c){case"hue":for(let _=0;_<360;++_)t.fill__c([_,100,50]).rect__c(0,2*_,100,2,"fill");break;case"sat":for(let o=0;o<101;++o)t.fill__c([_.hue_n,o,50]).rect__c(0,2*o,100,2,"fill");break;case"lum":for(let _=0;_<101;++_)t.fill__c([0,0,_]).rect__c(0,2*_,100,2,"fill")}}},put_hsl__v(_){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
let{stat_s:t,hsl_s:o,operand_a:a,operation_s:e,deviation_n:s,rangeX_n:n,atX_n:r,rangeY_n:c,atY_n:T}=_;const l=r/n;let i=~~l;l>1&&++i,i*=n,i>100&&(i=100);let S=~~(2.559*i),A=.01*i+.001;T*=2,c*=2,STAT_W_o.stat_o[`${t}_o`][`${o}_front_o`].painter_c.fill__c([190,28,17,1]).rect__c(i,T,100-i,c,"fill").rect__c(0,T,i,c,"clear").fill__c([0,0,100,1-A]).rect__c(0,T,i,c,"fill");const h=_.atY_n;let u=h+_.rangeY_n;const W="hue"===o?359:100;u>W&&(u=W);const d=STAT_W_o.scan_a[STAT_W_o[`SCAN_${o}_n`]],g=[];for(let _ of a)g.push({layer_o:STAT_W_o.imgLayer_a.find((t=>t.layer_n===+_.layer_n)),clipRect_a:_.clipRect_a});let m,p;e&&"none"!==e&&(m=g[0].layer_o.imgData_o,p=g?.[1]?.layer_o?.imgData_o,g.splice(0,2));for(let _ of g){const t=_.layer_o.context_o,o=_.layer_o.imgData_o,a=o.data;let n,r,c;for(n=h;n<u;++n){let _,t,o;r=d[n],c=r.length;let T=!0;for(atScan_n=0;atScan_n<c;++atScan_n){if(m&&p)switch(_=m[r[atScan_n]+3],t=p[r[atScan_n]+3],o=~~(_-t),e){case"union":T=_&&t;break;case"difference":T=o>s;break;case"intersection":T=o<=s;break;case"complement":T=_&&!t}T&&(a[r[atScan_n]+3]=S)}}const T=_.clipRect_a.length?_.clipRect_a:[[0,0,_.layer_o.canvas_e.width,_.layer_o.canvas_e.height]];for(let _ of T)t.putImageData(o,0,0,..._)}
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
},put_slot__v(_){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
const{stat_s:t,hsl_s:o,angle_n:a,range_n:e,opacity_n:s,dim_a:n}=_,r=360/e,c=r*a,T=c+r,l=STAT_W_o.scan_a[STAT_W_o[`SCAN_${o}_n`]],{context_o:i,imgData_o:S}=STAT_W_o.imgData_o[`${t}`],A=S.data;let h,u,W,d;for(h=0;h<360;++h)for(d=h>=c&&h<T?255:s,u=l[h],W=u.length,atScan_n=0;atScan_n<W;++atScan_n)A[u[atScan_n]+3]=d;i.putImageData(S,0,0);
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
},put_scale__v(_){const{stat_s:t,hsl_s:o,scale_n:a,burst_b:e}=_;STAT_W_o.scale__n(t,o,a),e&&STAT_W_o.stat_o[`${t}_o`][`${o}_o`].burst_c.draw__v()},put_slideshow__v(_){let//!!! mutable speed_n
{stat_s:t,speed_n:o,opacity_n:a}=_;if(!o&&STAT_W_o.slideShow_n)return void STAT_W_o.stopSlideshow__v();const e=Array.from(STAT_W_o.stat_o.burst_o.hue_o.slot_a);e.sort(((_,t)=>null===_?1:null===t?-1:t.rate_n-_.rate_n));const s=STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n],{context_o:n,imgData_o:r}=STAT_W_o.imgData_o[`${t}`],c=r.data;STAT_W_o.clearData__v(n,r,a);const T=360/e.length;let l=e.length;STAT_W_o.slideShow_n=setInterval((()=>{if(!(l-- >-1))return STAT_W_o.post__v({task_s:"PUT_hue",stat_s:"burst",hue_a:null}),void STAT_W_o.stopSlideshow__v();{const _=e[l];if(_){const t=_.hsl_a[0],o=t+T;let a,e,l;for(STAT_W_o.post__v({task_s:"PUT_hue",stat_s:"burst",hue_a:[t,o]}),a=t;a<o;++a)if(e=s[a],e)for(l=e.length,atScan_n=0;atScan_n<l;++atScan_n)c[e[atScan_n]+3]=255;n.putImageData(r,0,0)}}}),o)},message__v(_){const t=_.data;STAT_W_o.script__v(t.script_s);const o=t.task_s;if(STAT_W_o.message_a.includes(o)){const _=o.toLowerCase()+"__v";STAT_W_o[_](t)}},post__v(_){STAT_W_o.port_o.postMessage(_)},handleError__v(_){console.log`ERROR: ${_.message}`}};onconnect=_=>{STAT_W_o.port_o=_.ports[0],STAT_W_o.port_o.onmessage=STAT_W_o.message__v,STAT_W_o.port_o.onmessageerror=STAT_W_o.handleError__v};