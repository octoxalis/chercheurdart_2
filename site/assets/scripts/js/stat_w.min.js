
class Idb{constructor(_="kv_db",t="kv_store",a=1){this.idb_o=null,this.ready_o=null,this.idb_s=_,this.store_s=t,this.version_n=a,this.init__v()}init__v(){this.ready_o=new Promise(((_,t)=>{const a=indexedDB.open(this.idb_s,this.version_n);a.onupgradeneeded=_=>{this.idb_o=_.target.result,this.idb_o.createObjectStore(this.store_s)},a.onsuccess=t=>{this.idb_o=t.target.result,_(t.target.result)},a.onerror=_=>t(_.target.error)}))}store__o(_="readonly"){return this.idb_o.transaction([this.store_s],_).objectStore(this.store_s)}set__v(_,t){return this.ready_o.then((()=>new Promise(((a,o)=>{const e=this.store__o("readwrite").put(t,_);e.onsuccess=a,e.onerror=o}))))}update__v(_,t,a){return this.ready_o.then((()=>new Promise(((o,e)=>{const s=this.store__o("readwrite"),n=s.get(_);n.onsuccess=()=>{const r=n.result;r[t]=a;const T=s.put(r,_);T.onsuccess=o,T.onerror=e},n.onerror=e}))))}walk__v(_){return this.ready_o.then((()=>new Promise(((t,a)=>{const o=this.store__o().openCursor();o.onsuccess=a=>{let o=a.target.result;o?(_(o.key,o.value),o.continue()):t()},o.onerror=a}))))}get__(_){return this.ready_o.then((()=>new Promise(((t,a)=>{const o=this.store__o().get(encodeURI(_));o.onsuccess=_=>t(_.target.result),o.onerror=a}))))}key__b(_){return this.ready_o.then((()=>new Promise(((t,a)=>{const o=this.store__o().count(encodeURI(_));o.onsuccess=_=>t(_.target.result),o.onerror=a}))))}last__(){return this.ready_o.then((()=>new Promise(((_,t)=>{const a=this.store__o("readwrite").openCursor(null,"prev");a.onsuccess=t=>{t.target.result&&_(t.target.result.value)},a.onerror=t}))))}deleteAll__v(_){return this.ready_o.then((()=>new Promise(((t,a)=>{const o=this.store__o("readwrite"),e=o.openCursor();e.onsuccess=t=>{let a,e=t.target.result;e&&(a=e.value,_(a)&&o.delete(e.key),e.continue())},e.onerror=a}))))}delete__v(_){return this.ready_o.then((()=>new Promise(((t,a)=>{const o=this.store__o("readwrite").delete(encodeURI(_));o.onsuccess=t,o.onerror=a}))))}clear__v(){return this.ready_o.then((()=>new Promise(((_,t)=>{const a=this.store__o("readwrite").clear();a.onsuccess=_,a.onerror=t}))))}deleteIDB__v(){indexedDB.deleteDatabase(this.idb_s)}}const RGB_H__n=(_,t,a)=>{const o=Math.max(_,t,a),e=Math.min(_,t,a);if(o===e)return 0;const s=o-e;return~~(60*(o===_?(t-a)/s+(t<a?6:0):o===t?(a-_)/s+2:(_-t)/s+4))},RGB_S__n=(_,t,a)=>{const o=Math.max(_,t,a),e=Math.min(_,t,a),s=o-e;if(!s)return 0;const n=e+o;return n>255?s/(510-s):s/n},RGB_L__n=(_,t,a)=>(Math.min(_,t,a)+Math.max(_,t,a))/510,STAT_W_o={port_o:null,pixel_n:1,status_o:{scan_b:!1},url_o:{},message_a:["GET_scan","GET_status","GET_rate","GET_equal","GET_img","GET_canvas_img","PUT_canvas","PUT_draw","PUT_slot","PUT_hsl","PUT_scale","PUT_slides"],scan_a:null,SCAN_hue_n:0,SCAN_hue_rate_n:1,SCAN_hue_rank_n:2,SCAN_sat_n:3,SCAN_sat_rate_n:4,SCAN_sat_rank_n:5,SCAN_lum_n:6,SCAN_lum_rate_n:7,SCAN_lum_rank_n:8,stat_o:{},script_o:new Set,imgData_o:{},imgLayer_a:[],imgBitmap_a:new Map,slideStack_o:{slide_n:0,interval_n:0,pause_b:!1},script__v(_){if(_){let t=[];for(let a of _.split(" "))STAT_W_o.script_o.has(a)||(STAT_W_o.script_o.add(a),t.push(`${a}.min.js`));t.length&&self.importScripts(...t)}},async bitmap__o(_){try{let{stat_s:t,rect_s:a,scale_n:o,url_s:e,storeBitmap_b:s}=_;if(STAT_W_o.imgBitmap_a.has(e))return STAT_W_o.imgBitmap_a.get(e);let[n,r,T,c]=a.split(" ");e.match(/\d{2}-\d{2}-\d{4}_\d{2}-\d{2}-\d{2}/)&&(e=STAT_W_o.url_o[e]);const l=await fetch(e),i=await l.blob(),S=await createImageBitmap(i,n-T/o*.5,r-c/o*.5,T/o,c/o,{resizeWidth:T,resizeHeight:c,resizeQuality:"high"});return s&&STAT_W_o.imgBitmap_a.set(e,S),S}catch(_){return console.log(`ERROR DETECTED @bitmap__o(): ${_}`),null}},clearData__v(_,t,a){const o=t.data;for(let _=0;_<o.length;_+=4)o[_+3]=a;_.putImageData(t,0,0)},scale__n(_,t,a){const{width:o,height:e}=STAT_W_o.stat_o[`${_}_o`][`${t}_o`].canvas_o;STAT_W_o.stat_o[`${_}_o`][`${t}_o`].context_o.clearRect(0,0,o,e);const s=.5*o*(1-a);STAT_W_o.stat_o[`${_}_o`][`${t}_o`].context_o.setTransform(a,0,0,a,s,s)},slot__a(_,t){let a;if(360!==t&&101!==t){let o=360/t,e=_*o;a=[e,e+o-1]}else a=[_];return a},get_status__v(){STAT_W_o.post__v({task_s:"PUT_status",status_o:STAT_W_o.status_o},[STAT_W_o.status_o])},async get_scan__v(_){if(!STAT_W_o.scan_a){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
const t=_.key_s;let a;if(t.match(/\d{2}-\d{2}-\d{4}_\d{2}-\d{2}-\d{2}/)){STAT_W_o.idb_o=new Idb("chercheurdart_idb","chercheurdart_store");const _=await STAT_W_o.idb_o.get__(t);a=JSON.parse(_).src_s,STAT_W_o.url_o[t]=a}else a=`/assets/media/img/${_.key_s}.jpeg`;const o=await fetch(a),e=await o.blob(),s=await createImageBitmap(e),n=new OffscreenCanvas(s.width,s.height).getContext("2d");n.drawImage(s,0,0);const r=n.getImageData(0,0,s.width,s.height);STAT_W_o.capacity_n=s.width*s.height,STAT_W_o.scan_a=new Array(1+STAT_W_o.SCAN_lum_rank_n);let T,c,l,i=360;for(STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n]=new Array(i),STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n]=new Array(i);--i>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n][i]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n][i]=0;for(i=101,STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n]=new Array(i),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n]=new Array(i);--i>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n][i]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n][i]=0;for(i=101,STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n]=new Array(i),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n]=new Array(i);--i>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n][i]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n][i]=0;for(let _=0;_<r.data.length;_+=4){T=r.data[_],c=r.data[_+1],l=r.data[_+2];let t=RGB_H__n(T,c,l);STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n][t].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n][t]+=1;let a=~~(100*RGB_S__n(T,c,l));STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n][a].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n][a]+=1;let o=~~(100*RGB_L__n(T,c,l));STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n][o].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n][o]+=1}const S=_=>{const t=_.length;let a=new Array(t);for(let o=0;o<t;++o)a[o]=[_[o],o];return a.sort(((_,t)=>t[0]-_[0])),a};STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n]),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n]),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n])}},get_rate__v(_){const{hsl_s:t,angle_n:a,slot_n:o}=_,e=STAT_W_o.slot__a(a,o),s=STAT_W_o.stat_o.burst_o[`${t}_o`].slot_a[a],n=s?s.rate_n:0;STAT_W_o.post__v({task_s:"PUT_rate",hsl_s:t,rate_n:n,capacity_n:STAT_W_o.capacity_n,slot_n:o,slot_a:e,equal_a:STAT_W_o.stat_o.burst_o[`${t}_o`].burst_c.equal__a(a)},[STAT_W_o.stat_o.burst_o[`${t}_o`].burst_c.equal__a(a)])},get_equal__v(_){const{stat_s:t,hsl_s:a}=_;STAT_W_o.post__v({task_s:"PUT_equal",stat_s:"burst",hsl_s:a,equal_a:STAT_W_o.stat_o[`${t}_o`][`${a}_o`].burst_c.equal__a()},[STAT_W_o.stat_o[`${t}_o`][`${a}_o`].burst_c.equal__a()])},async get_img__v(_){try{const t=await STAT_W_o.bitmap__o(_);if(t){const a=_.canvas_e,o=a.getContext("2d");o.drawImage(t,0,0);const e=o.getImageData(0,0,a.width,a.height),s=_.stat_s;if("burst"===s)return void(STAT_W_o.imgData_o[s]={canvas_e:a,context_o:o,imgData_o:e});if(_.storeBitmap_b){const t={canvas_e:_.canvas_e,context_o:o,imgData_o:e};_.layer_n&&(t.layer_n=_.layer_n),STAT_W_o.imgLayer_a.push(t)}}}catch(_){console.log(`ERROR DETECTED @get_img__v(): ${_}`)}},async get_canvas_img__v(_){console.time("get_canvas_img__v");const{stat_s:t,hsl_s:a,rgb_a:o,img_b:e}=_;let s,n,r,T;if(e?(s=STAT_W_o.imgData_o[t].canvas_e,n=STAT_W_o.imgData_o[t].imgData_o):(s=STAT_W_o.stat_o[`${t}_o`][`${a}_o`].canvas_o,n=STAT_W_o.stat_o[`${t}_o`][`${a}_o`].context_o.getImageData(0,0,s.width,s.height)),o){const[_,t,a]=o,e=n.data,r=new Uint8ClampedArray(e);for(let o=0;o<e.length;o+=4)255===e[o+3]?(r[o]=e[o],r[o+1]=e[o+1],r[o+2]=e[o+2],r[o+3]=e[o+3]):(r[o]=_,r[o+1]=t,r[o+2]=a,r[o+3]=e[o+3]);const{width:c,height:l}=s;T=new OffscreenCanvas(c,l);const i=new ImageData(r,c);T.getContext("2d").putImageData(i,0,0)}else T=s;r=await T.convertToBlob({type:"image/jpeg",quality:.95}),console.timeEnd("get_canvas_img__v"),STAT_W_o.post__v({task_s:"PUT_canvas_img",blob_o:r},[r])},put_canvas__v(_){STAT_W_o.pixel_n=_.pixel_n;const{stat_s:t,hsl_s:a}=_;STAT_W_o.stat_o[`${t}_o`]||(STAT_W_o.stat_o[`${t}_o`]={}),STAT_W_o.stat_o[`${t}_o`][`${a}_o`]={},STAT_W_o.stat_o[`${t}_o`][`${a}_o`].canvas_o=_.canvas_e;const o=_.canvas_e.getContext("2d");STAT_W_o.pixel_n=_.pixel_n,STAT_W_o.stat_o[`${t}_o`][`${a}_o`].context_o=o,STAT_W_o.stat_o[`${t}_o`][`${a}_o`].painter_c=new Painter(o)},put_draw__v(_){let t,{stat_s:a,hsl_s:o,back_hue_n:e,rangeY_n:s,shift_n:n,thresh_o:r}=_,[T,c]=o.split("_");switch(a){case"burst":const c=s;let l=0;if("hue"===T)l=360;else l=101;switch(t=STAT_W_o.stat_o[`${a}_o`][`${o}_o`].painter_c,o){case"hue_back":for(let _=0;_<360;++_){let a=_+n%360;t.fill__c([a,100,50]).rect__c(0,2*_,t.context_o.canvas.width,2,"fill")}break;case"hue_front":for(let _=0;_<360;++_){let a=(Math.floor(_/c)*c+n)%360;t.fill__c([a,100,50]).rect__c(0,2*_,t.context_o.canvas.width,2,"fill")}}STAT_W_o.stat_o[`${a}_o`][`${T}_o`].slot_a=[];const i=STAT_W_o.scan_a[STAT_W_o[`SCAN_${T}_rate_n`]].slice(0,n),S=STAT_W_o.scan_a[STAT_W_o[`SCAN_${T}_rate_n`]].slice(n).concat(i);let A=0,u=0,W=0,h=-1,d=-1;for(let _ of S){let t,s,r;switch(++h,++d,u=h,o){case"hue":t=(h+n)%360,s=100,r=50;break;case"sat":t=e,s=h,r=50;break;case"lum":t=e,s=0,r=h;break;case"hue_front":if(c>1&&d<c-1&&(A+=_,h<360))continue;A>W&&(W=A),A&&(_=A),t=(Math.floor(u/c)*c+n)%360,s=100,r=50,A=0,d=-1}STAT_W_o.stat_o[`${a}_o`][`${T}_o`].slot_a.push(_?{rate_n:_,hsl_a:[t,s,r]}:null)}if("hue_back"===o)return;const g=STAT_W_o.stat_o[`${a}_o`][`${T}_o`].canvas_o.width,m={rate_a:STAT_W_o.stat_o[`${a}_o`][`${T}_o`].slot_a,capacity_n:"hue_front"===o?STAT_W_o.stat_o[`${a}_o`][`${T}_o`].slot_a.length:l,canvas_o:STAT_W_o.stat_o[`${a}_o`][`${T}_o`].canvas_o,center_n:.5*g,maxRate_n:W||STAT_W_o.scan_a[STAT_W_o[`SCAN_${T}_rank_n`]][0][0],maxpos_n:g,thresh_o:r};STAT_W_o.stat_o[`${a}_o`][`${T}_o`].burst_c=new ColorBurst(m);break;case"paint":switch(t=STAT_W_o.stat_o[`${a}_o`][`${o}_o`].painter_c,T){case"hue":for(let _=0;_<360;++_)t.fill__c([_,100,50]).rect__c(0,2*_,100,2,"fill");break;case"sat":for(let a=0;a<101;++a)t.fill__c([_.hue_n,a,50]).rect__c(0,2*a,100,2,"fill");break;case"lum":for(let _=0;_<101;++_)t.fill__c([0,0,_]).rect__c(0,2*_,100,2,"fill")}}},put_hsl__v(_){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
let{stat_s:t,hsl_s:a,operand_a:o,operation_s:e,deviation_n:s,rangeX_n:n,atX_n:r,rangeY_n:T,atY_n:c}=_;const l=r/n;let i=~~l;l>1&&++i,i*=n,i>100&&(i=100);let S=~~(2.559*i),A=.01*i+.001;c*=2,T*=2,STAT_W_o.stat_o[`${t}_o`][`${a}_front_o`].painter_c.fill__c([190,28,17,1]).rect__c(i,c,100-i,T,"fill").rect__c(0,c,i,T,"clear").fill__c([0,0,100,1-A]).rect__c(0,c,i,T,"fill");const u=_.atY_n;let W=u+_.rangeY_n;const h="hue"===a?359:100;W>h&&(W=h);const d=STAT_W_o.scan_a[STAT_W_o[`SCAN_${a}_n`]],g=[];for(let _ of o)g.push({layer_o:STAT_W_o.imgLayer_a.find((t=>t.layer_n===+_.layer_n)),clipRect_a:_.clipRect_a});let m,p;e&&"none"!==e&&(m=g[0].layer_o.imgData_o,p=g?.[1]?.layer_o?.imgData_o,g.splice(0,2));for(let _ of g){const t=_.layer_o.context_o,a=_.layer_o.imgData_o,o=a.data;let n,r,T;for(n=u;n<W;++n){let _,t,a;r=d[n],T=r.length;let c=!0;for(atScan_n=0;atScan_n<T;++atScan_n){if(m&&p)switch(_=m[r[atScan_n]+3],t=p[r[atScan_n]+3],a=~~(_-t),e){case"union":c=_&&t;break;case"difference":c=a>s;break;case"intersection":c=a<=s;break;case"complement":c=_&&!t}c&&(o[r[atScan_n]+3]=S)}}const c=_.clipRect_a.length?_.clipRect_a:[[0,0,_.layer_o.canvas_e.width,_.layer_o.canvas_e.height]];for(let _ of c)t.putImageData(a,0,0,..._)}
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
},put_slot__v(_){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
const{stat_s:t,hsl_s:a,angle_n:o,range_n:e,opacity_n:s,stack_b:n,dim_a:r}=_,T=360/e,c=T*o,l=c+T,i=STAT_W_o.scan_a[STAT_W_o[`SCAN_${a}_n`]],{context_o:S,imgData_o:A}=STAT_W_o.imgData_o[`${t}`],u=A.data;let W,h,d,g;for(W=0;W<360;++W)for(W>=c&&W<l?g=255:n||(g=s),h=i[W],d=h.length,atScan_n=0;atScan_n<d;++atScan_n)g&&(u[h[atScan_n]+3]=g);S.putImageData(A,0,0);
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
},put_scale__v(_){const{stat_s:t,hsl_s:a,scale_n:o,burst_b:e}=_;STAT_W_o.scale__n(t,a,o),e&&STAT_W_o.stat_o[`${t}_o`][`${a}_o`].burst_c.draw__v()},put_slides__v(_){const//!!! mutable interval_n
{id_s:t,interval_n:a,shift_n:o,limit_n:e,opacity_n:s}=_;switch(t){case"stop":return void STAT_W_o.stopSlide__v();case"reset":return STAT_W_o.clearData__v(STAT_W_o.imgData_o.burst.context_o,STAT_W_o.imgData_o.burst.imgData_o,255),void STAT_W_o.stopSlide__v();case"start":STAT_W_o.slideStack_o.slot_a=Array.from(STAT_W_o.stat_o.burst_o.hue_o.slot_a),STAT_W_o.slideStack_o.slot_a.sort(((_,t)=>null===_?1:null===t?-1:t.rate_n-_.rate_n));let _=STAT_W_o.slideStack_o.slot_a.length;for(;--_&&!STAT_W_o.slideStack_o.slot_a[_];);STAT_W_o.slideStack_o.slot_a.length=_+1,STAT_W_o.slideStack_o.atSlot_n=STAT_W_o.slideStack_o.slot_a.length,STAT_W_o.slideStack_o.opacity_n=s,STAT_W_o.slideStack_o.shift_n=o,STAT_W_o.slideStack_o.gap_n=~~(360/STAT_W_o.slideStack_o.slot_a.length),STAT_W_o.slideStack_o.shiftGap_n=o?(e-a)/STAT_W_o.slideStack_o.slot_a.length:0,STAT_W_o.slideStack_o.stop_b=!1,STAT_W_o.clearData__v(STAT_W_o.imgData_o.burst.context_o,STAT_W_o.imgData_o.burst.imgData_o,s),STAT_W_o.slideStack_o.interval_n=a,STAT_W_o.slideStack_o.slide_n=setInterval(STAT_W_o.slide__v,a);break;case"progress":let t;STAT_W_o.slideStack_o.pause_b?(STAT_W_o.slideStack_o.pause_b=!1,t=STAT_W_o.slideStack_o.interval_n):(STAT_W_o.slideStack_o.pause_b=!0,t=6e5),clearInterval(STAT_W_o.slideStack_o.slide_n),STAT_W_o.slideStack_o.slide_n=setInterval(STAT_W_o.slide__v,t)}},slide__v(){let{slot_a:_,shift_n:t,gap_n:a,stop_b:o}=STAT_W_o.slideStack_o;if(STAT_W_o.slideStack_o.atSlot_n-- >-1){const o=_[STAT_W_o.slideStack_o.atSlot_n];if(o){const _=o.hsl_a[0],t=_+a;STAT_W_o.post__v({task_s:"PUT_hue",stat_s:"burst",hue_a:[_,t]});let e,s,n,r=STAT_W_o.imgData_o.burst.context_o,T=STAT_W_o.imgData_o.burst.imgData_o,c=T.data;for(e=_;e<t;++e)if(s=STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n][e],s)for(n=s.length,atScan_n=0;atScan_n<n;++atScan_n)c[s[atScan_n]+3]=255;r.putImageData(T,0,0)}t&&(clearInterval(STAT_W_o.slideStack_o.slide_n),STAT_W_o.slideStack_o.slide_n=setInterval(STAT_W_o.slide__v,STAT_W_o.slideStack_o.interval_n),STAT_W_o.slideStack_o.interval_n+=STAT_W_o.slideStack_o.shiftGap_n)}else o=!0,STAT_W_o.stopSlide__v()},stopSlide__v(){clearInterval(STAT_W_o.slideStack_o.slide_n),STAT_W_o.slideStack_o.slide_n=0,STAT_W_o.slideStack_o.pause_b=!1,STAT_W_o.slideStack_o.interval_n=0,STAT_W_o.post__v({task_s:"PUT_hue",stat_s:"burst",hue_a:null,stop_b:!0})},message__v(_){const t=_.data;STAT_W_o.script__v(t.script_s);const a=t.task_s;if(STAT_W_o.message_a.includes(a)){const _=a.toLowerCase()+"__v";STAT_W_o[_](t)}},post__v(_){STAT_W_o.port_o.postMessage(_)},handleError__v(_){console.log`ERROR: ${_.message}`}};onconnect=_=>{STAT_W_o.port_o=_.ports[0],STAT_W_o.port_o.onmessage=STAT_W_o.message__v,STAT_W_o.port_o.onmessageerror=STAT_W_o.handleError__v};