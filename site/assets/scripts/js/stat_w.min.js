
const RGB_H__n=(_,a,o)=>{const t=Math.min(_,a,o),T=Math.max(_,a,o);if(T===t)return 0;const s=T-t;return~~(60*(T===_?(a-o)/s+(a<o?6:0):T===a?(o-_)/s+2:(_-a)/s+4))},RGB_S__n=(_,a,o)=>{const t=Math.min(_,a,o),T=Math.max(_,a,o),s=T-t;if(!s)return 0;const n=t+T;return n>255?s/(510-T-t):s/n},RGB_L__n=(_,a,o)=>(Math.min(_,a,o)+Math.max(_,a,o))/510,STAT_W_o={port_o:null,pixel_n:1,status_o:{scan_b:!1},message_o:["GET_scan","GET_status","GET_frequency","GET_img","PUT_canvas","PUT_draw","PUT_scale"],scan_a:null,SCAN_HUE_n:0,SCAN_HUE_FREQ_n:1,SCAN_HUE_RANK_n:2,SCAN_SAT_n:3,SCAN_SAT_FREQ_n:4,SCAN_SAT_RANK_n:5,SCAN_LUM_n:6,SCAN_LUM_FREQ_n:7,SCAN_LUM_RANK_n:8,stat_o:{},script_o:new Set,imgBitmap_a:new Map,script__v(_){if(_){let a=[];for(let o of _.split(" "))STAT_W_o.script_o.has(o)||(STAT_W_o.script_o.add(o),a.push(`${o}.min.js`));a.length&&self.importScripts(...a)}},sleep__v:_=>new Promise((a=>setTimeout(a,_))),async waitScan__v(_){let a=100;for(;!STAT_W_o.status_o.scan_b;){if(!(--a>0))return STAT_W_o.post__v({task_s:"PUT_error",stat_s:_,error_s:"scan is not available"}),!1;await STAT_W_o.sleep__v(50)}return!0},scale__n(_,a,o){const t=.5*STAT_W_o.stat_o[`${_}_o`][`${a}_o`].canvas_o.width*(1-o);STAT_W_o.stat_o[`${_}_o`][`${a}_o`].context_o.setTransform(o,0,0,o,t,t)},async bitmap__o(_){try{let{rect_s:a,scale_n:o,url_s:t,storeBitmap_b:T}=_;if(STAT_W_o.imgBitmap_a.has(t))return STAT_W_o.imgBitmap_a.get(t);let[s,n,e,A]=a.split(" ");const S=await fetch(t),c=await S.blob(),r=await createImageBitmap(c,s-e/o*.5,n-A/o*.5,e/o,A/o,{resizeWidth:e,resizeHeight:A,resizeQuality:"high"});return T&&STAT_W_o.imgBitmap_a.set(t,r),r}catch(_){return console.log(`ERROR DETECTED @bitmap__o(): ${_}`),null}},get_status__v(){STAT_W_o.post__v({task_s:"PUT_status",status_o:STAT_W_o.status_o},[STAT_W_o.status_o])},async get_scan__v(_){if(!STAT_W_o.scan_a){console.time("scan");
//!!!!!!!!!!!!!!!!!!!!!!!!!!
const a=`/assets/media/img/${_.work_s}/full/max/0/color.jpeg`,o=await fetch(a),t=await o.blob(),T=await createImageBitmap(t),s=new OffscreenCanvas(T.width,T.height).getContext("2d");s.drawImage(T,0,0);const n=s.getImageData(0,0,T.width,T.height);STAT_W_o.capacity_n=T.width*T.height,STAT_W_o.scan_a=new Array(1+STAT_W_o.SCAN_LUM_RANK_n);let e,A,S,c=360;for(STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_n]=new Array(c),STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_FREQ_n]=new Array(c);--c>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_n][c]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_FREQ_n][c]=0;for(c=101,STAT_W_o.scan_a[STAT_W_o.SCAN_SAT_n]=new Array(c),STAT_W_o.scan_a[STAT_W_o.SCAN_SAT_FREQ_n]=new Array(c);--c>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_SAT_n][c]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_SAT_FREQ_n][c]=0;for(c=101,STAT_W_o.scan_a[STAT_W_o.SCAN_LUM_n]=new Array(c),STAT_W_o.scan_a[STAT_W_o.SCAN_LUM_FREQ_n]=new Array(c);--c>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_LUM_n][c]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_LUM_FREQ_n][c]=0;for(let _=0;_<n.data.length;_+=4){e=n.data[_],A=n.data[_+1],S=n.data[_+2];let a=RGB_H__n(e,A,S);STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_n][a].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_FREQ_n][a]+=1;let o=~~(100*RGB_S__n(e,A,S));STAT_W_o.scan_a[STAT_W_o.SCAN_SAT_n][o].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_SAT_FREQ_n][o]+=1;let t=~~(100*RGB_L__n(e,A,S));STAT_W_o.scan_a[STAT_W_o.SCAN_LUM_n][t].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_LUM_FREQ_n][t]+=1}const r=_=>{const a=_.length;let o=new Array(a);for(let t=0;t<a;++t)o[t]=[_[t],t];return o.sort(((_,a)=>a[0]-_[0])),o};STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_RANK_n]=r(STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_FREQ_n]),STAT_W_o.scan_a[STAT_W_o.SCAN_SAT_RANK_n]=r(STAT_W_o.scan_a[STAT_W_o.SCAN_SAT_FREQ_n]),STAT_W_o.scan_a[STAT_W_o.SCAN_LUM_RANK_n]=r(STAT_W_o.scan_a[STAT_W_o.SCAN_LUM_FREQ_n]),console.timeEnd("scan")}},get_frequency__v(_){const{part_s:a,frequency_n:o}=_,t=a.toUpperCase();let T=STAT_W_o[`SCAN_${t}_FREQ_n`];STAT_W_o.post__v({task_s:"PUT_frequency",part_s:a,frequency_n:STAT_W_o.scan_a[T][o],capacity_n:STAT_W_o.capacity_n})},async get_img__v(_){try{const a=await STAT_W_o.bitmap__o(_);a&&await _.canvas_e.getContext("2d").drawImage(a,0,0)}catch(_){console.log(`ERROR DETECTED @get_img__v(): ${_}`)}},put_canvas__v(_){const{stat_s:a,part_s:o}=_;STAT_W_o.stat_o[`${a}_o`]||(STAT_W_o.stat_o[`${a}_o`]={}),STAT_W_o.stat_o[`${a}_o`][`${o}_o`]={},STAT_W_o.stat_o[`${a}_o`][`${o}_o`].canvas_o=_.canvas_e;const t=_.canvas_e.getContext("2d");STAT_W_o.pixel_n=_.pixel_n,STAT_W_o.stat_o[`${a}_o`][`${o}_o`].context_o=t},put_draw__v(_){const{stat_s:a,part_s:o}=_;if("burst"===a){if(0===STAT_W_o.scan_a[STAT_W_o.SCAN_HUE_FREQ_n][_.hue_n])return STAT_W_o.stat_o[`${a}_o`].sat_o.burst_c.clear__v(),void STAT_W_o.stat_o[`${a}_o`].lum_o.burst_c.clear__v();let t;switch(o){case"hue":t=360;break;case"sat":case"lum":t=101}const T=o.toUpperCase(),s=`SCAN_${T}_FREQ_n`,n=`SCAN_${T}_RANK_n`,e=[];let A=0;for(let a of STAT_W_o.scan_a[STAT_W_o[s]]){let t,T,s;switch(o){case"hue":t=A,T=100,s=50;break;case"sat":t=_.hue_n,T=A,s=50;break;case"lum":t=_.hue_n,T=0,s=A}e[A]=a?{frequency_n:a,hsl_a:[t,T,s]}:null,++A}const S={color_a:e,range_n:t,canvas_o:STAT_W_o.stat_o[`${a}_o`][`${o}_o`].canvas_o,median_n:.5*STAT_W_o.stat_o[`${a}_o`][`${o}_o`].canvas_o.width,maxfreq_n:STAT_W_o.scan_a[STAT_W_o[n]][0][0]};STAT_W_o.stat_o[`${a}_o`][`${o}_o`].burst_c=new ColorBurst(S)}},put_scale__v(_){const{stat_s:a,part_s:o,scale_n:t}=_;STAT_W_o.stat_o[`${a}_o`][`${o}_o`].burst_c.clear__v(),//!!! before scaling
STAT_W_o.scale__n(a,o,t),STAT_W_o.stat_o[`${a}_o`][`${o}_o`].burst_c.draw__v()},message__v(_){const a=_.data;STAT_W_o.script__v(a.script_s);const o=a.task_s;if(STAT_W_o.message_o.includes(o)){const _=o.toLowerCase()+"__v";STAT_W_o[_](a)}},post__v(_){STAT_W_o.port_o.postMessage(_)},handleError__v(_){console.log`ERROR: ${_.message}`}};onconnect=_=>{STAT_W_o.port_o=_.ports[0],STAT_W_o.port_o.onmessage=STAT_W_o.message__v,STAT_W_o.port_o.onmessageerror=STAT_W_o.handleError__v};