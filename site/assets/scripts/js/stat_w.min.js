
const RGB_H__n=(_,a,t)=>{const o=Math.max(_,a,t),e=Math.min(_,a,t);if(o===e)return 0;const s=o-e;return~~(60*(o===_?(a-t)/s+(a<t?6:0):o===a?(t-_)/s+2:(_-a)/s+4))},RGB_S__n=(_,a,t)=>{const o=Math.max(_,a,t),e=Math.min(_,a,t),s=o-e;if(!s)return 0;const n=e+o;return n>255?s/(510-s):s/n},RGB_L__n=(_,a,t)=>(Math.min(_,a,t)+Math.max(_,a,t))/510,STAT_W_o={port_o:null,pixel_n:1,status_o:{scan_b:!1},message_a:["GET_scan","GET_status","GET_rate","GET_level","GET_img","GET_canvas_img","PUT_canvas","PUT_draw","PUT_slot","PUT_hsl","PUT_scale","PUT_slideshow"],scan_a:null,SCAN_hue_n:0,SCAN_hue_rate_n:1,SCAN_hue_rank_n:2,SCAN_sat_n:3,SCAN_sat_rate_n:4,SCAN_sat_rank_n:5,SCAN_lum_n:6,SCAN_lum_rate_n:7,SCAN_lum_rank_n:8,stat_o:{},script_o:new Set,imgData_o:{},imgLayer_a:[],imgBitmap_a:new Map,slideShow_n:void 0,script__v(_){if(_){let a=[];for(let t of _.split(" "))STAT_W_o.script_o.has(t)||(STAT_W_o.script_o.add(t),a.push(`${t}.min.js`));a.length&&self.importScripts(...a)}},async bitmap__o(_){try{let{stat_s:a,rect_s:t,scale_n:o,url_s:e,storeBitmap_b:s}=_;if(STAT_W_o.imgBitmap_a.has(e))return STAT_W_o.imgBitmap_a.get(e);let[n,T,c,l]=t.split(" ");const r=await fetch(e),S=await r.blob(),A=await createImageBitmap(S,n-c/o*.5,T-l/o*.5,c/o,l/o,{resizeWidth:c,resizeHeight:l,resizeQuality:"high"});return s&&STAT_W_o.imgBitmap_a.set(e,A),A}catch(_){return console.log(`ERROR DETECTED @bitmap__o(): ${_}`),null}},clearData__v(_,a,t){const o=a.data;for(let _=0;_<o.length;_+=4)o[_+3]=t;_.putImageData(a,0,0)},scale__n(_,a,t){const{width:o,height:e}=STAT_W_o.stat_o[`${_}_o`][`${a}_o`].canvas_o;STAT_W_o.stat_o[`${_}_o`][`${a}_o`].context_o.clearRect(0,0,o,e);const s=.5*o*(1-t);STAT_W_o.stat_o[`${_}_o`][`${a}_o`].context_o.setTransform(t,0,0,t,s,s)},slot__a(_,a){let t;if(360!==a&&101!==a){let o=360/a,e=_*o;t=[e,e+o-1]}else t=[_];return t},stopSlideshow__v(){clearInterval(STAT_W_o.slideShow_n),STAT_W_o.slideShow_n=void 0},get_status__v(){STAT_W_o.post__v({task_s:"PUT_status",status_o:STAT_W_o.status_o},[STAT_W_o.status_o])},async get_scan__v(_){if(!STAT_W_o.scan_a){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
const a=`/assets/media/img/${_.work_s}/full/max/0/color.jpeg`,t=await fetch(a),o=await t.blob(),e=await createImageBitmap(o),s=new OffscreenCanvas(e.width,e.height).getContext("2d");s.drawImage(e,0,0);const n=s.getImageData(0,0,e.width,e.height);STAT_W_o.capacity_n=e.width*e.height,STAT_W_o.scan_a=new Array(1+STAT_W_o.SCAN_lum_rank_n);let T,c,l,r=360;for(STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n]=new Array(r),STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n]=new Array(r);--r>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n][r]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n][r]=0;for(r=101,STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n]=new Array(r),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n]=new Array(r);--r>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n][r]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n][r]=0;for(r=101,STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n]=new Array(r),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n]=new Array(r);--r>=0;)STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n][r]=[],STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n][r]=0;for(let _=0;_<n.data.length;_+=4){T=n.data[_],c=n.data[_+1],l=n.data[_+2];let a=RGB_H__n(T,c,l);STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n][a].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n][a]+=1;let t=~~(100*RGB_S__n(T,c,l));STAT_W_o.scan_a[STAT_W_o.SCAN_sat_n][t].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n][t]+=1;let o=~~(100*RGB_L__n(T,c,l));STAT_W_o.scan_a[STAT_W_o.SCAN_lum_n][o].push(_),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n][o]+=1}const S=_=>{const a=_.length;let t=new Array(a);for(let o=0;o<a;++o)t[o]=[_[o],o];return t.sort(((_,a)=>a[0]-_[0])),t};STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_hue_rate_n]),STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_sat_rate_n]),STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rank_n]=S(STAT_W_o.scan_a[STAT_W_o.SCAN_lum_rate_n])}},get_rate__v(_){const{hsl_s:a,angle_n:t,slot_n:o}=_,e=STAT_W_o.slot__a(t,o),s=STAT_W_o.stat_o.burst_o[`${a}_o`].slot_a[t],n=s?s.rate_n:0;STAT_W_o.post__v({task_s:"PUT_rate",hsl_s:a,rate_n:n,slot_a:e,capacity_n:STAT_W_o.capacity_n,level_a:STAT_W_o.stat_o.burst_o[`${a}_o`].burst_c.level__a(t)},[STAT_W_o.stat_o.burst_o[`${a}_o`].burst_c.level__a(t)])},get_level__v(_){const{stat_s:a,hsl_s:t}=_;STAT_W_o.post__v({task_s:"PUT_level",stat_s:"burst",hsl_s:t,level_a:STAT_W_o.stat_o[`${a}_o`][`${t}_o`].burst_c.level__a()},[STAT_W_o.stat_o[`${a}_o`][`${t}_o`].burst_c.level__a()])},async get_img__v(_){try{const a=await STAT_W_o.bitmap__o(_);if(a){const t=_.canvas_e,o=t.getContext("2d");o.drawImage(a,0,0);const e=o.getImageData(0,0,t.width,t.height),s=_.stat_s;if("burst"===s)return void(STAT_W_o.imgData_o[s]={canvas_e:t,context_o:o,imgData_o:e});if(_.storeBitmap_b){const a={canvas_e:_.canvas_e,context_o:o,imgData_o:e};_.layer_n&&(a.layer_n=_.layer_n),STAT_W_o.imgLayer_a.push(a)}}}catch(_){console.log(`ERROR DETECTED @get_img__v(): ${_}`)}},async get_canvas_img__v(_){const{stat_s:a}=_,t=STAT_W_o.imgData_o[a].canvas_e;let o=await t.convertToBlob({type:"image/jpeg",quality:.95});STAT_W_o.post__v({task_s:"PUT_canvas_img",blob_o:o},[o])},put_canvas__v(_){STAT_W_o.pixel_n=_.pixel_n;const{stat_s:a,hsl_s:t}=_;STAT_W_o.stat_o[`${a}_o`]||(STAT_W_o.stat_o[`${a}_o`]={}),STAT_W_o.stat_o[`${a}_o`][`${t}_o`]={},STAT_W_o.stat_o[`${a}_o`][`${t}_o`].canvas_o=_.canvas_e;const o=_.canvas_e.getContext("2d");STAT_W_o.pixel_n=_.pixel_n,STAT_W_o.stat_o[`${a}_o`][`${t}_o`].context_o=o,STAT_W_o.stat_o[`${a}_o`][`${t}_o`].painter_c=new Painter(o)},put_draw__v(_){let a,{stat_s:t,hsl_s:o,back_hue_n:e,rangeY_n:s,shift_n:n,thresh_o:T}=_,[c,l]=o.split("_");switch(t){case"burst":const l=s;let r=0;if("hue"===c)r=360;else r=101;switch(a=STAT_W_o.stat_o[`${t}_o`][`${o}_o`].painter_c,o){case"hue_back":for(let _=0;_<360;++_){let t=_+n%360;a.fill__c([t,100,50]).rect__c(0,2*_,a.context_o.canvas.width,2,"fill")}break;case"hue_front":for(let _=0;_<360;++_){let t=(Math.floor(_/l)*l+n)%360;a.fill__c([t,100,50]).rect__c(0,2*_,a.context_o.canvas.width,2,"fill")}}STAT_W_o.stat_o[`${t}_o`][`${c}_o`].slot_a=[];const S=STAT_W_o.scan_a[STAT_W_o[`SCAN_${c}_rate_n`]].slice(0,n),A=STAT_W_o.scan_a[STAT_W_o[`SCAN_${c}_rate_n`]].slice(n).concat(S);let i=0,W=0,h=0,u=-1,g=-1;for(let _ of A){let a,s,T;switch(++u,++g,W=u,o){case"hue":a=(u+n)%360,s=100,T=50;break;case"sat":a=e,s=u,T=50;break;case"lum":a=e,s=0,T=u;break;case"hue_front":if(l>1&&g<l-1&&(i+=_,u<360))continue;i>h&&(h=i),i&&(_=i),a=(Math.floor(W/l)*l+n)%360,s=100,T=50,i=0,g=-1}STAT_W_o.stat_o[`${t}_o`][`${c}_o`].slot_a.push(_?{rate_n:_,hsl_a:[a,s,T]}:null)}if("hue_back"===o)return;const m=STAT_W_o.stat_o[`${t}_o`][`${c}_o`].canvas_o.width,p={rate_a:STAT_W_o.stat_o[`${t}_o`][`${c}_o`].slot_a,capacity_n:"hue_front"===o?STAT_W_o.stat_o[`${t}_o`][`${c}_o`].slot_a.length:r,canvas_o:STAT_W_o.stat_o[`${t}_o`][`${c}_o`].canvas_o,center_n:.5*m,maxRate_n:h||STAT_W_o.scan_a[STAT_W_o[`SCAN_${c}_rank_n`]][0][0],maxpos_n:m,thresh_o:T};STAT_W_o.stat_o[`${t}_o`][`${c}_o`].burst_c=new ColorBurst(p);break;case"paint":switch(a=STAT_W_o.stat_o[`${t}_o`][`${o}_o`].painter_c,c){case"hue":for(let _=0;_<360;++_)a.fill__c([_,100,50]).rect__c(0,2*_,100,2,"fill");break;case"sat":for(let t=0;t<101;++t)a.fill__c([_.hue_n,t,50]).rect__c(0,2*t,100,2,"fill");break;case"lum":for(let _=0;_<101;++_)a.fill__c([0,0,_]).rect__c(0,2*_,100,2,"fill")}}},put_hsl__v(_){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
let{stat_s:a,hsl_s:t,operand_a:o,operation_s:e,deviation_n:s,rangeX_n:n,atX_n:T,rangeY_n:c,atY_n:l}=_;const r=T/n;let S=~~r;r>1&&++S,S*=n,S>100&&(S=100);let A=~~(2.559*S),i=.01*S+.001;l*=2,c*=2,STAT_W_o.stat_o[`${a}_o`][`${t}_front_o`].painter_c.fill__c([190,28,17,1]).rect__c(S,l,100-S,c,"fill").rect__c(0,l,S,c,"clear").fill__c([0,0,100,1-i]).rect__c(0,l,S,c,"fill");const W=_.atY_n;let h=W+_.rangeY_n;const u="hue"===t?359:100;h>u&&(h=u);const g=STAT_W_o.scan_a[STAT_W_o[`SCAN_${t}_n`]],m=[];for(let _ of o)m.push({layer_o:STAT_W_o.imgLayer_a.find((a=>a.layer_n===+_.layer_n)),clipRect_a:_.clipRect_a});let p,f;e&&"none"!==e&&(p=m[0].layer_o.imgData_o,f=m?.[1]?.layer_o?.imgData_o,m.splice(0,2));for(let _ of m){const a=_.layer_o.context_o,t=_.layer_o.imgData_o,o=t.data;let n,T,c;for(n=W;n<h;++n){let _,a,t;T=g[n],c=T.length;let l=!0;for(atScan_n=0;atScan_n<c;++atScan_n){if(p&&f)switch(_=p[T[atScan_n]+3],a=f[T[atScan_n]+3],t=~~(_-a),e){case"union":l=_&&a;break;case"difference":l=t>s;break;case"intersection":l=t<=s;break;case"complement":l=_&&!a}l&&(o[T[atScan_n]+3]=A)}}const l=_.clipRect_a.length?_.clipRect_a:[[0,0,_.layer_o.canvas_e.width,_.layer_o.canvas_e.height]];for(let _ of l)a.putImageData(t,0,0,..._)}
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
},put_slot__v(_){
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
const{stat_s:a,hsl_s:t,angle_n:o,range_n:e,opacity_n:s,dim_a:n}=_,T=360/e,c=T*o,l=c+T,r=STAT_W_o.scan_a[STAT_W_o[`SCAN_${t}_n`]],{context_o:S,imgData_o:A}=STAT_W_o.imgData_o[`${a}`],i=A.data;let W,h,u,g;for(W=0;W<360;++W)for(g=W>=c&&W<l?255:s,h=r[W],u=h.length,atScan_n=0;atScan_n<u;++atScan_n)i[h[atScan_n]+3]=g;S.putImageData(A,0,0);
//!!!!!!!!!!!!!!!!!!!!!!!!!!
//!!!!!!!!!!!!!!!!!!!!!!!!!!
},put_scale__v(_){const{stat_s:a,hsl_s:t,scale_n:o,burst_b:e}=_;STAT_W_o.scale__n(a,t,o),e&&STAT_W_o.stat_o[`${a}_o`][`${t}_o`].burst_c.draw__v()},put_slideshow__v(_){let//!!! mutable speed_n
{stat_s:a,speed_n:t,opacity_n:o}=_;if(!t&&STAT_W_o.slideShow_n)return void STAT_W_o.stopSlideshow__v();const e=Array.from(STAT_W_o.stat_o.burst_o.hue_o.slot_a);e.sort(((_,a)=>null===_?1:null===a?-1:a.rate_n-_.rate_n));const s=STAT_W_o.scan_a[STAT_W_o.SCAN_hue_n],{context_o:n,imgData_o:T}=STAT_W_o.imgData_o[`${a}`],c=T.data;STAT_W_o.clearData__v(n,T,o);const l=360/e.length;let r=e.length;STAT_W_o.slideShow_n=setInterval((()=>{if(!(r-- >-1))return STAT_W_o.post__v({task_s:"PUT_hue",stat_s:"burst",hue_a:null}),void STAT_W_o.stopSlideshow__v();{const _=e[r];if(_){const a=_.hsl_a[0],t=a+l;let o,e,r;for(STAT_W_o.post__v({task_s:"PUT_hue",stat_s:"burst",hue_a:[a,t]}),o=a;o<t;++o)if(e=s[o],e)for(r=e.length,atScan_n=0;atScan_n<r;++atScan_n)c[e[atScan_n]+3]=255;n.putImageData(T,0,0)}}}),t)},message__v(_){const a=_.data;STAT_W_o.script__v(a.script_s);const t=a.task_s;if(STAT_W_o.message_a.includes(t)){const _=t.toLowerCase()+"__v";STAT_W_o[_](a)}},post__v(_){STAT_W_o.port_o.postMessage(_)},handleError__v(_){console.log`ERROR: ${_.message}`}};onconnect=_=>{STAT_W_o.port_o=_.ports[0],STAT_W_o.port_o.onmessage=STAT_W_o.message__v,STAT_W_o.port_o.onmessageerror=STAT_W_o.handleError__v};