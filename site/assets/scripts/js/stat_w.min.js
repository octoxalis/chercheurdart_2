
const RGB_H__n=(_,a,s)=>{const o=Math.min(_,a,s),t=Math.max(_,a,s);if(t===o)return 0;const n=t-o;return~~(60*(t===_?(a-s)/n+(a<s?6:0):t===a?(s-_)/n+2:(_-a)/n+4))},RGB_S__n=(_,a,s)=>{const o=Math.min(_,a,s),t=Math.max(_,a,s),n=t-o;if(!n)return 0;const e=o+t;return e>255?n/(510-t-o):n/e},RGB_L__n=(_,a,s)=>(Math.min(_,a,s)+Math.max(_,a,s))/510,STAT_W_o={port_o:null,status_o:{scan_b:!1},message_o:["GET_scan","GET_status","PUT_canvas"],scan_a:null,client_o:{},script_o:new Set,script__v(_){if(_){let a=[];for(let s of _.split(" "))STAT_W_o.script_o.has(s)||(STAT_W_o.script_o.add(s),a.push(`${s}.min.js`));a.length&&self.importScripts(...a)}},sleep__v:_=>new Promise((a=>setTimeout(a,_))),async waitScan__v(_){let a=100;for(;!STAT_W_o.status_o.scan_b;){if(!(--a>0))return STAT_W_o.post__v({client_s:_,task_s:"PUT_error",error_s:"scan is not available"}),!1;await STAT_W_o.sleep__v(50)}return!0},async get_scan__v(_){if(!STAT_W_o.scan_a){console.time("scan");
//!!!!!!!!!!!!!!!!!!!!!!!!!!
const a=`/assets/media/img/${_.work_s}/full/max/0/color.jpeg`,s=await fetch(a),o=await s.blob(),t=await createImageBitmap(o),n=new OffscreenCanvas(t.width,t.height).getContext("2d");n.drawImage(t,0,0);const e=n.getImageData(0,0,t.width,t.height);STAT_W_o.scan_a=[];let T,c,r,A=360;for(STAT_W_o.scan_a[0]=new Array(A),STAT_W_o.scan_a[1]=new Array(A);--A>=0;)STAT_W_o.scan_a[0][A]=[],STAT_W_o.scan_a[1][A]=0;for(A=101,STAT_W_o.scan_a[2]=new Array(A),STAT_W_o.scan_a[3]=new Array(A);--A>=0;)STAT_W_o.scan_a[2][A]=[],STAT_W_o.scan_a[3][A]=0;for(A=101,STAT_W_o.scan_a[4]=new Array(A),STAT_W_o.scan_a[5]=new Array(A);--A>=0;)STAT_W_o.scan_a[4][A]=[],STAT_W_o.scan_a[5][A]=0;for(let _=0;_<e.data.length;_+=4){T=e.data[_],c=e.data[_+1],r=e.data[_+2];let a=RGB_H__n(T,c,r);STAT_W_o.scan_a[0][a].push(_),STAT_W_o.scan_a[1][a]+=1;let s=~~(100*RGB_S__n(T,c,r));STAT_W_o.scan_a[2][s].push(_),STAT_W_o.scan_a[3][s]+=1;let o=~~(100*RGB_L__n(T,c,r));STAT_W_o.scan_a[4][o].push(_),STAT_W_o.scan_a[5][o]+=1}
//!!!!!!!!!!!!!!!!!!!!!!!!!!
console.timeEnd("scan");
//!!!!!!!!!!!!!!!!!!!!!!!!!!
}},get_status__v(){STAT_W_o.post__v({task_s:"PUT_status",status_o:STAT_W_o.status_o},[STAT_W_o.status_o])},put_canvas__v(_){const{client_s:a,id_s:s}=_;STAT_W_o.client_o[a]||(STAT_W_o.client_o[a]={}),STAT_W_o.client_o[a][s]={},STAT_W_o.client_o[a][s].canvas_o=_.canvas_e;const o=_.canvas_e.getContext("2d"),t=_.pixel_n;o.scale(t,t),STAT_W_o.client_o[a][s].context_o=o},message__v(_){const a=_.data;STAT_W_o.script__v(a.script_s);const s=a.task_s;if(STAT_W_o.message_o.includes(s)){const _=s.toLowerCase()+"__v";STAT_W_o[_](a)}},post__v(_){STAT_W_o.port_o.postMessage(_)},handleError__v:_=>console.log`ERROR: ${_.message}`};onconnect=_=>{STAT_W_o.port_o=_.ports[0],STAT_W_o.port_o.onmessage=STAT_W_o.message__v,STAT_W_o.port_o.onmessageerror=STAT_W_o.handleError__v};